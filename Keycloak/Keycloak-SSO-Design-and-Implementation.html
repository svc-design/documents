<h1 id="介绍">1. 介绍</h1>
<h2 id="概述">概述</h2>
<p>Keycloak
是一种用于现代应用程序和服务的开源身份和访问管理解决方案。开发人员通常要求编写的安全功能是开箱即用的，并且可以轻松根据组织的需求进行定制。Keycloak
提供了可定制的用户界面，用于登录、注册、帐户管理，支持单点登录（SSO）、用户注册和身份联合等用例。</p>
<p>Keycloak 还可以作为一个集成平台，将其连接到现有的 LDAP 和 Active
Directory 服务器，并且可以将身份验证委托给第三方身份提供商，如 GitHub 和
Google。</p>
<p>Keycloak 的主要特点包括：</p>
<ol type="1">
<li><strong>单点登录</strong>：支持 OpenID Connect、OAuth 2.0 和 SAML
2.0 等标准协议。</li>
<li><strong>身份和访问管理</strong>：提供用户联合、强认证、用户管理和细粒度授权。可以将身份验证集成到应用程序和服务中，而无需处理用户存储或验证。</li>
</ol>
<h2 id="术语">术语</h2>
<p>下表列出了与此解决方案相关的关键术语：</p>
<table>
<colgroup>
<col style="width: 5%" />
<col style="width: 28%" />
<col style="width: 65%" />
</colgroup>
<thead>
<tr>
<th>术语</th>
<th>全名</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>SSO</strong></td>
<td>单点登录（Single-Sign On）</td>
<td>单点登录（SSO）是一种身份验证方案，允许用户使用单一的凭证登录多个相关但独立的软件系统。</td>
</tr>
<tr>
<td><strong>SAML</strong></td>
<td>安全断言标记语言（Security Assertion Markup Language）</td>
<td>SAML
是一种开放标准，用于在各方之间交换身份验证和授权数据，特别是在身份提供者和服务提供者之间。它是一种基于
XML 的语言，用于进行安全断言。</td>
</tr>
<tr>
<td><strong>OpenID</strong></td>
<td>OpenID</td>
<td>OpenID 是由 OpenID
基金会推动的开放标准和去中心化的身份验证协议。有关详细信息，请参见
OpenID Connect。</td>
</tr>
</tbody>
</table>
<p>在使用 Keycloak 来保护 Web 应用程序和
服务之前，了解以下核心概念和术语非常重要：</p>
<table>
<colgroup>
<col style="width: 7%" />
<col style="width: 92%" />
</colgroup>
<thead>
<tr>
<th>术语</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Realms</strong></td>
<td>Realms 是身份验证和授权的子域，用于管理和验证用户身份。每个 realm
都有自己的身份验证和授权配置。</td>
</tr>
<tr>
<td><strong>Clients</strong></td>
<td>Clients 是使用 Keycloak 作为 API 客户端的程序或服务。Keycloak
提供了多个 API（例如 HTTP API、JSON API 和 WebSocket
API）供客户端使用，客户端可以通过这些 API 访问 Keycloak
后端服务，获取访问令牌或其他授权资源。</td>
</tr>
<tr>
<td><strong>Groups</strong></td>
<td>Groups 是一组具有相同权限的用户或客户端。用户可以加入多个
group，每个 group 都具有特定的权限范围。group
可以是基于用户的，也可以是基于客户端的。例如，可以创建一个名为“admin”的
group，将所有管理员添加到该 group
中，以便他们可以访问系统中的所有权限。</td>
</tr>
<tr>
<td><strong>Users</strong></td>
<td>Users 是使用 Keycloak 的用户。Keycloak
提供多种验证用户身份的方式，例如密码、社会安全号码、护照等。用户可以在
Keycloak 中创建、修改或删除，并且可以通过 API 进行身份验证和授权。</td>
</tr>
<tr>
<td><strong>Client Scopes</strong></td>
<td>Client Scopes 是授予客户端访问 Keycloak 后端服务的权限。Client scope
定义了一组权限，可以授予客户端，使其可以访问 Keycloak
后端服务。例如，可以创建一个名为“read”的 client
scope，并将其授予可以读取特定资源的客户端。这样可以确保只有具有足够权限的客户端可以访问系统中的资源。</td>
</tr>
</tbody>
</table>
<h1 id="安装与部署">2. 安装与部署</h1>
<h2 id="准备工作">准备工作</h2>
<p>在开始部署 Keycloak 之前，请确保已完成以下准备工作：</p>
<ol type="1">
<li>拥有一个已经备案的域名。</li>
<li>获得对应域名的服务器管理权限，能够更新 DNS 解析记录。</li>
<li>在 AWS 控制台申请一台 t3a.medium 类型的 云主机（Linux 系统）。</li>
<li>申请并配置对应域名的 SSL 证书，并将证书放置在 EC2 主机的
<code>/etc/ssl/</code> 目录下。</li>
</ol>
<h2 id="部署步骤">部署步骤</h2>
<p>以 POC 环境为例，下面的步骤将指导您如何使用 EC2 初始化 K3S 集群，并在
K3S 集群中部署 Keycloak。</p>
<h3 id="初始化-k3s-集群">1. 初始化 K3S 集群</h3>
<p>登录到 EC2 主机并下载以下部署脚本：</p>
<p>```bash wget
https://github.com/svc-design/Modern-Container-Application-Reference-Architecture/blob/main/playbook/roles/k3s/files/setup-k3s-with-hostpath-sc.sh
wget
https://github.com/svc-design/Modern-Container-Application-Reference-Architecture/blob/main/playbook/roles/k3s/files/setup-ingress.sh
wget
https://github.com/svc-design/Modern-Container-Application-Reference-Architecture/blob/main/playbook/roles/keycloak/files/setup-keycloak.sh
按照以下顺序执行脚本：</p>
<p>bash 复制代码 bash setup-k3s-with-hostpath-sc.sh # 初始化 K3S 集群
bash setup-ingress.sh <ec2_public_ip> # 配置 K3S ingress 2. 创建
Keycloak Namespace 和 Secret 在 K3S 集群中创建 keycloak 命名空间，并生成
Secret：</p>
<p>bash 复制代码 kubectl create namespace keycloak # 创建 namespace
kubectl create secret tls keycloak-tls –key=/etc/ssl/domain.key
–cert=/etc/ssl/domain.cert -n keycloak # 创建 secret 3. 部署 Keycloak
执行以下命令来部署 Keycloak：</p>
<p>bash 复制代码 bash setup-keycloak.sh <domain> <secret_name>
<namespace> <keycloak_ui_password> <keycloak_db_password> # 部署
Keycloak</p>
<p>其中，</p>
<ul>
<li><domain> 是您的域名</li>
<li><secret_name> 是创建的 TLS Secret 名称</li>
<li><namespace> 是 K8S 命名空间</li>
<li><keycloak_ui_password> 是 Keycloak 管理员控制台的密码</li>
<li><keycloak_db_password> 是 Keycloak 数据库的密码。</li>
</ul>
<ol start="4" type="1">
<li>配置 DNS 解析 部署完成后，获取域名和 IP 地址，并在 DNS
服务中添加解析记录。使用以下命令查看 Keycloak 的 ingress 记录：</li>
</ol>
<p>bash 复制代码 kubectl get ingress -A | grep keycloak | awk ‘{print $4
“ $5}’ 这将返回类似以下格式的结果：</p>
<p>复制代码 keycloak.onwalk.net x.x.x.x 将上述域名和 IP 地址添加到您的
DNS 解析记录中，等待 DNS 解析生效。</p>
<ol start="5" type="1">
<li>访问 Keycloak 管理控制台 DNS 解析生效后，您可以在浏览器中访问
Keycloak 管理控制台，URL 示例： https://keycloak.onwalk.net
使用管理员用户名 user 和之前设置的 <keycloak_ui_password>
密码登录，将会看到 Keycloak 管理控制台的页面。</li>
</ol>
<h1 id="配置">3. 配置</h1>
<h2 id="keycloak-默认语言设置">3.1 Keycloak 默认语言设置</h2>
<p>登录到 Keycloak，点击左侧菜单栏中的 <strong>Realm
Settings</strong>。</p>
<ol type="1">
<li>点击 <strong>Themes</strong>，将所有属性设置为
<code>keycloak</code>。</li>
<li>在 <strong>Internationalization Enabled</strong> 选项中选择
<strong>ON</strong>。</li>
<li>将 <strong>Default Locale</strong> 设置为 <code>zh-CN</code>。</li>
</ol>
<p>重新登录时，在登录页面会显示语言切换项。</p>
<h2 id="keycloak-安全设置">3.2 Keycloak 安全设置</h2>
<p>选择需要配置的 Realm，点击左侧菜单中的
<strong>Authentication</strong> -&gt; <strong>Required
Actions</strong>，建议开启以下配置项：</p>
<ul>
<li><strong>configure-opt</strong>: 开启</li>
<li><strong>update-password</strong>: 开启</li>
</ul>
<h2 id="keycloak-新建-realm">3.3 Keycloak 新建 Realm</h2>
<p>出于安全的需要，生产环境不建议直接使用默认的
<strong>Master</strong>，可以按照角色或不同用途建立不同的 Realm。</p>
<h2 id="keycloak-新建-client">3.4 Keycloak 新建 Client</h2>
<p>以新建 Gitlab OIDC 客户端为例，参考操作如下：</p>
<ol type="1">
<li><p><strong>Keycloak 侧配置</strong>：选择一个 Realm，左侧侧边栏点击
<strong>Clients</strong>，右侧点击 <strong>Create</strong> 客户端。</p>
<ul>
<li><strong>客户端类型</strong>: OpenID Connect (关键配置项)</li>
<li><strong>客户端 ID</strong>: <code>gitlab-oidc</code>
(关键配置项)</li>
<li><strong>客户端 Name</strong>: <code>gitlab-oidc</code></li>
</ul></li>
<li><p>选择下一步，<strong>客户端验证</strong>：开启（关键配置项）。</p>
<p>选择下一步：</p>
<ul>
<li><strong>Home URL</strong>: 添加
<code>https://&lt;gitlab-domain&gt;</code>（关键配置项）</li>
<li><strong>有效的重定向 URI</strong>: 添加
<code>https://&lt;gitlab-domain&gt;/users/auth/openid_connect/callback</code>（关键配置项）</li>
</ul></li>
<li><p>保存并记录 <code>gitlab-oidc</code> 客户端密钥。</p></li>
</ol>
<h2 id="keycloak-新建-user">3.5 Keycloak 新建 User</h2>
<p>在创建好的 Realm 中，创建属于这个 Realm 下的用户，Realm
之间具备逻辑隔离属性。</p>
<h1 id="sso-集成简介">04. SSO 集成简介</h1>
<p>单点登录（SSO）是一种认证方法，允许用户通过一次登录便可访问多个应用程序。在现代身份认证系统中，SAML
和 OIDC
是最常见的协议，它们分别适用于不同的场景。以下是这两种协议的概述。</p>
<h2 id="samlsecurity-assertion-markup-language">SAML（Security Assertion
Markup Language）</h2>
<p>SAML 是一种基于 XML
的认证协议，主要用于企业级单点登录（SSO）解决方案。它允许用户在身份提供者（IdP）和服务提供者（SP）之间进行身份验证和授权交换。</p>
<h3 id="适用场景">适用场景：</h3>
<ul>
<li><strong>传统应用</strong>：SAML
协议广泛应用于传统企业应用，尤其是在与遗留系统集成时。</li>
<li><strong>云服务</strong>：许多大型云服务平台（如 AWS、GCP）都支持
SAML，用于企业级身份验证。</li>
<li><strong>跨域认证</strong>：SAML
支持跨多个域进行身份验证，是在多种服务之间共享认证的理想选择。</li>
</ul>
<p>SAML
的一个优势是它提供了强大的安全性，适用于需要处理复杂权限和安全策略的环境。然而，它的实现较为复杂，通常需要较长的配置和调试时间。</p>
<h2 id="oidcopenid-connect">OIDC（OpenID Connect）</h2>
<p>OIDC 是基于 OAuth 2.0 协议的身份认证协议，旨在简化现代 Web
应用程序和移动应用的身份认证过程。它允许客户端应用程序验证用户的身份，并获取有关用户的基本信息。</p>
<h3 id="适用场景-1">适用场景：</h3>
<ul>
<li><strong>SAML</strong>：适合传统企业应用、遗留系统和需要强认证的云服务。其复杂的配置和较重的协议更适用于大规模、企业级环境。常见的应用场景包括：
<ul>
<li><strong>云服务</strong>：AWS、GCP、Azure 等云平台支持 SAML
用于企业级身份验证。</li>
<li><strong>ERP 系统</strong>：如 SAP、Oracle ERP 系统常用 SAML 实现
SSO。</li>
<li><strong>企业内部应用</strong>：如企业自建的内部管理系统，或者与
Active Directory 集成的应用。</li>
</ul></li>
<li><strong>OIDC</strong>：适用于 Web
应用、移动应用和现代应用，尤其在微服务架构和 OAuth 2.0
配合使用时表现出色。典型应用包括：
<ul>
<li><strong>企业应用</strong>：GitLab（企业版）、Harbor（私有镜像仓库）、Vault（用于密钥管理）等支持
OIDC 作为身份认证和授权的方式。</li>
<li><strong>监控和数据可视化</strong>：Grafana，利用 OIDC
作为身份认证机制来简化用户管理。</li>
<li><strong>现代 Web
和移动应用</strong>：如跨平台应用、单页面应用（SPA）等，OIDC
提供了便捷的用户身份验证机制。</li>
</ul></li>
<li><strong>Web 和移动应用</strong>：OIDC 特别适用于 Web
和移动应用，尤其是需要轻量级、灵活的身份验证解决方案时。</li>
<li><strong>现代应用程序</strong>：OIDC 简单易用，非常适合现代的 RESTful
API 和微服务架构。</li>
<li><strong>与 OAuth 集成</strong>：OIDC 可以与 OAuth 2.0
配合使用，在授权过程中不仅验证用户身份，还能授权访问特定资源。</li>
</ul>
<p>OIDC
的优势在于其简洁的实现和更高的扩展性，尤其适用于云原生应用和微服务架构。它与
SAML 相比，通常配置更加简单，适合快速集成和扩展。</p>
<p>根据具体应用场景选择合适的协议，可以更好地满足企业的身份认证需求和用户体验。</p>
<h1 id="aws-sso-配置">4.1 AWS SSO 配置</h1>
<h2 id="配置项目汇总">配置项目汇总</h2>
<table>
<colgroup>
<col style="width: 3%" />
<col style="width: 8%" />
<col style="width: 51%" />
<col style="width: 36%" />
</colgroup>
<thead>
<tr>
<th>步骤</th>
<th>配置项目</th>
<th>Keycloak 控制台操作</th>
<th>AWS 控制台操作</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>创建 Realm</td>
<td>创建 Realm，命名为 <code>cloud-sso</code>。</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>设置登录名为邮件</td>
<td>启用 <code>Email as username</code> 设置。</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>导出 SAML Metadata</td>
<td>导出 SAML 2.0 的 Metadata
文件（<code>keycloak-saml-metadata.xml</code>）。</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>添加身份提供商</td>
<td></td>
<td>在 <code>IAM</code> 中添加 SAML 2.0 身份提供商，导入 Keycloak SAML
Metadata。</td>
</tr>
<tr>
<td>5</td>
<td>创建客户端</td>
<td>导入 AWS SAML Metadata，设置 <code>IDP-Initiated SSO URL name</code>
和 <code>Home URL</code>。</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>创建 Realm 角色</td>
<td>创建 Realm 角色，格式为
<code>&lt;sso-iam-role-arn&gt;,&lt;identity-providers-arn&gt;</code>。</td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>更新客户端配置</td>
<td>配置 <code>clientScopes</code>，设置 <code>Full scope allowed</code>
为 <code>Off</code>，并添加 <code>assign role</code> 操作。</td>
<td></td>
</tr>
<tr>
<td>8</td>
<td>配置 Session Role</td>
<td>在 <code>Mappers</code> 中配置 <code>Role list</code> 映射器，设置
<code>Role attribute name</code> 为
<code>https://aws.amazon.com/SAML/Attributes/Role</code>。</td>
<td></td>
</tr>
<tr>
<td>9</td>
<td>配置 Session Name</td>
<td>在 <code>Mappers</code> 中配置 <code>User Property</code>
映射器，设置 <code>Role Attribute Name</code> 为
<code>https://aws.amazon.com/SAML/Attributes/RoleSessionName</code>。</td>
<td></td>
</tr>
<tr>
<td>10</td>
<td>创建用户</td>
<td>在 Keycloak 中创建新用户，分配角色。</td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>添加角色绑定</td>
<td></td>
<td>为身份提供商绑定角色并创建 IAM 角色。</td>
</tr>
<tr>
<td>12</td>
<td>配置角色权限</td>
<td></td>
<td>为 IAM 角色分配权限策略（如
<code>AdministratorAccess</code>）。</td>
</tr>
<tr>
<td>13</td>
<td>记录 ARN</td>
<td></td>
<td>记录 IAM 角色和身份提供商的 ARN。</td>
</tr>
<tr>
<td>14</td>
<td>导入 SAML Metadata</td>
<td></td>
<td>下载 AWS SAML Metadata 文件（AWS 中国和国际版）。</td>
</tr>
<tr>
<td>15</td>
<td>配置 Home URL 和 IDP-Initiated URL</td>
<td>设置 <code>Home URL</code> 和
<code>IDP-Initiated SSO URL</code>。</td>
<td></td>
</tr>
<tr>
<td>16</td>
<td>完成角色绑定</td>
<td></td>
<td>完成角色和权限的绑定，确保角色策略已正确分配给 SSO 用户。</td>
</tr>
</tbody>
</table>
<h2 id="keycloak-控制台操作创建-realm">4.1.1 Keycloak 控制台操作，创建
Realm</h2>
<ol type="1">
<li>登录到 Keycloak 管理控制台，创建一个新的 Realm，命名为
<code>cloud-sso</code>。</li>
<li>配置 Realm 域内的用户使用邮件作为默认登录名：
<ul>
<li>在 <code>cloud-sso</code> 的左侧设置栏中，选择 <code>Login</code>
选项卡，确保启用以下设置：
<ul>
<li><code>Email as username</code>：开启。</li>
</ul></li>
</ul></li>
</ol>
<h2 id="keycloak-控制台操作导出-identity-provider-metadata">4.1.2
Keycloak 控制台操作，导出 Identity Provider Metadata</h2>
<ol type="1">
<li>导出 Keycloak 的 SAML 2.0 Identity Provider Metadata 文件，并保存为
<code>keycloak-saml-metadata.xml</code>。</li>
</ol>
<h2 id="aws-控制台操作添加身份提供商">4.1.3 AWS
控制台操作，添加身份提供商</h2>
<ol type="1">
<li>登录 AWS 管理控制台，进入 <code>IAM</code> -&gt;
<code>Identity Providers</code>，点击 <code>添加身份提供商</code>。</li>
<li>配置身份提供商，选择 SAML 协议：
<ul>
<li>提供商名称：<code>keycloak-sso</code>（自定义名称）。</li>
<li>导入 Keycloak 导出的 <code>keycloak-saml-metadata.xml</code>
文件。</li>
</ul></li>
</ol>
<h2 id="aws-控制台操作为身份提供商绑定-iam-角色">4.1.4 AWS
控制台操作，为身份提供商绑定 IAM 角色</h2>
<ol type="1">
<li>添加身份提供商后，点击 <code>下一步</code> 进入角色分配。</li>
<li>选择 <code>创建新角色</code>。</li>
<li>选择受信任实体的类型为：<code>SAML 2.0 身份联合</code>。</li>
<li>在 <code>SAML 提供商</code> 处选择 <code>keycloak-sso</code>。</li>
<li>允许 <code>编程访问</code> 和
<code>亚马逊云科技 管理控制台访问</code>。</li>
<li>点击
<code>下一步</code>，为角色设置权限，附加所需的权限策略（例如，<code>AdministratorAccess</code>）。</li>
<li>点击 <code>下一步</code>
设置标签，进行角色名称填写后，完成角色创建。示例角色名称为
<code>sso-saml-admin</code>。</li>
<li>记录 IAM 角色 ARN 和身份提供商 ARN，这些信息将在后续的 Keycloak
客户端配置中使用。</li>
</ol>
<p><strong>注意</strong>：AWS 中国和 AWS 国际的配置略有差异： -
<strong>AWS 中国账号</strong> 格式： - IAM角色
ARN：<code>arn:aws-cn:iam::&lt;aws-account-id&gt;:role/sso-saml-admin</code>
- 身份提供商
ARN：<code>arn:aws-cn:iam::&lt;aws-account-id&gt;:saml-provider/keycloak-sso</code>
- <strong>AWS 国际账号</strong> 格式： - IAM角色
ARN：<code>arn:aws:iam::&lt;aws-account-id&gt;:role/sso-saml-admin</code>
- 身份提供商
ARN：<code>arn:aws:iam::&lt;aws-account-id&gt;:saml-provider/keycloak-sso</code></p>
<h2 id="keycloak-控制台操作创建客户端">4.1.5 Keycloak
控制台操作，创建客户端</h2>
<ol type="1">
<li>下载 SAML Metadata 文件：
<ul>
<li><strong>AWS 中国</strong>：下载地址 <a
href="https://signin.amazonaws.cn/static/saml-metadata.xml">SAML
Metadata</a></li>
<li><strong>AWS 国际版</strong>：下载地址 <a
href="https://signin.aws.amazon.com/static/saml-metadata.xml">SAML
Metadata</a></li>
</ul></li>
<li>登录到 Keycloak 管理控制台，选择一个 Realm，点击左侧的
<code>Clients</code>，然后选择 <code>导入客户端</code>。</li>
<li>选择下载的 Metadata 文件进行导入，点击 <code>Save</code>
保存配置。</li>
<li>修改以下配置：
<ul>
<li><strong>IDP-Initiated SSO URL
名称</strong>：<code>aws-cn-sso</code>（关键配置项）。</li>
<li><strong>Home URL</strong>：例如，对于
<code>keycloak.onwalk.net</code>，对应的内容是
<code>https://keycloak.onwalk.net/realms/cloud-sso/protocol/saml/clients/aws-cn-sso</code>。</li>
</ul></li>
</ol>
<h2 id="keycloak-控制台操作创建-realm-角色">4.1.6 Keycloak
控制台操作，创建 Realm 角色</h2>
<ol type="1">
<li>在 <code>Realm Roles</code> 选项卡下，创建新的角色用于授权 Keycloak
用户，格式如下：
<ul>
<li>角色名：<code>&lt;sso-iam-role-arn&gt;,&lt;identity-providers-arn&gt;</code>。</li>
</ul></li>
</ol>
<h2 id="keycloak-控制台操作更新客户端配置">4.1.7 Keycloak
控制台操作，更新客户端配置</h2>
<ol type="1">
<li>进入 <code>Client</code> -&gt;
<code>urn:amazon:webservices:cn-north-1</code>，选择
<code>clientScopes</code>，点击
<code>urn:amazon:webservices:cn-north-1</code>。</li>
<li>在 <code>scope</code> 设置中，选择 <code>Full scope allowed</code>
为 <code>Off</code>。</li>
<li>删除 Role List，执行 <code>assign role</code> 操作，将步骤 4.1.6
中创建的 Realm 角色分配给客户端。</li>
</ol>
<h2 id="keycloak-控制台操作调整-session-role-配置">4.1.8 Keycloak
控制台操作，调整 Session Role 配置</h2>
<ol type="1">
<li>更新客户端配置：进入 <code>Client</code> -&gt;
<code>urn:amazon:webservices:cn-north-1</code>，选择
<code>clientScopes</code> -&gt;
<code>urn:amazon:webservices:cn-north-1-dedicated</code> -&gt;
<code>Mappers</code>。</li>
<li>删除原有的 Role 配置，重新添加以下配置：
<ul>
<li>映射器类型：<code>Role list</code></li>
<li>Name：<code>Session Role</code></li>
<li>Role attribute
name：<code>https://aws.amazon.com/SAML/Attributes/Role</code></li>
<li>Single Role Attribute：<code>开启</code></li>
</ul></li>
</ol>
<h2 id="keycloak-控制台操作调整-session-name-配置">4.1.9 Keycloak
控制台操作，调整 Session Name 配置</h2>
<ol type="1">
<li>更新客户端配置：进入 <code>Client</code> -&gt;
<code>urn:amazon:webservices:cn-north-1</code>，选择
<code>clientScopes</code> -&gt;
<code>urn:amazon:webservices:cn-north-1-dedicated</code> -&gt;
<code>Mappers</code>。</li>
<li>删除原有的 Role Session 配置，重新添加以下配置：
<ul>
<li>映射器类型：<code>User Property</code></li>
<li>Name：<code>Session Name</code></li>
<li>属性：<code>email</code></li>
<li>Role Attribute
Name：<code>https://aws.amazon.com/SAML/Attributes/RoleSessionName</code></li>
</ul></li>
</ol>
<h2 id="keycloak-控制台操作新增用户">4.1.10 Keycloak
控制台操作，新增用户</h2>
<ol type="1">
<li>在 Keycloak 控制台中，创建新用户。</li>
<li>清除原有的 role 配置，并执行 <code>Assign role</code> 操作，将步骤
4.1.6 中创建的 Realm 角色分配给该用户。</li>
</ol>
<h2 id="keycloak-控制台操作验证-sso-登录">4.1.11 Keycloak
控制台操作，验证 SSO 登录</h2>
<ol type="1">
<li>使用浏览器访问
<code>Home URL</code>，例如：<code>https://keycloak.onwalk.net/realms/cloud-sso/protocol/saml/clients/aws-cn-sso</code>。</li>
</ol>
<h1 id="gitlab-oidc-sso-配置">5.7 Gitlab OIDC SSO 配置</h1>
<h2 id="keycloak控制台操作新建gitlab-oidc客户端">5.7.1
Keycloak控制台操作：新建Gitlab OIDC客户端</h2>
<ol type="1">
<li><strong>Keycloak侧配置：</strong>
<ul>
<li>选择一个 Realm，左侧侧边栏点击 <strong>客户端</strong>，右侧选择
<strong>创建客户端</strong>。</li>
<li><strong>客户端类型</strong>: 选择 <strong>OpenID connect</strong>
（关键配置项）。</li>
<li><strong>客户端ID</strong>: 输入 <code>gitlab-oidc</code>
（关键配置项）。</li>
<li><strong>客户端名称</strong>: 输入 <code>gitlab-oidc</code>。</li>
</ul></li>
<li><strong>选择下一步：</strong>
<ul>
<li><strong>客户端验证</strong>: 开启（关键配置项）。</li>
</ul></li>
<li><strong>选择下一步：</strong>
<ul>
<li><strong>Home URL</strong>: 输入
<code>https://&lt;gitlab-domain&gt;</code>（关键配置项）。</li>
<li><strong>有效的重定向URI</strong>: 输入
<code>https://&lt;gitlab-domain&gt;/users/auth/openid_connect/callback</code>（关键配置项）。</li>
</ul></li>
<li><strong>保存</strong>，并记录生成的 <code>gitlab-oidc</code>
客户端密钥。</li>
</ol>
<h2 id="gitlab侧配置开启oidc登录选项">5.7.2
Gitlab侧配置：开启OIDC登录选项</h2>
<p>以 <strong>Helm 部署 Gitlab</strong> 为例，进行如下配置：</p>
<ol type="1">
<li><p><strong>创建存储OIDC认证信息的 Secret：</strong> ```bash cat &gt;
provider.yaml &lt;&lt; EOF name: ‘openid_connect’ label: ‘keycloak-sso’
args: name: ‘openid_connect’ scope: - ‘openid’ - ‘profile’ - ‘email’
pkce: true discovery: true response_type: ‘code’ client_auth_method:
‘query’ send_scope_to_token_endpoint: true issuer:
‘https://keycloak.apollo-ev.com/realms/cloud-sso’ client_options:
identifier: ‘gitlab-oidc’ secret: ‘gitlab-oidc-token’ redirect_uri:
‘https://gitlab.apollo-ev.com/users/auth/openid_connect/callback’
EOF</p>
<p>export KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl delete secret
gitlab-sso-secret -n gitlab || echo true kubectl create secret generic
gitlab-sso-secret –from-file=“provider=provider.yaml” -n gitlab</p></li>
</ol>
<p>更新 Gitlab 部署配置： 修改 gitlab-values.yaml，添加以下配置：</p>
<p>yaml 复制代码 global: appConfig: omniauth: enabled: true
autoLinkLdapUser: false autoLinkSamlUser: false blockAutoCreatedUsers:
false autoSignInWithProvider: null autoLinkUser: - ‘openid_connect’
allowSingleSignOn: - ‘openid_connect’ providers: - secret:
gitlab-sso-secret key: provider 更新 Gitlab 部署：</p>
<p>bash 复制代码 helm repo add gitlab https://charts.gitlab.io/ helm
repo up helm upgrade –install gitlab gitlab/gitlab –namespace gitlab -f
gitlab-values.yaml</p>
<p>Gitlab 更新后，重新打开 Gitlab 登录页面，您将看到新的 sign in with
keycloak-sso 选项。</p>
<h1 id="harbor-oidc-sso-配置">5.8 Harbor OIDC SSO 配置</h1>
<h2 id="keycloak控制台操作新建-harbor-oidc-客户端">5.8.1
Keycloak控制台操作：新建 Harbor OIDC 客户端</h2>
<ol type="1">
<li><strong>Keycloak 侧配置：</strong>
<ul>
<li>选择一个 <strong>Realm</strong>，左侧侧边栏点击
<strong>客户端</strong>，右侧选择 <strong>创建客户端</strong>。</li>
<li><strong>客户端类型</strong>: 选择 <strong>OpenID connect</strong>
（关键配置项）。</li>
<li><strong>客户端ID</strong>: 输入 <code>harbor-oidc</code>
（关键配置项）。</li>
<li><strong>客户端名称</strong>: 输入 <code>harbor-oidc</code>。</li>
</ul></li>
<li><strong>选择下一步：</strong>
<ul>
<li><strong>客户端验证</strong>: 开启（关键配置项）。</li>
</ul></li>
<li><strong>选择下一步：</strong>
<ul>
<li><strong>Home URL</strong>: 输入
<code>https://&lt;harbor-domain&gt;</code>（关键配置项）。</li>
<li><strong>有效的重定向URI</strong>: 输入
<code>https://&lt;harbor-domain&gt;/c/oidc/callback</code>（关键配置项）。</li>
</ul></li>
<li><strong>保存</strong>，并记录生成的 <code>harbor-oidc</code>
客户端密钥。</li>
</ol>
<h2 id="harbor侧配置开启-oidc-登录选项">5.8.2 Harbor侧配置：开启 OIDC
登录选项</h2>
<ol type="1">
<li><strong>如果 Harbor 已经配置过本地数据库用户：</strong>
<ul>
<li><p>需要先清除所有普通用户，登录 Harbor DB 执行以下操作：</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>\c registry</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> harbor_user;</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">delete</span> <span class="kw">from</span> harbor_user <span class="kw">where</span> username<span class="op">=</span><span class="st">&#39;haha#4&#39;</span>;</span></code></pre></div></li>
</ul></li>
<li><strong>登录 Harbor 控制台，添加 OIDC 认证模式配置：</strong>
<ul>
<li>进入 Harbor 控制台，找到 <strong>认证模式</strong> 配置，选择
<strong>OIDC</strong> 认证。</li>
<li>填入 Keycloak 生成的 OIDC 客户端信息，如 <strong>客户端ID</strong>
和 <strong>客户端密钥</strong>。</li>
</ul></li>
<li><strong>重新打开 Harbor 登录页面：</strong>
<ul>
<li>登录页面将会新增 <strong>OIDC 登录选项</strong>。</li>
<li>首次使用 OIDC
登录时，系统会自动为该用户创建一个本地用户，用户只需填写用户名即可完成登录。</li>
</ul></li>
</ol>
<h1 id="grafana-oidc-sso-配置">5.9 Grafana OIDC SSO 配置</h1>
<h2 id="keycloak控制台操作新建-grafana-oidc-客户端">5.9.1
Keycloak控制台操作：新建 Grafana OIDC 客户端</h2>
<ol type="1">
<li><strong>Keycloak 侧配置：</strong>
<ul>
<li>选择一个 <strong>Realm</strong>，左侧侧边栏点击
<strong>客户端</strong>，右侧选择 <strong>创建客户端</strong>。</li>
<li><strong>客户端类型</strong>: 选择 <strong>OpenID connect</strong>
（关键配置项）。</li>
<li><strong>客户端ID</strong>: 输入 <code>grafana-oidc</code>
（关键配置项）。</li>
<li><strong>客户端名称</strong>: 输入 <code>grafana-oidc</code>。</li>
</ul></li>
<li><strong>选择下一步：</strong>
<ul>
<li><strong>客户端验证</strong>: 开启（关键配置项）。</li>
</ul></li>
<li><strong>选择下一步：</strong>
<ul>
<li><strong>根 URL</strong>: 输入
<code>https://&lt;grafana-domain&gt;</code>。</li>
<li><strong>Home URL</strong>: 输入
<code>https://&lt;grafana-domain&gt;</code> （关键配置项）。</li>
<li><strong>有效的重定向URI</strong>: 输入 <code>*</code>
（关键配置项）。</li>
</ul></li>
<li><strong>保存</strong>，并记录生成的 <code>grafana-oidc</code>
客户端密钥。</li>
</ol>
<h2 id="grafana侧配置开启-oidc-登录选项">5.9.2 Grafana侧配置：开启 OIDC
登录选项</h2>
<ol type="1">
<li><p><strong>修改 <code>grafana.ini</code> 配置：</strong></p>
<ul>
<li><p>以容器集群内部署的 Grafana 为例，连接到部署的 Grafana
集群，执行以下命令：</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> edit cm observability-server-grafana <span class="at">-n</span> monitoring</span></code></pre></div></li>
</ul></li>
<li><p><strong>添加以下配置：</strong> ```ini [server] domain =
<grafana-domain> root_url = %(protocol)s://%(domain)s:%(http_port)s/
serve_from_sub_path = true</p>
<p>[auth.generic_oauth] enabled = true name = oidc-sso allow_sign_up =
true auto_login = false client_id = grafana-oidc client_secret =
<grafana-oidc-token> scopes = openid email profile roles
email_attribute_path = email login_attribute_path = username
name_attribute_path = full_name auth_url =
https://<keycloak-domain>/realms/cloud-sso/protocol/openid-connect/auth
token_url =
https://<keycloak-domain>/realms/cloud-sso/protocol/openid-connect/token
api_url =
https:/<keycloak-domain>/realms/cloud-sso/protocol/openid-connect/userinfo
role_attribute_path = contains(roles[*], ‘admin’) &amp;&amp; ‘Admin’ ||
contains(roles[*], ‘editor’) &amp;&amp; ‘Editor’ || ‘Viewer’ 更新
ConfigMap 后，重启 Grafana Pod：</p></li>
</ol>
<p>重启 Grafana 服务以使配置生效。 bash 复制代码 kubectl rollout restart
deployment grafana -n monitoring 重新打开 Grafana 登录页面：</p>
<p>登录页面将会新增 Sign in with oidc-sso 选项。 这样，你就成功为
Grafana 配置了基于 Keycloak 的 OIDC SSO 登录。</p>
<p>这段内容已整理为 <code>5.9 Grafana OIDC SSO 配置</code>，包括了在
Keycloak 和 Grafana 侧进行的所有配置</p>
<h2 id="references">References</h2>
<ol type="1">
<li>https://www.keycloak.org/documentation</li>
<li>https://aws-samples.github.io/keycloak-on-aws/en/</li>
<li>https://docs.gitlab.com/ee/administration/auth/oidc.html</li>
<li>https://git.xcvtc.edu.cn/help/administration/auth/oidc.md</li>
<li>https://grafana.com/tutorials/run-grafana-behind-a-proxy/
<ul>
<li>(need setup root_url and serve_from_sub_path)</li>
</ul></li>
<li>https://community.grafana.com/t/grafana-generic-oauth-with-keycloak/9692</li>
<li>https://grafana.com/docs/grafana/latest/setup-grafana/configure-security/configure-authentication/keycloak/</li>
</ol>
