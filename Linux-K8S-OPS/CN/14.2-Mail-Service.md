
svc.plus é‚®ä»¶ç³»ç»Ÿç”¨æˆ·è®¤è¯æ‰©å±•ç¬”è®°ï¼ˆDovecot + LDAP + OIDCï¼‰
ğŸ§­ ä¸€ã€ç›®æ ‡

ä¸º Postfix + Dovecot å‘ä¿¡ç³»ç»Ÿæä¾›å¯æ‰©å±•çš„ç”¨æˆ·è®¤è¯å±‚ï¼š

æ”¯æŒæœ¬åœ°æ–‡ä»¶ç”¨æˆ·ï¼ˆå†…ç½®ï¼‰

æ”¯æŒä¼ä¸šçº§ LDAPï¼ˆç»Ÿä¸€è´¦å·ï¼‰

æ”¯æŒ OIDC / OAuth2ï¼ˆç°ä»£å•ç‚¹ç™»å½•ï¼‰

ğŸ§± äºŒã€è®¤è¯æ–¹å¼æ¦‚è§ˆ
æ–¹å¼	ç±»å‹	ä½¿ç”¨åœºæ™¯	ä¼˜ç‚¹	ç¼ºç‚¹
passwd-file	æœ¬åœ°	å°è§„æ¨¡ã€è‡ªæ‰˜ç®¡	ç®€å•ç›´æ¥	æ‰‹åŠ¨ç»´æŠ¤
LDAP / Active Directory	ç›®å½•æœåŠ¡	ä¼ä¸š / å¤šç”¨æˆ·ç¯å¢ƒ	é›†ä¸­ç®¡ç†ã€æ”¯æŒå¤šå±æ€§	éœ€ç»´æŠ¤ LDAP å¯ç”¨æ€§
SQL (PostgreSQL/MySQL)	æ•°æ®åº“	è‡ªå»ºè´¦æˆ·ç³»ç»Ÿ	çµæ´»ã€é«˜åº¦å¯æ§	éœ€é¢å¤–æ•°æ®åº“ç»´æŠ¤
OIDC (OAuth2)	å¤–éƒ¨èº«ä»½æä¾›å•†	ä¸ SSO å¹³å°é›†æˆï¼ˆKeycloak / Auth0 / Googleï¼‰	æœ€ç°ä»£ã€æ— å¯†ç ç™»å½•	é…ç½®å¤æ‚ã€ä¾èµ–å¤–éƒ¨æœåŠ¡
âš™ï¸ ä¸‰ã€æœ¬åœ°æ–‡ä»¶è®¤è¯ï¼ˆé»˜è®¤ï¼‰

è·¯å¾„ï¼š/etc/dovecot/users

noreply@svc.plus:{SHA512-CRYPT}$6$hash...
support@svc.plus:{SHA512-CRYPT}$6$hash...


é…ç½®ï¼ˆ/etc/dovecot/conf.d/10-auth.confï¼‰ï¼š

auth_mechanisms = plain login
passdb {
  driver = passwd-file
  args = scheme=SHA512-CRYPT username_format=%u /etc/dovecot/users
}
userdb {
  driver = static
  args = uid=vmail gid=vmail home=/var/mail/%d/%n
}

ğŸ§© å››ã€LDAP é›†æˆï¼ˆå¯é€‰ï¼‰
1ï¸âƒ£ å®‰è£…ä¾èµ–
sudo apt install dovecot-ldap

2ï¸âƒ£ é…ç½®æ–‡ä»¶ï¼š/etc/dovecot/conf.d/auth-ldap.conf.ext
passdb {
  driver = ldap
  args = /etc/dovecot/dovecot-ldap.conf.ext
}

userdb {
  driver = ldap
  args = /etc/dovecot/dovecot-ldap.conf.ext
}

3ï¸âƒ£ è¿æ¥ä¿¡æ¯ï¼š/etc/dovecot/dovecot-ldap.conf.ext
hosts = ldap.svc.plus
dn = cn=mailbind,ou=system,dc=svc,dc=plus
dnpass = SuperSecretPassword
base = ou=users,dc=svc,dc=plus
ldap_version = 3
scope = subtree
auth_bind = yes
user_attrs = homeDirectory=home,uidNumber=uid,gidNumber=gid
user_filter = (&(objectClass=posixAccount)(uid=%u))
pass_filter = (&(objectClass=posixAccount)(uid=%u))
default_pass_scheme = SHA512-CRYPT

4ï¸âƒ£ éªŒè¯
doveadm auth test user1@svc.plus password123


âœ… æˆåŠŸåˆ™è¡¨ç¤º Dovecot èƒ½ä» LDAP éªŒè¯ç”¨æˆ·ã€‚

â˜ï¸ äº”ã€OIDC / OAuth2 é›†æˆï¼ˆé«˜çº§æ–¹æ¡ˆï¼‰

é€‚ç”¨äºä½ å·²æœ‰ç»Ÿä¸€ç™»å½•ç³»ç»Ÿï¼ˆå¦‚ XControl Account Serviceã€Keycloakã€Auth0ã€Google Workspaceï¼‰ã€‚

1ï¸âƒ£ åŸç†æ¦‚è¿°

IMAP/SMTP å®¢æˆ·ç«¯é€šè¿‡ OAUTHBEARER æˆ– XOAUTH2 ç™»å½•ï¼Œ
Dovecot è°ƒç”¨ OIDC Provider çš„ introspection endpoint éªŒè¯ tokenã€‚

å®¢æˆ·ç«¯ â†’ EHLO
â†’ AUTH XOAUTH2 <base64(access_token)>
â†’ Dovecot â†’ OIDC introspection
â†’ è¿”å› 235 Authentication successful

2ï¸âƒ£ å¯ç”¨ OAUTHBEARER æ”¯æŒ

å®‰è£…æ¨¡å—ï¼š

sudo apt install dovecot-oauth2-plugin


åœ¨ 10-auth.conf ä¸­ï¼š

auth_mechanisms = plain login xoauth2
!include auth-oauth2.conf.ext

3ï¸âƒ£ OIDC é…ç½®æ–‡ä»¶ /etc/dovecot/conf.d/auth-oauth2.conf.ext

ç¤ºä¾‹ï¼ˆä»¥ Keycloak ä¸ºä¾‹ï¼‰ï¼š

passdb {
  driver = oauth2
  mechanisms = xoauth2
  args = /etc/dovecot/dovecot-oauth2.conf.ext
}


/etc/dovecot/dovecot-oauth2.conf.ext å†…å®¹ï¼š

introspection_url = https://auth.svc.plus/realms/xcontrol/protocol/openid-connect/token/introspect
client_id = mail-smtp
client_secret = supersecret123
ssl_require = yes
ssl_verify = yes
user_format = %u
introspection_mode = token
scope = openid email profile


ğŸ“˜ å¦‚æœä½ ä½¿ç”¨è‡ªå»ºè´¦æˆ·ä¸­å¿ƒï¼ˆGo å®ç°çš„ accounts-serviceï¼‰ï¼Œ
ä¹Ÿå¯ä»¥æš´éœ²ä¸€ä¸ª /api/auth/introspect å…¼å®¹ç«¯ç‚¹ä¾› Dovecot è°ƒç”¨ã€‚

ğŸ”’ å…­ã€æ··åˆé…ç½®ç­–ç•¥ï¼ˆæ¨èï¼‰

åœ¨ 10-auth.conf ä¸­å¯ç”¨å¤šåç«¯ï¼š

!include auth-passwdfile.conf.ext
!include auth-ldap.conf.ext
!include auth-oauth2.conf.ext


Dovecot ä¼šä»ä¸Šå¾€ä¸‹ä¾æ¬¡å°è¯•ï¼š

æœ¬åœ°ç”¨æˆ·æ–‡ä»¶

LDAP

OIDC

è¿™æ ·æ—¢å¯ä¿è¯ç¦»çº¿å¯ç”¨æ€§ï¼ˆæœ¬åœ°ç”¨æˆ·ï¼‰ï¼Œ
åˆèƒ½é›†æˆä¼ä¸šç»Ÿä¸€è®¤è¯ã€‚

ğŸ§  ä¸ƒã€æµ‹è¯•ä¸éªŒè¯å‘½ä»¤
# æµ‹è¯•æœ¬åœ°ç”¨æˆ·
doveadm auth test noreply@svc.plus yourpassword

# æµ‹è¯• LDAP ç”¨æˆ·
doveadm auth test alice@svc.plus password123

# æµ‹è¯• OIDC ç™»å½•ï¼ˆéœ€è¦ access_tokenï¼‰
doveadm auth test -m xoauth2 bob@svc.plus "ya29.a0ARrdaM..."


æŸ¥çœ‹æ—¥å¿—ï¼š

tail -f /var/log/dovecot.log

ğŸ“Š å…«ã€æ¨èç»„åˆçŸ©é˜µ
åœºæ™¯	å»ºè®®æ–¹æ¡ˆ	ä¼˜ç‚¹
è‡ªå»ºç³»ç»Ÿ / å•æœº	passwd-file	æ— å¤–éƒ¨ä¾èµ–ï¼Œç®€å•æ˜“ç»´æŠ¤
å¤šç”¨æˆ·å†…éƒ¨ç³»ç»Ÿ	LDAP	é›†ä¸­ç®¡ç†è´¦å·ã€å…¼å®¹ Linux PAM
ä¼ä¸šç»Ÿä¸€ç™»å½•	OIDC	ä¸ Keycloakã€Googleã€Azure AD é›†æˆ
å¤šç§Ÿæˆ· SaaS	LDAP + OIDC æ··åˆ	ä¿æŒçµæ´»ã€å…¼å®¹æ€§æœ€å¼º
âœ¨ ä¹ã€æ€»ç»“ï¼ˆsvc.plus é‚®ä»¶ç³»ç»Ÿè®¤è¯å±‚ï¼‰
å±‚çº§	å®ç°	åè®®
å‘ä¿¡	Postfix (587/465)	SMTP + STARTTLS
éªŒè¯	Dovecot	SASL / OAuth2
å¤–éƒ¨ç›®å½•	LDAP / OIDC	LDAPv3 / OpenID Connect
ä¿¡ä»»é“¾	SPF + DKIM + DMARC + PTR	DNS + Milter
å®‰å…¨å±‚	TLS (æ‰‹åŠ¨è¯ä¹¦)	PEM æ–‡ä»¶ç»´æŠ¤

âœ… é€šè¿‡ Dovecot çš„æ’ä»¶åŒ–æ¶æ„ï¼Œä½ å¯ä»¥è®© mail.svc.plus æ”¯æ’‘ä¼ ç»Ÿç™»å½•å’Œç°ä»£ OAuth2 SSOï¼Œ
ä¿æŒç³»ç»Ÿè½»é‡è€Œå…·ä¼ä¸šçº§æ‰©å±•æ€§ã€‚
