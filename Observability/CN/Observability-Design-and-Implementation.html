<h1 id="目录结构"><strong>目录结构</strong></h1>
<hr />
<h2 id="概述overview"><strong>概述（Overview）</strong></h2>
<h3 id="overview.md"><strong>01-overview.md</strong></h3>
<ul>
<li><strong>1.1 引言</strong></li>
<li><strong>1.2 内容简介</strong></li>
<li><strong>1.3 目标读者</strong></li>
</ul>
<hr />
<h2 id="数据类型与指标"><strong>数据类型与指标</strong></h2>
<h3 id="可观测性数据类型总览telemetry-overview"><strong>2.
可观测性数据类型总览（Telemetry Overview）</strong></h3>
<h4
id="telemetry-overview.md"><strong>02-telemetry-overview.md</strong></h4>
<ul>
<li><strong>2.1 指标（Metrics）</strong></li>
<li><strong>2.2 日志（Logs）</strong></li>
<li><strong>2.3 追踪（Traces）</strong></li>
<li><strong>2.4 事件（Events）</strong></li>
<li><strong>2.5 性能剖析（Profiles）</strong></li>
<li><strong>2.6 网络元组（Network Tuples）</strong></li>
<li><strong>2.7 SLA / SLO / SLI</strong></li>
</ul>
<hr />
<h2 id="ebpf-技术与应用"><strong>eBPF 技术与应用</strong></h2>
<h3 id="bpf-overview.md"><strong>03-bpf-overview.md</strong></h3>
<ul>
<li><strong>3.1 概述</strong></li>
<li><strong>3.2 对比</strong></li>
<li><strong>3.3 场景</strong></li>
</ul>
<hr />
<h2 id="应用系统故障排查"><strong>应用系统故障排查</strong></h2>
<h3 id="故障排查整体流程"><strong>4.1 故障排查整体流程</strong></h3>
<h4 id="从客户端到服务端的请求路径"><strong>4.1.1
从客户端到服务端的请求路径</strong></h4>
<ul>
<li>DNS 解析</li>
<li>TCP 连接建立</li>
<li>TLS 握手（如适用）</li>
<li>请求发送与响应接收</li>
</ul>
<h4 id="分层排查思路"><strong>4.1.2 分层排查思路</strong></h4>
<ul>
<li>应用层</li>
<li>服务层</li>
<li>网络层</li>
<li>物理层</li>
</ul>
<hr />
<h3 id="应用请求关联指标的排查"><strong>4.2
应用请求关联指标的排查</strong></h3>
<h4 id="响应时间"><strong>4.2.1 响应时间</strong></h4>
<ul>
<li>慢请求分析</li>
<li>依赖服务性能</li>
</ul>
<h4 id="错误率"><strong>4.2.2 错误率</strong></h4>
<ul>
<li>服务端异常 vs 客户端异常</li>
<li>HTTP 状态码分析</li>
</ul>
<h4 id="系统资源使用率"><strong>4.2.3 系统资源使用率</strong></h4>
<ul>
<li>CPU 和内存监控</li>
<li>资源泄漏检测</li>
</ul>
<h4 id="用户留存率"><strong>4.2.4 用户留存率</strong></h4>
<ul>
<li>用户行为分析</li>
<li>功能可用性检查</li>
</ul>
<h4 id="吞吐量"><strong>4.2.5 吞吐量</strong></h4>
<ul>
<li>负载测试</li>
<li>扩展能力评估</li>
</ul>
<hr />
<h3 id="网络关键指标的排查"><strong>4.3 网络关键指标的排查</strong></h3>
<h4 id="带宽利用率"><strong>4.3.1 带宽利用率</strong></h4>
<ul>
<li>流量监控</li>
<li>异常流量检测</li>
</ul>
<h4 id="延迟"><strong>4.3.2 延迟</strong></h4>
<ul>
<li>网络路径优化</li>
<li>地理位置影响</li>
</ul>
<h4 id="丢包率"><strong>4.3.3 丢包率</strong></h4>
<ul>
<li>链路质量</li>
<li>设备故障排查</li>
</ul>
<h4 id="网络抖动"><strong>4.3.4 网络抖动</strong></h4>
<ul>
<li>实时应用影响</li>
<li>网络稳定性提升</li>
</ul>
<h4 id="网络可用性"><strong>4.3.5 网络可用性</strong></h4>
<ul>
<li>冗余设计</li>
<li>故障切换机制</li>
</ul>
<h4 id="重传率"><strong>4.3.6 重传率</strong></h4>
<ul>
<li>拥塞控制</li>
<li>传输优化</li>
</ul>
<h4 id="tcp-连接时间"><strong>4.3.7 TCP 连接时间</strong></h4>
<ul>
<li>握手延迟分析</li>
<li>服务器性能</li>
</ul>
<h4 id="dns-查询时间"><strong>4.3.8 DNS 查询时间</strong></h4>
<ul>
<li>DNS 服务优化</li>
<li>缓存策略</li>
</ul>
<h4 id="http-请求成功率"><strong>4.3.9 HTTP 请求成功率</strong></h4>
<ul>
<li>服务器健康检查</li>
<li>网络异常处理</li>
</ul>
<hr />
<h3 id="日志分析与故障定位"><strong>4.4 日志分析与故障定位</strong></h3>
<h4 id="网络日志分析"><strong>4.4.1 网络日志分析</strong></h4>
<ul>
<li>流日志</li>
<li>数据包日志</li>
</ul>
<h4 id="服务日志分析"><strong>4.4.2 服务日志分析</strong></h4>
<ul>
<li>调用链追踪</li>
<li>接口性能监控</li>
</ul>
<h4 id="应用日志分析"><strong>4.4.3 应用日志分析</strong></h4>
<ul>
<li>错误堆栈</li>
<li>业务逻辑验证</li>
</ul>
<hr />
<h3 id="典型故障场景与案例分析"><strong>4.5
典型故障场景与案例分析</strong></h3>
<h4 id="服务端异常"><strong>4.5.1 服务端异常</strong></h4>
<ul>
<li>资源耗尽</li>
<li>依赖服务故障</li>
</ul>
<h4 id="客户端异常"><strong>4.5.2 客户端异常</strong></h4>
<ul>
<li>请求格式错误</li>
<li>网络连接失败</li>
</ul>
<h4 id="综合案例"><strong>4.5.3 综合案例</strong></h4>
<ul>
<li>从问题描述到根因定位</li>
</ul>
<hr />
<h2 id="附录"><strong>附录</strong></h2>
<h3 id="术语表"><strong>5.1 术语表</strong></h3>
<h3 id="参考资料"><strong>5.2 参考资料</strong></h3>
<h3 id="工具与资源"><strong>5.3 工具与资源</strong></h3>
<h3 id="生产级监控配置方案linux-裸机"><strong>5.4
生产级监控配置方案（Linux 裸机）</strong></h3>
<h4
id="production-monitoring-linux-bare-metal.md"><strong>05-production-monitoring-linux-bare-metal.md</strong></h4>
<ul>
<li>系统与进程指标采集、历史保底以及安全加固实践 ### <strong>5.5 Vector
统一采集架构与 DeepFlow 对比</strong> ####
<strong>05-vector-unified-collector-architecture.md</strong></li>
<li>Vector 汇聚多类 exporter，比较 DeepFlow 与 Vector
的功能与部署策略，并给出后端存储选型建议</li>
</ul>
<h3 id="postgresql-clickhouse-分层写入架构"><strong>5.6 PostgreSQL +
ClickHouse 分层写入架构</strong></h3>
<h4
id="postgres-clickhouse-layered-architecture.md"><strong>05-postgres-clickhouse-layered-architecture.md</strong></h4>
<ul>
<li>使用 TimescaleDB + ClickHouse
构建热写冷存的可观测性存储，实现高并发写入与 OLAP 聚合</li>
</ul>
<hr />
<h2 id="架构设计与容灾"><strong>架构设计与容灾</strong></h2>
<h3 id="技术选型对比technology-selection-comparison"><strong>6.1
技术选型对比（Technology Selection Comparison）</strong></h3>
<h4
id="technical-selection-comparison.md"><strong>06-technical-selection-comparison.md</strong></h4>
<ul>
<li>边缘采集对比</li>
<li>网关对比</li>
<li>存储对比</li>
<li>分析层对比</li>
</ul>
<h3 id="总体架构设计"><strong>6.2 总体架构设计</strong></h3>
<h4
id="overall-architecture-design.md"><strong>07-overall-architecture-design.md</strong></h4>
<ul>
<li>边缘采集与缓冲</li>
<li>区域网关与扇出</li>
<li>存储与分析层</li>
<li>双链路（近线检索 + Kafka 回放）</li>
</ul>
<h3 id="多区域架构与区域内拓扑"><strong>6.3
多区域架构与区域内拓扑</strong></h3>
<h4
id="multi-region-architecture-topology.md"><strong>08-multi-region-architecture-topology.md</strong></h4>
<ul>
<li>区域内拓扑（单区示例）</li>
<li>多区域部署模式（主区 + 从区）</li>
<li>联邦查询与统一入口</li>
</ul>
<h3 id="端到端可靠传输设计at-least-once-语义"><strong>6.4
端到端可靠传输设计（At-least-once 语义）</strong></h3>
<h4
id="end-to-end-reliable-transmission-design.md"><strong>09-end-to-end-reliable-transmission-design.md</strong></h4>
<ul>
<li>多级持久化链（Vector → OTel → Kafka → OpenObserve）</li>
<li>扇出与去重策略（event_id + UPSERT）</li>
<li>SRE 可观测与演练方法</li>
</ul>
<h3 id="postgresql-二级分析域"><strong>6.5 PostgreSQL
二级分析域</strong></h3>
<h4
id="postgresql-secondary-analysis-domain.md"><strong>10-postgresql-secondary-analysis-domain.md</strong></h4>
<ul>
<li>时序分析（TimescaleDB 连续聚合）</li>
<li>向量检索（pgvector）</li>
<li>图查询（Apache AGE）</li>
<li>高基数与 TopK 分析（HLL/Toolkit）</li>
</ul>
<h3 id="多区域与容灾disaster-recovery-dr"><strong>6.6
多区域与容灾（Disaster Recovery, DR）</strong></h3>
<h4
id="multi-region-disaster-recovery.md"><strong>11-multi-region-disaster-recovery.md</strong></h4>
<ul>
<li>接入与路由（Anycast/GeoDNS）</li>
<li>跨区复制与镜像（Kafka MirrorMaker2）</li>
<li>阈值控制与降级策略</li>
<li>历史回放与灰度演练</li>
</ul>
<h2 id="监控简史monitoring-history"><strong>监控简史（Monitoring
History）</strong></h2>
<h3 id="漫谈监控简史到全栈可观测数据选型"><strong>7.1
漫谈监控简史到全栈可观测数据选型</strong></h3>
<h4
id="monitoring-history-to-full-stack-observable-data-selection.md"><strong>12-1-monitoring-history-to-full-stack-observable-data-selection.md</strong></h4>
<h3 id="典型运维工作场景"><strong>7.2 典型运维工作场景</strong></h3>
<h4
id="typical-operations-scenarios.md"><strong>12-2-typical-operations-scenarios.md</strong></h4>
<h2
id="可观测系统设计篇observability-system-design"><strong>可观测系统设计篇（Observability
System Design）</strong></h2>
<h3 id="边缘采集与网关的抉择"><strong>8.1
边缘采集与网关的抉择</strong></h3>
<h4
id="edge-collection-vs-gateway.md"><strong>13-1-edge-collection-vs-gateway.md</strong></h4>
<h3 id="otel-gateway-的设计与思考"><strong>8.2 OTel Gateway
的设计与思考</strong></h3>
<h4
id="otel-gateway-design-considerations.md"><strong>13-2-otel-gateway-design-considerations.md</strong></h4>
<h3 id="数据采集多级持久化与可重放"><strong>8.3
数据采集多级持久化与可重放</strong></h3>
<h4
id="data-ingestion-multi-level-persistence-and-replay.md"><strong>13-3-data-ingestion-multi-level-persistence-and-replay.md</strong></h4>
<h3 id="全栈可观测数据库设计"><strong>8.4
全栈可观测数据库设计</strong></h3>
<h4
id="full-stack-observability-database-design.md"><strong>13-4-full-stack-observability-database-design.md</strong></h4>
<h3 id="全栈可观测数据库-etl-设计"><strong>8.5 全栈可观测数据库 ETL
设计</strong></h3>
<h4
id="full-stack-observability-database-etl-design.md"><strong>13-5-full-stack-observability-database-etl-design.md</strong></h4>
<h3 id="监控系统的多区域与容灾"><strong>8.6
监控系统的多区域与容灾</strong></h3>
<h4
id="monitoring-system-multi-region-and-dr.md"><strong>13-6-monitoring-system-multi-region-and-dr.md</strong></h4>
<h2 id="llm-ops-agent-设计篇llm-ops-agent-design"><strong>LLM OPS Agent
设计篇（LLM OPS Agent Design）</strong></h2>
<h3 id="从-sshscp-到-ai-驱动的-ops-agent落地前的思考"><strong>9.1 从
SSH/SCP 到 AI 驱动的 OPS Agent：落地前的思考</strong></h3>
<h4
id="from-ssh-scp-to-ai-ops-agent-pre-deployment-considerations.md"><strong>14-1-from-ssh-scp-to-ai-ops-agent-pre-deployment-considerations.md</strong></h4>
<h3 id="从-sshscp-到-ai-驱动的-ops-agent能力清单"><strong>9.2 从 SSH/SCP
到 AI 驱动的 OPS Agent：能力清单</strong></h3>
<h4
id="from-ssh-scp-to-ai-ops-agent-capability-checklist.md"><strong>14-2-from-ssh-scp-to-ai-ops-agent-capability-checklist.md</strong></h4>
<h3 id="postgresql-扩展驱动的复杂分析向量-图-趋势"><strong>9.3
PostgreSQL 扩展驱动的复杂分析（向量 / 图 / 趋势）</strong></h3>
<h4
id="postgresql-extension-driven-complex-analysis-vector-graph-trend.md"><strong>14-3-postgresql-extension-driven-complex-analysis-vector-graph-trend.md</strong></h4>
<h3 id="ai-ops-agent-mvp-架构方案"><strong>9.4 AI-OPS Agent MVP
架构方案</strong></h3>
<h4
id="ai-ops-agent-mvp-architecture.md"><strong>14-4-ai-ops-agent-mvp-architecture.md</strong></h4>
<h1 id="observability-an-overview"><strong>Observability: An
Overview</strong></h1>
<p><strong>“Observability”</strong>（可观测性）是系统工程中的一个核心概念，尤其在分布式系统、云原生架构和微服务环境中至关重要。Observability
指的是通过系统外部可见的数据（如指标、日志、追踪信息等），推断系统内部状态并理解其运行行为的能力。它能够帮助工程师快速定位问题，优化性能，确保系统的可靠性和稳定性。</p>
<hr />
<h2
id="核心组成从三大支柱到五大关键数据类型"><strong>核心组成：从三大支柱到五大关键数据类型</strong></h2>
<p>传统上，Observability 的三大支柱是
<strong>Metrics</strong>（指标）、<strong>Logs</strong>（日志）和
<strong>Traces</strong>（分布式追踪）。在现代 Observability
中，这一体系已扩展为五大数据类型，涵盖 <strong>Events</strong>（事件）和
<strong>Profiles</strong>（性能剖析）。</p>
<h3 id="metrics指标"><strong>1. Metrics（指标）</strong></h3>
<ul>
<li><strong>定义</strong>：定量的时间序列数据，用于描述系统的性能和资源利用率。</li>
<li><strong>用途</strong>：趋势分析、容量规划、实时健康监控。</li>
<li><strong>典型内容</strong>：
<ul>
<li>CPU 使用率、内存占用、磁盘 I/O、网络流量。</li>
<li>应用层指标（如请求数、响应时间、错误率）。</li>
</ul></li>
<li><strong>工具</strong>：
<ul>
<li>Prometheus、Grafana、Datadog、CloudWatch。</li>
</ul></li>
</ul>
<h3 id="logs日志"><strong>2. Logs（日志）</strong></h3>
<ul>
<li><strong>定义</strong>：系统运行时的记录信息，通常以文本形式存储。</li>
<li><strong>用途</strong>：问题排查和故障根因分析。</li>
<li><strong>典型内容</strong>：
<ul>
<li>错误日志、访问日志、调试信息。</li>
</ul></li>
<li><strong>工具</strong>：
<ul>
<li>Elasticsearch、Fluentd、Splunk。</li>
</ul></li>
</ul>
<h3 id="traces分布式追踪"><strong>3. Traces（分布式追踪）</strong></h3>
<ul>
<li><strong>定义</strong>：记录请求在分布式系统中跨多个服务或组件的传播路径。</li>
<li><strong>用途</strong>：分析请求性能瓶颈、延迟和依赖关系。</li>
<li><strong>典型内容</strong>：
<ul>
<li>请求 ID、服务调用耗时、失败服务节点。</li>
</ul></li>
<li><strong>工具</strong>：
<ul>
<li>OpenTelemetry、Jaeger、Zipkin。</li>
</ul></li>
</ul>
<h3 id="events事件"><strong>4. Events（事件）</strong></h3>
<ul>
<li><strong>定义</strong>：系统中发生的重要状态变化或操作记录。</li>
<li><strong>用途</strong>：补充 Metrics 和
Logs，为关键操作提供上下文。</li>
<li><strong>典型事件</strong>：
<ul>
<li>Kubernetes Pod 生命周期变化（启动、销毁）。</li>
<li>配置变更、用户行为（如点击、登录）。</li>
</ul></li>
<li><strong>工具</strong>：
<ul>
<li>Kubernetes Events、EventBridge。</li>
</ul></li>
</ul>
<h3 id="profiles性能剖析"><strong>5. Profiles（性能剖析）</strong></h3>
<ul>
<li><strong>定义</strong>：动态收集程序运行时的性能数据，揭示代码和资源的使用情况。</li>
<li><strong>用途</strong>：优化性能、识别瓶颈。</li>
<li><strong>典型内容</strong>：
<ul>
<li>CPU/内存使用热点图。</li>
<li>函数调用栈及耗时分布。</li>
</ul></li>
<li><strong>工具</strong>：
<ul>
<li>Pyroscope、Parca、Flame Graph。</li>
</ul></li>
</ul>
<hr />
<h2 id="cbpfebpf-与零代码开源-agent-技术"><strong>CBPF/eBPF 与零代码开源
Agent 技术</strong></h2>
<p>现代 Observability 的实现得益于 <strong>CBPF/eBPF</strong>
技术，它们支持高性能、零代码的数据采集，并已催生出多种开源 Agent
工具。</p>
<h3 id="cbpf-与-ebpf-技术概述"><strong>CBPF 与 eBPF
技术概述</strong></h3>
<ul>
<li><strong>CBPF</strong>：
<ul>
<li><strong>经典 BPF</strong>，主要用于简单的网络数据包过滤操作，如
<code>tcpdump</code>。</li>
<li>功能有限，仅支持基础网络流量分析。</li>
</ul></li>
<li><strong>eBPF</strong>：
<ul>
<li><strong>扩展版
BPF</strong>，支持复杂逻辑，可动态挂载到内核钩子点，执行安全沙箱程序。</li>
<li>用于网络监控、性能分析和安全观测。</li>
<li>优势：高性能、灵活性强、无需修改应用代码。</li>
</ul></li>
</ul>
<h3 id="零代码开源-agent"><strong>零代码开源 Agent</strong></h3>
<p>利用 eBPF
的强大能力，社区开发了多种开源工具，能够实现零代码的深度数据采集。</p>
<h4 id="deepflow-agent"><strong>1. DeepFlow-Agent</strong></h4>
<ul>
<li><strong>特点</strong>：
<ul>
<li>利用 eBPF 和 XDP
技术，从内核采集网络流量、应用性能数据和容器信息。</li>
<li>自动化关联 Kubernetes 元数据，生成服务依赖关系和网络拓扑。</li>
<li>高性能、无侵入式，适合云原生环境。</li>
</ul></li>
<li><strong>功能</strong>：
<ul>
<li>数据流日志（Flow Logs）。</li>
<li>应用性能指标（APM 数据）。</li>
<li>容器、Pod、虚拟机的元数据采集。</li>
</ul></li>
<li><strong>应用场景</strong>：
<ul>
<li>网络观测、分布式应用监控、安全分析。</li>
</ul></li>
<li><strong>官网</strong>：<a href="https://deepflow.yunshan.net/"
class="uri">https://deepflow.yunshan.net/</a></li>
</ul>
<h4 id="pixie"><strong>2. Pixie</strong></h4>
<ul>
<li><strong>特点</strong>：
<ul>
<li>基于 eBPF 的全自动化 Kubernetes Observability 工具。</li>
<li>无需代码修改，实时捕获请求延迟、应用状态和错误信息。</li>
</ul></li>
<li><strong>功能</strong>：
<ul>
<li>分布式追踪和服务依赖图。</li>
<li>实时应用性能剖析。</li>
</ul></li>
<li><strong>应用场景</strong>：
<ul>
<li>Kubernetes 环境的快速问题排查和性能优化。</li>
</ul></li>
<li><strong>官网</strong>：<a href="https://pixielabs.ai/"
class="uri">https://pixielabs.ai/</a></li>
</ul>
<h4 id="cilium"><strong>3. Cilium</strong></h4>
<ul>
<li><strong>特点</strong>：
<ul>
<li>使用 eBPF 提供高效的网络和安全 Observability 功能。</li>
<li>与 Kubernetes 深度集成，支持服务网格。</li>
</ul></li>
<li><strong>功能</strong>：
<ul>
<li>网络流量监控。</li>
<li>API 请求分析和服务依赖追踪。</li>
</ul></li>
<li><strong>应用场景</strong>：
<ul>
<li>云原生网络安全和 Observability。</li>
</ul></li>
<li><strong>官网</strong>：<a href="https://cilium.io/"
class="uri">https://cilium.io/</a></li>
</ul>
<h4 id="parca"><strong>4. Parca</strong></h4>
<ul>
<li><strong>特点</strong>：
<ul>
<li>专注于性能剖析，基于 eBPF 的开源工具。</li>
<li>无侵入式采集运行时的 CPU 和内存使用数据。</li>
</ul></li>
<li><strong>功能</strong>：
<ul>
<li>生成火焰图分析性能瓶颈。</li>
</ul></li>
<li><strong>应用场景</strong>：
<ul>
<li>微服务和云原生环境的性能优化。</li>
</ul></li>
<li><strong>官网</strong>：<a href="https://parca.dev/"
class="uri">https://parca.dev/</a></li>
</ul>
<h4 id="sysdig"><strong>5. Sysdig</strong></h4>
<ul>
<li><strong>特点</strong>：
<ul>
<li>eBPF 驱动的安全和监控工具。</li>
<li>采集系统调用和网络流量，用于安全分析和性能监控。</li>
</ul></li>
<li><strong>功能</strong>：
<ul>
<li>深入的系统调用审计。</li>
<li>容器和 Kubernetes 的运行时安全监控。</li>
</ul></li>
<li><strong>应用场景</strong>：
<ul>
<li>安全观测与性能监控结合。</li>
</ul></li>
<li><strong>官网</strong>：<a href="https://sysdig.com/"
class="uri">https://sysdig.com/</a></li>
</ul>
<hr />
<h2 id="关键术语"><strong>关键术语</strong></h2>
<table>
<colgroup>
<col style="width: 27%" />
<col style="width: 72%" />
</colgroup>
<thead>
<tr>
<th><strong>术语</strong></th>
<th><strong>定义</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Monitoring</strong></td>
<td>实时监控系统的健康状况和性能，用于快速检测异常。</td>
</tr>
<tr>
<td><strong>Tracing</strong></td>
<td>追踪请求在分布式系统中的传播路径，用于依赖关系和性能分析。</td>
</tr>
<tr>
<td><strong>Logging</strong></td>
<td>捕获系统运行时的信息，记录详细的事件历史。</td>
</tr>
<tr>
<td><strong>Instrumentation</strong></td>
<td>在代码中嵌入可观测性相关逻辑以生成数据，便于调试和监控。</td>
</tr>
<tr>
<td><strong>CBPF</strong></td>
<td>经典 BPF，主要用于简单的网络数据包过滤操作。</td>
</tr>
<tr>
<td><strong>eBPF</strong></td>
<td>扩展 BPF，可挂载到内核多个钩子点，支持复杂的监控和分析任务。</td>
</tr>
<tr>
<td><strong>XDP</strong></td>
<td>高性能网络数据包处理框架，运行在网络驱动层。</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="总结"><strong>总结</strong></h2>
<p>Observability 是现代分布式系统中不可或缺的能力。通过
Metrics、Logs、Traces、Events 和 Profiles 的结合，以及 CBPF/eBPF、XDP
等强大的内核技术支持，我们能够全面了解系统的行为和状态，并快速诊断问题。结合
DeepFlow-Agent、Pixie、Cilium
等开源工具，可以轻松实现零代码、低开销的高效数据采集，保障系统的稳定性和性能。</p>
<h1 id="概述">概述</h1>
<p>可观测性领域的主要数据类型包括指标、日志、追踪、事件、性能剖析以及网络元组，这些数据为
SLA、SLO 和 SLI
提供量化基础。它们共同构成对系统健康状况的多维度观察。</p>
<ul>
<li><strong>指标
(Metrics)</strong>：以时间序列方式记录资源与性能数据，适合趋势分析与容量规划。</li>
<li><strong>日志
(Logs)</strong>：详细记录系统事件和调试信息，提供问题定位所需的上下文。</li>
<li><strong>追踪
(Traces)</strong>：关联分布式请求，展示跨服务的调用链路。</li>
<li><strong>事件
(Events)</strong>：表示系统状态或配置变化，常作为告警触发源。</li>
<li><strong>性能剖析
(Profiles)</strong>：采集函数调用与资源消耗，帮助定位性能瓶颈。</li>
<li><strong>网络元组分析</strong>：利用源/目的地址、端口与协议识别网络会话与流量特征。</li>
<li><strong>SLA/SLO/SLI</strong>：SLA 定义服务承诺，SLO
是可执行目标，SLI 为衡量目标的具体指标。</li>
</ul>
<h1 id="对比">对比</h1>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>类型</th>
<th>目的</th>
<th>优势</th>
<th>常用工具</th>
</tr>
</thead>
<tbody>
<tr>
<td>指标</td>
<td>持续监控系统资源与性能</td>
<td>结构化、易聚合、查询高效</td>
<td>Prometheus, CloudWatch</td>
</tr>
<tr>
<td>日志</td>
<td>记录详细事件与错误</td>
<td>上下文丰富、可追溯</td>
<td>ELK Stack, Loki</td>
</tr>
<tr>
<td>追踪</td>
<td>展现请求的端到端路径</td>
<td>还原调用链路、分析延迟</td>
<td>Jaeger, Zipkin</td>
</tr>
<tr>
<td>事件</td>
<td>捕获状态变更</td>
<td>触发实时告警</td>
<td>Kubernetes Events, PagerDuty</td>
</tr>
<tr>
<td>性能剖析</td>
<td>分析代码级资源消耗</td>
<td>定位热点与瓶颈</td>
<td>pprof, eBPF</td>
</tr>
<tr>
<td>网络元组</td>
<td>识别网络会话与协议</td>
<td>精确流量分类</td>
<td>NetFlow, DeepFlow</td>
</tr>
<tr>
<td>SLA/SLO/SLI</td>
<td>度量服务质量</td>
<td>统一服务级别标准</td>
<td>各类 SLO 平台</td>
</tr>
</tbody>
</table>
<h1 id="使用场景">使用场景</h1>
<ul>
<li><strong>指标</strong>：用于性能监控、容量规划和异常检测。</li>
<li><strong>日志</strong>：用于故障排查、行为审计与安全分析。</li>
<li><strong>追踪</strong>：用于分析分布式系统调用链，定位延迟或错误服务。</li>
<li><strong>事件</strong>：用于记录配置变化或异常情况，驱动自动化响应。</li>
<li><strong>性能剖析</strong>：用于深入分析程序性能，优化
CPU、内存等资源使用。</li>
<li><strong>网络元组</strong>：用于流量分析、入侵检测与协议行为研究。</li>
<li><strong>SLA/SLO/SLI</strong>：用于制定服务等级目标、监控达成度并驱动改进。</li>
</ul>
<h1 id="ebpf-技术综述">eBPF 技术综述</h1>
<h2 id="概述-1">概述</h2>
<ul>
<li>eBPF 是 Linux
内核的通用编程框架，允许在运行时安全地将自定义程序挂载到内核事件上。</li>
<li>通过 XDP、TC、kprobes、tracepoints、LSM 等钩子点，eBPF
能对网络栈、系统调用、内存和安全事件进行细粒度观测。</li>
<li>eBPF 支持从 L2 到 L7
的网络协议解析，并可捕获文件、网络、进程等系统调用行为。</li>
<li>结合 Agent 模式，eBPF
可同时采集流量、日志、性能指标与元数据，实现云原生环境的全栈可观测。</li>
</ul>
<h2 id="对比-1">对比</h2>
<h3 id="cbpf-与-ebpf">CBPF 与 eBPF</h3>
<table>
<colgroup>
<col style="width: 21%" />
<col style="width: 30%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>特性</th>
<th>CBPF</th>
<th>eBPF</th>
</tr>
</thead>
<tbody>
<tr>
<td>用途</td>
<td>数据包过滤</td>
<td>网络过滤、性能分析、安全监控等</td>
</tr>
<tr>
<td>指令集</td>
<td>简单，功能有限</td>
<td>功能强大，支持复杂逻辑</td>
</tr>
<tr>
<td>运行环境</td>
<td>网络数据包</td>
<td>多种挂载点（网络、系统调用等）</td>
</tr>
<tr>
<td>验证器</td>
<td>无</td>
<td>严格的安全验证器</td>
</tr>
<tr>
<td>扩展性</td>
<td>差</td>
<td>强，支持用户态交互和多种映射类型</td>
</tr>
<tr>
<td>性能</td>
<td>高</td>
<td>接近 CBPF，有优化机制</td>
</tr>
</tbody>
</table>
<h3 id="传统模式与基于-agent-的采集模式">传统模式与基于 Agent
的采集模式</h3>
<table>
<colgroup>
<col style="width: 13%" />
<col style="width: 39%" />
<col style="width: 46%" />
</colgroup>
<thead>
<tr>
<th>维度</th>
<th>传统模式</th>
<th>基于 Agent 的采集模式</th>
</tr>
</thead>
<tbody>
<tr>
<td>流量采集方式</td>
<td>流量镜像或旁路设备</td>
<td>eBPF/XDP 内核级采集</td>
</tr>
<tr>
<td>部署复杂度</td>
<td>需要交换机配置或旁路设备</td>
<td>只需在主机安装 Agent</td>
</tr>
<tr>
<td>协议解析能力</td>
<td>通常仅支持 L3/L4</td>
<td>支持全面的 L7 协议解析</td>
</tr>
<tr>
<td>数据粒度</td>
<td>粗粒度流量统计</td>
<td>细粒度流日志与性能指标</td>
</tr>
<tr>
<td>元数据关联</td>
<td>需手动关联容器、进程信息</td>
<td>自动关联主机、容器与 Kubernetes 元数据</td>
</tr>
<tr>
<td>性能开销</td>
<td>镜像可能带来带宽占用</td>
<td>内核级采集开销极低</td>
</tr>
<tr>
<td>动态环境支持</td>
<td>对 Kubernetes 等动态环境支持较弱</td>
<td>原生适配动态环境，扩展性强</td>
</tr>
<tr>
<td>安全性</td>
<td>镜像存在数据泄露风险</td>
<td>数据在内核空间处理，安全性更高</td>
</tr>
</tbody>
</table>
<h2 id="场景">场景</h2>
<ul>
<li><strong>网络过滤与优化</strong>：利用 XDP、TC 对 L2-L7
流量执行负载均衡、DDoS 防护和流量整形。</li>
<li><strong>性能分析与故障排查</strong>：通过 kprobes、tracepoints
捕获系统调用与内核事件，定位 CPU、I/O 和内存瓶颈。</li>
<li><strong>安全监控</strong>：结合 LSM、Seccomp
等钩子与系统调用追踪，检测异常行为并实施自定义安全策略。</li>
<li><strong>全栈数据采集</strong>：Agent
模式将流量、元数据和应用指标关联，构建服务拓扑并支持 APM
与安全分析。</li>
</ul>
<h1 id="故障排查整体流程-1">4.1 故障排查整体流程</h1>
<h2 id="从客户端到服务端的请求路径-1">4.1.1
从客户端到服务端的请求路径</h2>
<ol type="1">
<li><strong>DNS 解析</strong></li>
<li><strong>TCP 连接建立</strong></li>
<li><strong>TLS 握手（如适用）</strong></li>
<li><strong>请求发送与响应接收</strong></li>
</ol>
<h2 id="分层排查思路-1">4.1.2 分层排查思路</h2>
<ul>
<li><strong>应用层</strong></li>
<li><strong>服务层</strong></li>
<li><strong>网络层</strong></li>
<li><strong>物理层</strong></li>
</ul>
<hr />
<h2 id="排查应用系统故障的详细步骤">排查应用系统故障的详细步骤</h2>
<p>应用系统故障排查需要从应用层到网络层系统性地进行分析。以下是结合应用指标、网络指标和日志分类的详细排查流程：</p>
<h3 id="明确故障现象和范围">1. 明确故障现象和范围</h3>
<h4 id="收集用户反馈">1.1 收集用户反馈</h4>
<ul>
<li><strong>用户报告的现象</strong>：页面无法加载、服务超时、功能异常等。</li>
<li><strong>报错信息</strong>：前端或客户端显示的具体错误提示（如 HTTP
404、500 等）。</li>
</ul>
<h4 id="划定故障范围">1.2 划定故障范围</h4>
<ul>
<li><strong>全局问题</strong>：所有用户都受到影响，例如服务完全不可用。</li>
<li><strong>局部问题</strong>：仅部分用户或功能受到影响，例如特定接口报错。</li>
</ul>
<h3 id="从应用层开始排查">2. 从应用层开始排查</h3>
<h4 id="查看应用日志">2.1 查看应用日志</h4>
<p><strong>目标</strong>：确定是否有内部错误（服务端异常）或客户端发送无效请求。</p>
<p><strong>步骤</strong>：</p>
<ul>
<li><strong>检查服务端异常</strong>：
<ul>
<li><p>查看应用日志是否有错误堆栈（如 NullPointerException、SQL
错误）。</p></li>
<li><p>排查 HTTP 500 或其他 5xx 错误相关的记录。</p></li>
<li><p><strong>示例</strong>：</p>
<pre><code>ERROR: Database connection failed for query: SELECT * FROM users WHERE id=123</code></pre></li>
</ul></li>
<li><strong>检查客户端异常</strong>：
<ul>
<li><p>查看是否有 HTTP 400 错误（如请求格式错误）。</p></li>
<li><p><strong>示例</strong>：</p>
<pre><code>WARN: Invalid input received: missing field &#39;username&#39;</code></pre></li>
</ul></li>
</ul>
<h4 id="分析应用指标">2.2 分析应用指标</h4>
<ul>
<li><strong>响应时间</strong>：是否显著增加，指向可能的性能问题。</li>
<li><strong>错误率</strong>：是否有明显的增长趋势。</li>
<li><strong>系统资源使用率</strong>：CPU、内存是否耗尽。</li>
</ul>
<p><strong>排查要点</strong>：</p>
<ul>
<li>如果响应时间高：进一步分析是服务内部处理耗时，还是调用外部依赖（如数据库、第三方服务）导致。</li>
<li>如果错误率高：根据日志，确认是否是特定接口或全局问题。</li>
</ul>
<h4 id="验证依赖服务">2.3 验证依赖服务</h4>
<ul>
<li><p><strong>数据库、缓存系统、消息队列等外部依赖是否正常</strong>：</p>
<ul>
<li><strong>数据库问题</strong>：
<ul>
<li>超时、连接池耗尽。</li>
<li>SQL 查询慢导致请求超时。</li>
</ul></li>
<li><strong>缓存问题</strong>：
<ul>
<li>缓存未命中，导致频繁访问数据库。</li>
<li>Redis/Memcached 服务不可用。</li>
</ul></li>
<li><strong>第三方服务问题</strong>：
<ul>
<li>调用第三方 API 超时或返回错误。</li>
</ul></li>
</ul></li>
</ul>
<h3 id="从服务层排查">3. 从服务层排查</h3>
<h4 id="调用日志分析">3.1 调用日志分析</h4>
<p><strong>目标</strong>：检查服务间调用是否正常，定位异常的服务节点。</p>
<p><strong>步骤</strong>：</p>
<ul>
<li><strong>服务间调用异常</strong>：
<ul>
<li><p>查看调用日志是否有 HTTP 503、502 等状态码。</p></li>
<li><p><strong>示例</strong>：</p>
<pre><code>2024-11-22 10:00:01 GET /api/orders/12345 Status: 503</code></pre></li>
</ul></li>
<li><strong>调用性能问题</strong>：
<ul>
<li>检查调用链的延迟指标（Tracing 数据）。</li>
<li>是否某个服务的响应时间显著增加。</li>
</ul></li>
</ul>
<h4 id="服务依赖健康检查">3.2 服务依赖健康检查</h4>
<p><strong>目标</strong>：确认服务的健康状况。</p>
<p><strong>步骤</strong>：</p>
<ul>
<li>检查服务是否在注册中心（如 Consul、Etcd）中处于健康状态。</li>
<li>使用 <code>curl</code> 或 <code>ping</code>
测试服务接口的可用性。</li>
</ul>
<h3 id="从网络层排查">4. 从网络层排查</h3>
<h4 id="查看流日志">4.1 查看流日志</h4>
<p><strong>目标</strong>：排查网络连接问题，确认流量是否正常到达。</p>
<p><strong>步骤</strong>：</p>
<ul>
<li>查看流日志是否有异常的流量模式：
<ul>
<li><p>连接失败（如大量 RST 包）。</p></li>
<li><p>丢包率是否过高。</p></li>
<li><p><strong>示例</strong>：</p>
<pre><code>SrcIP: 192.168.1.10 DstIP: 10.0.0.5 Protocol: TCP Flags: RST</code></pre></li>
</ul></li>
</ul>
<h4 id="分析网络指标">4.2 分析网络指标</h4>
<ul>
<li><strong>延迟</strong>：检查 RTT 是否显著增加。</li>
<li><strong>丢包率</strong>：高丢包可能导致服务不可用或超时。</li>
<li><strong>重传率</strong>：高重传可能是网络拥塞或链路质量差的信号。</li>
</ul>
<h4 id="网络层问题验证">4.3 网络层问题验证</h4>
<p><strong>目标</strong>：判断是否为网络问题导致的故障。</p>
<p><strong>步骤</strong>：</p>
<ul>
<li>使用 <code>ping</code> 或 <code>traceroute</code>
确认网络延迟和链路状态。</li>
<li>使用工具 <code>tcpdump</code> 或 Wireshark
捕获数据包，分析是否有丢包、RST 等异常。</li>
</ul>
<h3 id="综合分析日志和指标">5. 综合分析日志和指标</h3>
<h4 id="应用日志">5.1 应用日志</h4>
<ul>
<li>定位代码错误或业务逻辑问题。</li>
<li><strong>示例</strong>：</li>
</ul>
<p>ERROR: User authentication failed due to missing token.</p>
<p>markdown 复制代码</p>
<h4 id="服务日志">5.2 服务日志</h4>
<ul>
<li>追踪服务调用链，确认异常服务或节点。</li>
<li><strong>示例</strong>：</li>
</ul>
<p>Service A -&gt; Service B [Timeout]</p>
<h4 id="网络日志">5.3 网络日志</h4>
<ul>
<li>分析流量和连接状态，确认网络稳定性。</li>
<li><strong>示例</strong>：</li>
</ul>
<p>TCP Retransmissions detected: 10% packets lost.</p>
<h3 id="常见故障场景及排查思路">6. 常见故障场景及排查思路</h3>
<table>
<colgroup>
<col style="width: 15%" />
<col style="width: 32%" />
<col style="width: 51%" />
</colgroup>
<thead>
<tr>
<th><strong>故障现象</strong></th>
<th><strong>可能原因</strong></th>
<th><strong>排查方法</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>页面加载缓慢</td>
<td>服务响应时间长、数据库查询慢、网络延迟高</td>
<td>检查响应时间指标，分析慢查询日志，验证网络延迟和丢包。</td>
</tr>
<tr>
<td>HTTP 500 错误</td>
<td>服务端代码错误、资源耗尽、依赖服务不可用</td>
<td>查看应用日志中的异常堆栈，检查系统资源使用率，验证外部依赖服务状态。</td>
</tr>
<tr>
<td>HTTP 503 错误</td>
<td>服务过载或正在维护</td>
<td>检查系统资源使用情况，查看调用日志是否有过载信息，确认流量是否超出服务能力。</td>
</tr>
<tr>
<td>HTTP 404 错误</td>
<td>请求资源不存在</td>
<td>查看客户端请求路径是否正确，分析应用日志是否有未处理的资源。</td>
</tr>
<tr>
<td>无法连接服务</td>
<td>网络中断、DNS 解析失败、服务未启动</td>
<td>检查网络流日志，测试目标服务连接状态，验证 DNS 解析。</td>
</tr>
<tr>
<td>请求被中断或取消</td>
<td>客户端刷新、网络不稳定</td>
<td>查看客户端错误日志，分析网络连接稳定性。</td>
</tr>
</tbody>
</table>
<h3 id="整体流程总结">7. 整体流程总结</h3>
<ol type="1">
<li><strong>确认现象</strong>：收集用户反馈，划定问题范围。</li>
<li><strong>应用层分析</strong>：查看应用日志，确认是否存在服务端或客户端错误。</li>
<li><strong>服务层分析</strong>：检查服务调用链，验证依赖服务健康状态。</li>
<li><strong>网络层分析</strong>：通过流日志和网络指标，排查连接和链路问题。</li>
<li><strong>综合定位</strong>：结合日志、指标和用户反馈，确认根因并制定修复方案。</li>
</ol>
<p>通过系统性的排查方法，可以快速定位故障的来源并采取对应的解决措施。</p>
<h1 id="应用请求关联指标的排查-1">4.2 应用请求关联指标的排查</h1>
<p>应用请求关联指标可以帮助我们深入了解系统性能、稳定性和用户体验。通过对这些指标的分析，可以快速定位问题并采取相应的改进措施。以下是针对关键指标的详细排查方法。</p>
<h2 id="响应时间-1">4.2.1 响应时间</h2>
<h3 id="慢请求分析">慢请求分析</h3>
<p><strong>目标</strong>：识别导致应用响应时间过长的原因，优化用户体验。</p>
<p><strong>步骤</strong>：</p>
<ol type="1">
<li><strong>数据收集</strong>：
<ul>
<li>使用性能监控工具（如 APM）收集请求的响应时间数据。</li>
<li>记录平均响应时间、P95、P99 等关键指标。</li>
</ul></li>
<li><strong>确定慢请求阈值</strong>：
<ul>
<li>根据业务需求设定响应时间的阈值（例如，超过 2 秒即为慢请求）。</li>
</ul></li>
<li><strong>筛选慢请求</strong>：
<ul>
<li>从日志和监控数据中提取超过阈值的请求列表。</li>
</ul></li>
<li><strong>分析慢请求原因</strong>：
<ul>
<li><strong>代码效率</strong>：检查是否存在低效的算法或冗余的逻辑。</li>
<li><strong>数据库性能</strong>：查看是否有慢查询，检查索引是否缺失或未被利用。</li>
<li><strong>网络延迟</strong>：评估网络传输时间，检查是否有带宽或延迟问题。</li>
<li><strong>资源竞争</strong>：确认是否存在线程阻塞、锁竞争等问题。</li>
</ul></li>
</ol>
<p><strong>解决方案</strong>：</p>
<ul>
<li>优化代码逻辑，减少不必要的计算和 I/O 操作。</li>
<li>优化数据库查询，添加必要的索引，避免全表扫描。</li>
<li>使用 CDN、缓存等技术减少网络延迟。</li>
<li>引入异步处理和队列，避免阻塞主线程。</li>
</ul>
<h3 id="依赖服务性能">依赖服务性能</h3>
<p><strong>目标</strong>：确保应用所依赖的外部服务（如数据库、缓存、第三方
API）运行正常。</p>
<p><strong>步骤</strong>：</p>
<ol type="1">
<li><strong>监控依赖服务的性能指标</strong>：
<ul>
<li>数据库连接数、查询响应时间、锁等待时间等。</li>
<li>缓存的命中率、读写延迟。</li>
<li>第三方 API 的响应时间和错误率。</li>
</ul></li>
<li><strong>分析性能瓶颈</strong>：
<ul>
<li>确认是否因依赖服务的性能问题导致应用响应时间变长。</li>
<li>检查网络连接是否稳定，带宽是否充足。</li>
</ul></li>
<li><strong>排查服务异常</strong>：
<ul>
<li>查看依赖服务的日志，确认是否有错误或警告。</li>
<li>检查服务是否达到容量上限，需要扩容或优化。</li>
</ul></li>
</ol>
<p><strong>解决方案</strong>：</p>
<ul>
<li>优化依赖服务的配置，如增加数据库连接池大小。</li>
<li>使用本地缓存或异步调用，减少对外部服务的依赖。</li>
<li>与第三方服务提供商协商，提升服务质量或寻找替代方案。</li>
</ul>
<h2 id="错误率-1">4.2.2 错误率</h2>
<h3 id="服务端异常-vs-客户端异常">服务端异常 vs 客户端异常</h3>
<p><strong>目标</strong>：区分错误来源，以便采取针对性的解决措施。</p>
<p><strong>服务端异常（5xx）</strong>：</p>
<ul>
<li><strong>特征</strong>：服务器内部错误，无法完成请求。</li>
<li><strong>常见原因</strong>：
<ul>
<li>代码异常（如空指针、类型转换错误）。</li>
<li>资源耗尽（如内存泄漏、线程池耗尽）。</li>
<li>依赖服务不可用（如数据库宕机）。</li>
</ul></li>
</ul>
<p><strong>客户端异常（4xx）</strong>：</p>
<ul>
<li><strong>特征</strong>：请求有误，服务器拒绝处理。</li>
<li><strong>常见原因</strong>：
<ul>
<li>请求参数不合法（缺少必填字段、格式错误）。</li>
<li>认证失败（未授权访问、Token 过期）。</li>
<li>资源不存在（请求的 URL 错误或资源被删除）。</li>
</ul></li>
</ul>
<p><strong>排查方法</strong>：</p>
<ol type="1">
<li><strong>收集和分类错误日志</strong>：
<ul>
<li>按照状态码和错误类型分类统计。</li>
</ul></li>
<li><strong>分析错误模式</strong>：
<ul>
<li>如果 5xx 错误率高，重点检查服务器端问题。</li>
<li>如果 4xx 错误率高，可能需要改进客户端请求或 API 文档。</li>
</ul></li>
<li><strong>复现问题场景</strong>：
<ul>
<li>根据日志信息，尝试在测试环境中复现错误。</li>
</ul></li>
</ol>
<p><strong>解决方案</strong>：</p>
<ul>
<li>修复代码中的异常处理逻辑，增加健壮性。</li>
<li>提供详细的 API 文档，指导客户端正确使用。</li>
<li>实现参数校验，及时返回友好的错误信息。</li>
</ul>
<h3 id="http-状态码分析">HTTP 状态码分析</h3>
<p><strong>目标</strong>：通过分析 HTTP
状态码，了解系统运行状况和潜在问题。</p>
<p><strong>常见状态码</strong>：</p>
<ul>
<li><strong>2xx（成功）</strong>：
<ul>
<li><strong>200 OK</strong>：请求成功，返回预期结果。</li>
<li><strong>201 Created</strong>：资源成功创建。</li>
</ul></li>
<li><strong>3xx（重定向）</strong>：
<ul>
<li><strong>301 Moved Permanently</strong>：资源永久移动。</li>
<li><strong>302 Found</strong>：资源临时移动。</li>
</ul></li>
<li><strong>4xx（客户端错误）</strong>：
<ul>
<li><strong>400 Bad Request</strong>：请求格式错误。</li>
<li><strong>401 Unauthorized</strong>：未授权，需要身份验证。</li>
<li><strong>403 Forbidden</strong>：服务器理解请求但拒绝执行。</li>
<li><strong>404 Not Found</strong>：请求的资源不存在。</li>
</ul></li>
<li><strong>5xx（服务器错误）</strong>：
<ul>
<li><strong>500 Internal Server Error</strong>：服务器内部错误。</li>
<li><strong>502 Bad Gateway</strong>：网关或代理收到无效响应。</li>
<li><strong>503 Service
Unavailable</strong>：服务器暂时过载或维护。</li>
</ul></li>
</ul>
<p><strong>分析步骤</strong>：</p>
<ol type="1">
<li><strong>统计各状态码的出现频率和比例</strong>。</li>
<li><strong>识别异常高的状态码</strong>：
<ul>
<li>如果 <strong>4xx</strong> 错误率高，检查客户端请求是否正确。</li>
<li>如果 <strong>5xx</strong> 错误率高，检查服务器端是否有异常。</li>
</ul></li>
<li><strong>深入分析具体错误</strong>：
<ul>
<li>查看对应的错误日志和请求参数。</li>
<li>确定错误发生的时间和频率。</li>
</ul></li>
</ol>
<p><strong>解决方案</strong>：</p>
<ul>
<li>针对高频错误，优化代码和配置，减少错误发生。</li>
<li>改进错误处理机制，提供更详细的错误信息。</li>
<li>定期审查和更新 API 文档，帮助客户端正确调用。</li>
</ul>
<h2 id="系统资源使用率-1">4.2.3 系统资源使用率</h2>
<h3 id="cpu-和内存监控">CPU 和内存监控</h3>
<p><strong>目标</strong>：确保系统有足够的计算和存储资源，防止性能下降或服务中断。</p>
<p><strong>监控内容</strong>：</p>
<ul>
<li><strong>CPU 使用率</strong>：
<ul>
<li>总体 CPU 占用率，单个进程的 CPU 占用。</li>
<li>线程数，线程的运行状态。</li>
</ul></li>
<li><strong>内存使用率</strong>：
<ul>
<li>总体内存占用，堆内存和非堆内存的使用情况。</li>
<li>垃圾回收频率和停顿时间（对于 JVM）。</li>
</ul></li>
</ul>
<p><strong>排查步骤</strong>：</p>
<ol type="1">
<li><strong>设置资源使用的警戒线</strong>：
<ul>
<li>如 CPU 使用率超过 80%，内存使用率超过 70%。</li>
</ul></li>
<li><strong>实时监控和报警</strong>：
<ul>
<li>使用监控工具（如 Prometheus、Zabbix）设置报警规则。</li>
</ul></li>
<li><strong>分析资源消耗来源</strong>：
<ul>
<li>查找高 CPU 或内存消耗的线程或进程。</li>
<li>使用性能分析工具（如 jstack、jmap）获取线程堆栈和内存快照。</li>
</ul></li>
</ol>
<p><strong>解决方案</strong>：</p>
<ul>
<li>优化算法和代码逻辑，减少不必要的计算。</li>
<li>增加服务器资源，或进行负载均衡和集群部署。</li>
<li>调整 JVM 参数，优化垃圾回收机制。</li>
</ul>
<h3 id="资源泄漏检测">资源泄漏检测</h3>
<p><strong>目标</strong>：发现并修复程序中未正确释放的资源，防止长期运行导致的资源耗尽。</p>
<p><strong>常见的资源泄漏类型</strong>：</p>
<ul>
<li>内存泄漏：对象未被回收，导致内存占用不断增加。</li>
<li>连接泄漏：数据库连接、网络连接未关闭。</li>
<li>句柄泄漏：文件句柄、线程未正确释放。</li>
</ul>
<p><strong>检测方法</strong>：</p>
<ol type="1">
<li><strong>监控资源使用的增长趋势</strong>：
<ul>
<li>如果资源使用率持续增长，且无法下降，可能存在泄漏。</li>
</ul></li>
<li><strong>使用分析工具</strong>：
<ul>
<li><strong>内存泄漏</strong>：使用内存分析工具（如
MAT、VisualVM）生成堆转储，分析对象引用。</li>
<li><strong>连接泄漏</strong>：检查连接池的活跃连接数，是否达到上限。</li>
</ul></li>
<li><strong>代码审查</strong>：
<ul>
<li>检查代码中是否有未关闭的资源，特别是在异常处理和多线程场景下。</li>
</ul></li>
</ol>
<p><strong>解决方案</strong>：</p>
<ul>
<li>在代码中确保资源在使用完毕后被正确关闭（如使用
<code>try-finally</code> 或 <code>try-with-resources</code>）。</li>
<li>使用连接池和资源池，统一管理资源的创建和销毁。</li>
<li>定期重启服务作为临时措施，但应尽快修复根本问题。</li>
</ul>
<h2 id="用户留存率-1">4.2.4 用户留存率</h2>
<h3 id="用户行为分析">用户行为分析</h3>
<p><strong>目标</strong>：通过分析用户的使用习惯和行为，提升用户满意度和产品竞争力。</p>
<p><strong>关键指标</strong>：</p>
<ul>
<li><strong>DAU（每日活跃用户数）</strong>、<strong>MAU（月活跃用户数）</strong>。</li>
<li><strong>用户留存率</strong>：新用户在一段时间后继续使用产品的比例。</li>
<li><strong>用户流失率</strong>：在一定时间内停止使用产品的用户比例。</li>
</ul>
<p><strong>分析步骤</strong>：</p>
<ol type="1">
<li><strong>收集用户行为数据</strong>：
<ul>
<li>用户登录、访问页面、使用功能等行为日志。</li>
</ul></li>
<li><strong>构建用户行为模型</strong>：
<ul>
<li>细分用户群体，分析不同群体的行为特征。</li>
</ul></li>
<li><strong>识别影响留存率的因素</strong>：
<ul>
<li>复杂的操作流程。</li>
<li>功能不符合用户需求。</li>
<li>竞争产品的影响。</li>
</ul></li>
</ol>
<p><strong>解决方案</strong>：</p>
<ul>
<li>优化产品功能和用户体验，降低使用门槛。</li>
<li>推出个性化推荐和定制服务，满足用户需求。</li>
<li>实施用户激励机制，如积分、优惠券等。</li>
</ul>
<h3 id="功能可用性检查">功能可用性检查</h3>
<p><strong>目标</strong>：确保应用的核心功能在任何时候都可用，提升用户满意度。</p>
<p><strong>检查内容</strong>：</p>
<ul>
<li><strong>功能完整性</strong>：所有功能是否按预期工作。</li>
<li><strong>功能稳定性</strong>：功能在不同环境和负载下的表现。</li>
<li><strong>功能易用性</strong>：用户是否容易理解和使用功能。</li>
</ul>
<p><strong>排查步骤</strong>：</p>
<ol type="1">
<li><strong>建立功能测试用例</strong>：
<ul>
<li>覆盖核心业务流程和边界条件。</li>
</ul></li>
<li><strong>定期执行自动化测试</strong>：
<ul>
<li>使用测试框架（如 Selenium、Appium）进行回归测试。</li>
</ul></li>
<li><strong>收集用户反馈</strong>：
<ul>
<li>通过客服、用户评论等渠道了解用户对功能的评价。</li>
</ul></li>
</ol>
<p><strong>解决方案</strong>：</p>
<ul>
<li>及时修复功能缺陷，优化用户操作流程。</li>
<li>提供帮助文档和指导，引导用户使用新功能。</li>
<li>持续监控功能使用情况，进行迭代改进。</li>
</ul>
<h2 id="吞吐量-1">4.2.5 吞吐量</h2>
<h3 id="负载测试">负载测试</h3>
<p><strong>目标</strong>：评估系统在高并发访问下的性能，找出潜在的瓶颈。</p>
<p><strong>测试流程</strong>：</p>
<ol type="1">
<li><strong>制定测试计划</strong>：
<ul>
<li>明确测试目标、范围和指标（如 QPS、响应时间、错误率）。</li>
</ul></li>
<li><strong>设计测试场景</strong>：
<ul>
<li>模拟真实用户行为，包括不同的请求类型和比例。</li>
</ul></li>
<li><strong>选择测试工具</strong>：
<ul>
<li>使用 JMeter、LoadRunner、Locust 等。</li>
</ul></li>
<li><strong>执行测试</strong>：
<ul>
<li>从低到高逐步增加负载，观察系统的性能变化。</li>
</ul></li>
<li><strong>分析测试结果</strong>：
<ul>
<li>确定系统的最大吞吐量和瓶颈所在。</li>
</ul></li>
</ol>
<p><strong>解决方案</strong>：</p>
<ul>
<li>优化代码和数据库查询，提高处理效率。</li>
<li>使用缓存、异步处理等技术减轻服务器压力。</li>
<li>进行水平扩展，增加服务器节点，实现负载均衡。</li>
</ul>
<h3 id="扩展能力评估">扩展能力评估</h3>
<p><strong>目标</strong>：确保系统能够随着业务增长而平滑扩展，满足未来需求。</p>
<p><strong>评估内容</strong>：</p>
<ul>
<li><strong>架构可扩展性</strong>：系统是否易于添加新功能和模块。</li>
<li><strong>性能可扩展性</strong>：能否通过增加资源来提升性能。</li>
<li><strong>数据可扩展性</strong>：能否处理不断增长的数据量。</li>
</ul>
<p><strong>评估步骤</strong>：</p>
<ol type="1">
<li><strong>分析当前架构</strong>：
<ul>
<li>识别单点瓶颈和耦合点。</li>
</ul></li>
<li><strong>设计扩展方案</strong>：
<ul>
<li>考虑使用微服务、分布式架构等。</li>
</ul></li>
<li><strong>验证扩展能力</strong>：
<ul>
<li>进行扩展性测试，模拟业务增长场景。</li>
</ul></li>
</ol>
<p><strong>解决方案</strong>：</p>
<ul>
<li>重构系统架构，拆分单体应用为微服务。</li>
<li>使用云服务和容器化技术，实现弹性扩展。</li>
<li>引入分布式缓存、消息队列等中间件，提升系统吞吐量。</li>
</ul>
<hr />
<p>通过对上述指标的分析和排查，可以全面了解应用的运行状况，及时发现和解决问题，保障系统的稳定性和用户满意度。定期监控和优化这些关键指标，对于持续提升应用性能和竞争力至关重要。</p>
<h1 id="网络关键指标的排查-1">4.3 网络关键指标的排查</h1>
<p>在网络性能和可靠性方面，关键指标的监控和分析至关重要。通过对这些指标的深入了解和排查，可以有效提升网络服务质量，确保应用系统的稳定运行。以下是优先级最高的网络指标，这些指标直接影响应用的可用性、性能和用户体验，适合在网络性能优化中重点关注：</p>
<table>
<colgroup>
<col style="width: 13%" />
<col style="width: 32%" />
<col style="width: 46%" />
<col style="width: 7%" />
</colgroup>
<thead>
<tr>
<th><strong>指标</strong></th>
<th><strong>定义</strong></th>
<th><strong>重要性</strong></th>
<th><strong>优先级</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>延迟</strong></td>
<td>数据包从源到目的地传输所需的时间。</td>
<td>高延迟会影响实时应用（如视频会议、在线游戏）以及 API
的响应速度。</td>
<td>高</td>
</tr>
<tr>
<td><strong>丢包率</strong></td>
<td>传输中丢失数据包的比例。</td>
<td>高丢包率会导致重传或数据丢失，影响应用性能和用户体验。</td>
<td>高</td>
</tr>
<tr>
<td><strong>带宽利用率</strong></td>
<td>网络已使用带宽占总带宽的百分比。</td>
<td>带宽不足可能导致网络拥塞，带宽利用率低可能是资源浪费的信号。</td>
<td>中等</td>
</tr>
<tr>
<td><strong>网络抖动</strong></td>
<td>连续数据包之间延迟的变化幅度。</td>
<td>高抖动会对实时服务（如 VoIP
和视频流）造成明显影响，可能导致卡顿或失真。</td>
<td>中等</td>
</tr>
<tr>
<td><strong>网络可用性</strong></td>
<td>网络在特定时间内可正常运行的比例。</td>
<td>网络中断会导致服务不可用，对高可靠性应用影响严重。</td>
<td>高</td>
</tr>
<tr>
<td><strong>重传率</strong></td>
<td>因丢包或错误而需要重传的数据包比例。</td>
<td>重传增加了网络负载，降低了传输效率，可能进一步加剧延迟和拥塞。</td>
<td>中等</td>
</tr>
<tr>
<td><strong>TCP 连接时间</strong></td>
<td>建立 TCP 连接所需的时间。</td>
<td>长连接时间会影响首次请求的响应速度，特别是需要频繁建立连接的应用。</td>
<td>中等</td>
</tr>
<tr>
<td><strong>DNS 查询时间</strong></td>
<td>域名解析到 IP 地址所需的时间。</td>
<td>慢速的 DNS 查询会延长应用的请求启动时间，影响整体性能。</td>
<td>中等</td>
</tr>
<tr>
<td><strong>HTTP 请求成功率</strong></td>
<td>成功的 HTTP 请求占总请求的比例。</td>
<td>HTTP 请求失败会直接导致功能不可用或用户体验下降。</td>
<td>高</td>
</tr>
</tbody>
</table>
<p>以下是对这些关键网络指标的详细分析和排查方法。</p>
<h2 id="带宽利用率-1">4.3.1 带宽利用率</h2>
<h3 id="流量监控">流量监控</h3>
<p><strong>目标</strong>：实时监控网络带宽的使用情况，确保网络资源被合理利用，避免带宽瓶颈。</p>
<p><strong>步骤</strong>：</p>
<ol type="1">
<li><strong>收集流量数据</strong>：
<ul>
<li>使用网络监控工具（如 NetFlow、sFlow）收集网络接口的流量信息。</li>
<li>记录每个接口的入站和出站流量，统计带宽利用率。</li>
</ul></li>
<li><strong>分析带宽使用趋势</strong>：
<ul>
<li>观察带宽利用率的变化趋势，识别高峰时段。</li>
<li>对比历史数据，判断是否存在异常增长。</li>
</ul></li>
<li><strong>识别主要流量来源</strong>：
<ul>
<li>确定哪些应用、服务或用户消耗了大量带宽。</li>
<li>分析流量协议和目的地址，了解流量类型。</li>
</ul></li>
</ol>
<p><strong>解决方案</strong>：</p>
<ul>
<li><strong>优化流量分配</strong>：根据业务优先级，调整带宽分配策略，确保关键业务的带宽需求。</li>
<li><strong>升级带宽</strong>：如果带宽长期接近饱和，考虑升级网络带宽。</li>
<li><strong>流量压缩和优化</strong>：采用压缩技术或协议优化，减少带宽消耗。</li>
</ul>
<h3 id="异常流量检测">异常流量检测</h3>
<p><strong>目标</strong>：及时发现和处理异常流量，防止网络拥塞和安全问题。</p>
<p><strong>步骤</strong>：</p>
<ol type="1">
<li><strong>设定基线</strong>：
<ul>
<li>建立正常情况下的流量模型，包括流量大小、协议分布等。</li>
</ul></li>
<li><strong>实时监控</strong>：
<ul>
<li>使用入侵检测系统（IDS）或防火墙监控异常流量。</li>
</ul></li>
<li><strong>识别异常行为</strong>：
<ul>
<li>突发的大流量：可能是 DDoS 攻击或病毒传播。</li>
<li>非法协议或端口：可能是未授权的访问或攻击尝试。</li>
</ul></li>
</ol>
<p><strong>解决方案</strong>：</p>
<ul>
<li><strong>阻断异常流量</strong>：使用防火墙规则或流量清洗设备阻断攻击流量。</li>
<li><strong>安全审计</strong>：检查系统和应用的安全漏洞，更新安全补丁。</li>
<li><strong>告警机制</strong>：建立实时告警，及时通知管理员处理。</li>
</ul>
<h2 id="延迟-1">4.3.2 延迟</h2>
<h3 id="网络路径优化">网络路径优化</h3>
<p><strong>目标</strong>：降低网络延迟，提高数据传输效率，提升用户体验。</p>
<p><strong>步骤</strong>：</p>
<ol type="1">
<li><strong>测量延迟</strong>：
<ul>
<li>使用 <code>ping</code>、<code>traceroute</code>
等工具测量从源到目的地的延迟。</li>
<li>记录往返时间（RTT），分析延迟变化。</li>
</ul></li>
<li><strong>分析路径</strong>：
<ul>
<li>查看数据包经过的路由节点，识别延迟较高的节点或段。</li>
</ul></li>
<li><strong>优化路径</strong>：
<ul>
<li>调整路由策略，选择延迟更低的路径。</li>
<li>使用 MPLS、SD-WAN 等技术实现智能选路。</li>
</ul></li>
</ol>
<p><strong>解决方案</strong>：</p>
<ul>
<li><strong>内容分发网络（CDN）</strong>：将内容缓存到离用户更近的节点，减少传输距离。</li>
<li><strong>就近接入</strong>：在多个地区部署服务节点，实现本地化访问。</li>
<li><strong>网络服务提供商合作</strong>：与 ISP
协商，优化跨网传输路径。</li>
</ul>
<h3 id="地理位置影响">地理位置影响</h3>
<p><strong>目标</strong>：理解地理位置对网络延迟的影响，针对性地优化跨地域通信。</p>
<p><strong>分析</strong>：</p>
<ul>
<li><strong>物理距离</strong>：数据传输速度受限于光速，物理距离越远，延迟越高。</li>
<li><strong>跨国连接</strong>：国际出口带宽有限，可能存在拥塞或政策限制。</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li><strong>全球加速服务</strong>：使用云服务提供商的全球加速产品。</li>
<li><strong>区域性部署</strong>：在用户集中的地区部署数据中心或边缘节点。</li>
<li><strong>协议优化</strong>：使用加速协议（如 TCP Fast
Open）减少握手时间。</li>
</ul>
<h2 id="丢包率-1">4.3.3 丢包率</h2>
<h3 id="链路质量">链路质量</h3>
<p><strong>目标</strong>：确保网络链路的可靠性，降低数据包丢失率。</p>
<p><strong>步骤</strong>：</p>
<ol type="1">
<li><strong>监测丢包率</strong>：
<ul>
<li>使用 <code>ping</code> 命令发送多个 ICMP 包，统计丢包率。</li>
<li>使用网络监控工具记录数据包传输情况。</li>
</ul></li>
<li><strong>分析链路状态</strong>：
<ul>
<li>确定丢包发生的节点或链路段。</li>
<li>检查网络设备的错误统计信息（如接口错误、碰撞）。</li>
</ul></li>
</ol>
<p><strong>解决方案</strong>：</p>
<ul>
<li><strong>更换或修复故障链路</strong>：对于物理损坏的线路，及时维修。</li>
<li><strong>提高链路冗余</strong>：采用链路聚合或备用路径，防止单点故障。</li>
<li><strong>调整网络参数</strong>：优化 MTU
值，避免分片导致的丢包。</li>
</ul>
<h3 id="设备故障排查">设备故障排查</h3>
<p><strong>目标</strong>：检查网络设备的健康状况，排除因设备故障导致的丢包。</p>
<p><strong>步骤</strong>：</p>
<ol type="1">
<li><strong>设备日志检查</strong>：
<ul>
<li>查看交换机、路由器、防火墙等设备的系统日志。</li>
<li>关注错误信息、异常重启、端口状态等。</li>
</ul></li>
<li><strong>接口状态检查</strong>：
<ul>
<li>检查网络接口的状态，是否有频繁的 up/down 变化。</li>
<li>查看接口的错误计数器，如 CRC 错误、帧错误。</li>
</ul></li>
<li><strong>固件和配置</strong>：
<ul>
<li>确认设备固件是否需要更新，配置是否正确。</li>
</ul></li>
</ol>
<p><strong>解决方案</strong>：</p>
<ul>
<li><strong>更换故障设备</strong>：对于无法修复的设备，及时更换。</li>
<li><strong>更新固件</strong>：升级设备固件，修复已知问题。</li>
<li><strong>优化配置</strong>：调整设备配置，避免资源耗尽或冲突。</li>
</ul>
<h2 id="网络抖动-1">4.3.4 网络抖动</h2>
<h3 id="实时应用影响">实时应用影响</h3>
<p><strong>目标</strong>：降低网络抖动对实时应用（如
VoIP、视频会议）的影响，保证服务质量。</p>
<p><strong>分析</strong>：</p>
<ul>
<li><strong>网络抖动</strong>：指数据包到达时间的变动性，过高的抖动会导致音视频卡顿。</li>
<li><strong>实时应用敏感性</strong>：实时应用对延迟和抖动要求较高。</li>
</ul>
<p><strong>检测方法</strong>：</p>
<ul>
<li>使用专用工具（如 iperf）测量网络抖动。</li>
<li>监控实时应用的质量指标（如 MOS 分数）。</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li><strong>QoS
策略</strong>：配置服务质量策略，为实时流量设置优先级。</li>
<li><strong>带宽保障</strong>：预留带宽，防止其他流量挤占资源。</li>
<li><strong>缓冲机制</strong>：在应用层增加缓冲，平滑抖动影响。</li>
</ul>
<h3 id="网络稳定性提升">网络稳定性提升</h3>
<p><strong>目标</strong>：通过网络优化，提高整体网络的稳定性，减少抖动。</p>
<p><strong>措施</strong>：</p>
<ul>
<li><strong>消除网络瓶颈</strong>：升级过载的网络设备或链路。</li>
<li><strong>减少网络层次</strong>：简化网络拓扑，降低转发延迟。</li>
<li><strong>使用稳定的传输介质</strong>：优先采用光纤等高质量链路。</li>
</ul>
<h2 id="网络可用性-1">4.3.5 网络可用性</h2>
<h3 id="冗余设计">冗余设计</h3>
<p><strong>目标</strong>：通过冗余设计，提升网络的可靠性，防止单点故障。</p>
<p><strong>策略</strong>：</p>
<ul>
<li><strong>链路冗余</strong>：使用双上行链路、环形拓扑等设计，保证链路故障时有备用路径。</li>
<li><strong>设备冗余</strong>：部署冗余的核心交换机、路由器，实现设备级备份。</li>
<li><strong>多数据中心</strong>：在不同区域部署数据中心，实现业务容灾。</li>
</ul>
<p><strong>实现方法</strong>：</p>
<ul>
<li><strong>协议支持</strong>：使用 STP、VRRP、HSRP
等协议，实现冗余切换。</li>
<li><strong>负载均衡</strong>：采用负载均衡设备，分摊流量，提升可用性。</li>
</ul>
<h3 id="故障切换机制">故障切换机制</h3>
<p><strong>目标</strong>：确保在故障发生时，系统能够自动切换到备用路径或设备，最小化服务中断。</p>
<p><strong>步骤</strong>：</p>
<ol type="1">
<li><strong>配置故障检测</strong>：
<ul>
<li>设置心跳检测，实时监控设备和链路状态。</li>
</ul></li>
<li><strong>设定切换条件</strong>：
<ul>
<li>明确何时触发切换，如连续心跳失败次数。</li>
</ul></li>
<li><strong>测试切换流程</strong>：
<ul>
<li>定期演练故障切换，确保机制有效。</li>
</ul></li>
</ol>
<p><strong>解决方案</strong>：</p>
<ul>
<li><strong>自动化切换</strong>：使用网络协议自动完成故障切换，无需人工干预。</li>
<li><strong>快速收敛</strong>：优化路由协议参数，减少切换时间。</li>
</ul>
<h2 id="重传率-1">4.3.6 重传率</h2>
<h3 id="拥塞控制">拥塞控制</h3>
<p><strong>目标</strong>：通过拥塞控制，降低数据包重传率，提升网络效率。</p>
<p><strong>分析</strong>：</p>
<ul>
<li><strong>高重传率原因</strong>：网络拥塞、丢包导致发送端重新发送数据。</li>
<li><strong>影响</strong>：增加网络负载，降低传输效率。</li>
</ul>
<p><strong>措施</strong>：</p>
<ul>
<li><strong>调整窗口大小</strong>：优化 TCP
的拥塞窗口，避免发送过多数据导致拥塞。</li>
<li><strong>主动队列管理（AQM）</strong>：在路由器中使用 RED、ECN
等机制，预防拥塞。</li>
</ul>
<h3 id="传输优化">传输优化</h3>
<p><strong>目标</strong>：优化传输协议和参数，减少重传，提升传输性能。</p>
<p><strong>策略</strong>：</p>
<ul>
<li><strong>使用高效协议</strong>：如在高延迟网络中使用 QUIC 协议。</li>
<li><strong>协议参数优化</strong>：调整 TCP
的超时时间、重传次数等参数。</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li><strong>传输压缩</strong>：压缩数据，提高传输效率。</li>
<li><strong>流控机制</strong>：根据接收端的处理能力，调整发送速率。</li>
</ul>
<h2 id="tcp-连接时间-1">4.3.7 TCP 连接时间</h2>
<h3 id="握手延迟分析">握手延迟分析</h3>
<p><strong>目标</strong>：降低 TCP
连接建立的时间，提升用户访问速度。</p>
<p><strong>分析</strong>：</p>
<ul>
<li><strong>三次握手</strong>：TCP
连接需要进行三次握手，延迟会累积。</li>
<li><strong>延迟因素</strong>：网络延迟、服务器响应时间。</li>
</ul>
<p><strong>检测方法</strong>：</p>
<ul>
<li>使用抓包工具，测量 SYN、SYN-ACK、ACK 包的时间间隔。</li>
<li>分析握手过程中是否有重传或超时。</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li><strong>TCP Fast
Open</strong>：减少握手次数，缩短连接建立时间。</li>
<li><strong>保持连接</strong>：使用长连接（如
HTTP/2），减少重复握手。</li>
</ul>
<h3 id="服务器性能">服务器性能</h3>
<p><strong>目标</strong>：提升服务器处理连接的能力，避免成为瓶颈。</p>
<p><strong>措施</strong>：</p>
<ul>
<li><strong>优化系统参数</strong>：调整服务器的最大连接数、半连接队列长度等参数。</li>
<li><strong>升级硬件</strong>：提高
CPU、内存等资源，满足高并发需求。</li>
<li><strong>负载均衡</strong>：分摊连接请求，防止单台服务器过载。</li>
</ul>
<h2 id="dns-查询时间-1">4.3.8 DNS 查询时间</h2>
<h3 id="dns-服务优化">DNS 服务优化</h3>
<p><strong>目标</strong>：降低 DNS 查询时间，加快域名解析速度。</p>
<p><strong>措施</strong>：</p>
<ol type="1">
<li><strong>本地部署 DNS 服务器</strong>：
<ul>
<li>搭建本地 DNS 解析服务器，减少查询跳数。</li>
</ul></li>
<li><strong>优化 DNS 配置</strong>：
<ul>
<li>使用权威 DNS 服务器，减少递归查询。</li>
</ul></li>
<li><strong>提高 DNS 服务器性能</strong>：
<ul>
<li>增加服务器带宽和处理能力，缩短响应时间。</li>
</ul></li>
</ol>
<h3 id="缓存策略">缓存策略</h3>
<p><strong>目标</strong>：通过缓存机制，加快 DNS
解析，提高查询效率。</p>
<p><strong>策略</strong>：</p>
<ul>
<li><strong>客户端缓存</strong>：浏览器和操作系统层面的 DNS 缓存。</li>
<li><strong>网络缓存</strong>：在网络设备（如路由器）中启用 DNS
缓存。</li>
<li><strong>TTL 设置</strong>：适当延长 DNS 记录的
TTL，减少重复查询。</li>
</ul>
<p><strong>注意事项</strong>：</p>
<ul>
<li><strong>缓存一致性</strong>：在 DNS
记录变更时，需考虑缓存的影响，避免解析错误。</li>
<li><strong>安全性</strong>：防止缓存中毒，使用 DNSSEC 等安全措施。</li>
</ul>
<h2 id="http-请求成功率-1">4.3.9 HTTP 请求成功率</h2>
<h3 id="服务器健康检查">服务器健康检查</h3>
<p><strong>目标</strong>：确保服务器运行正常，提升 HTTP
请求的成功率。</p>
<p><strong>措施</strong>：</p>
<ol type="1">
<li><strong>定期检测</strong>：
<ul>
<li>使用监控工具，定期检查服务器的状态和响应。</li>
</ul></li>
<li><strong>健康检查接口</strong>：
<ul>
<li>开发专用的健康检查接口，返回服务器运行状态。</li>
</ul></li>
<li><strong>日志分析</strong>：
<ul>
<li>分析服务器日志，发现异常请求和错误码。</li>
</ul></li>
</ol>
<p><strong>解决方案</strong>：</p>
<ul>
<li><strong>自动重启服务</strong>：在检测到异常时，自动重启服务或切换到备用服务器。</li>
<li><strong>容量规划</strong>：根据负载，及时扩容，防止服务器过载。</li>
</ul>
<h3 id="网络异常处理">网络异常处理</h3>
<p><strong>目标</strong>：处理网络异常情况，确保 HTTP
请求的可靠传输。</p>
<p><strong>措施</strong>：</p>
<ul>
<li><strong>重试机制</strong>：在请求失败时，客户端或中间件自动重试。</li>
<li><strong>超时设置</strong>：合理设置请求和连接的超时时间，避免长时间等待。</li>
<li><strong>错误处理</strong>：在网络异常时，提供友好的错误提示和应急措施。</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li><strong>使用可靠的传输协议</strong>：如启用 HTTP/2
的多路复用，减少连接数量。</li>
<li><strong>负载均衡和容错</strong>：通过负载均衡器，自动将请求路由到健康的服务器。</li>
</ul>
<h1 id="tcp-传输超时机制整理">TCP 传输超时机制整理</h1>
<h2 id="ms-内没有收到-ack-的场景">300ms 内没有收到 ACK 的场景</h2>
<p>在 TCP 协议中，<strong>300ms内没有收到 ACK</strong>
这种情况通常发生在以下两个阶段之一：<strong>连接建立阶段</strong> 或
<strong>数据传输阶段</strong>。</p>
<hr />
<h3 id="连接建立阶段-connection-establishment-phase">1. 连接建立阶段
(Connection Establishment Phase)</h3>
<h4 id="描述">描述</h4>
<p>这是 TCP 的三次握手过程，用于建立可靠的连接。</p>
<h4 id="ack-的作用">ACK 的作用</h4>
<ul>
<li>在三次握手过程中，每个通信方会使用 <code>SYN</code> 和
<code>ACK</code> 标志来确认连接的进展。</li>
<li>发送端发送 <code>SYN</code> 后，等待接收端返回 <code>SYN+ACK</code>
确认。</li>
<li>如果在 <strong>300ms内未收到
ACK</strong>，发送端会超时重试，直到达到最大重试次数或完全放弃连接。</li>
</ul>
<h4 id="示例流程">示例流程</h4>
<ol type="1">
<li><strong>SYN</strong>：发送方发送 <code>SYN</code>
请求建立连接。</li>
<li><strong>SYN+ACK</strong>：接收方返回 <code>SYN+ACK</code>。</li>
<li><strong>ACK</strong>：发送方确认
<code>ACK</code>，连接建立完成。</li>
</ol>
<h4 id="ms-超时的情况">300ms 超时的情况</h4>
<ul>
<li>如果在第一步或第二步中，<code>SYN</code> 或 <code>SYN+ACK</code>
没有被成功接收或返回，则会进入超时逻辑。</li>
<li>可能原因：
<ul>
<li>网络延迟。</li>
<li>数据包丢失。</li>
<li>目标主机不可达。</li>
</ul></li>
</ul>
<hr />
<h3 id="数据传输阶段-data-transmission-phase">2. 数据传输阶段 (Data
Transmission Phase)</h3>
<h4 id="描述-1">描述</h4>
<p>在连接建立后，双方通过 TCP 数据包进行数据传输，每个数据段都需要 ACK
确认。</p>
<h4 id="ack-的作用-1">ACK 的作用</h4>
<ul>
<li>接收端在成功接收数据包后，发送 ACK
确认包，告知发送端可以发送下一个数据段。</li>
<li>如果发送端在 <strong>300ms内未收到
ACK</strong>，会触发重传机制。</li>
</ul>
<h4 id="示例流程-1">示例流程</h4>
<ol type="1">
<li><strong>发送数据</strong>：发送端发送一个 TCP 数据包。</li>
<li><strong>返回 ACK</strong>：接收端成功接收数据后，返回 ACK
确认。</li>
<li><strong>下一数据段</strong>：发送端收到 ACK
后，发送下一个数据段。</li>
</ol>
<h4 id="ms-超时的情况-1">300ms 超时的情况</h4>
<ul>
<li>如果接收端未能按时发送 ACK，可能导致数据包重传。</li>
<li>可能原因：
<ul>
<li>数据包丢失。</li>
<li>接收端处理延迟。</li>
<li>网络延迟较高或网络抖动。</li>
</ul></li>
</ul>
<hr />
<h3 id="阶段区别总结">3. 阶段区别总结</h3>
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 43%" />
<col style="width: 37%" />
</colgroup>
<thead>
<tr>
<th><strong>阶段</strong></th>
<th><strong>ACK 的作用</strong></th>
<th><strong>300ms 超时的可能性</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>连接建立阶段</strong></td>
<td>确保三次握手成功建立连接</td>
<td>网络延迟、丢包、目标主机不可达。</td>
</tr>
<tr>
<td><strong>数据传输阶段</strong></td>
<td>确认接收数据包，并告知发送端继续发送下一数据段</td>
<td>数据包或 ACK 丢失、接收端延迟、网络抖动。</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="如何应对-300ms-未收到-ack-的情况">如何应对 300ms 未收到 ACK
的情况？</h2>
<h3 id="动态调整-rto重传超时时间">1. 动态调整 RTO（重传超时时间）</h3>
<ul>
<li>RTO 是根据网络条件动态计算的，初始值可能为 300ms。</li>
<li>如果网络较慢，可通过调整参数增大超时时间。</li>
</ul>
<h3 id="tcp-快速重传-fast-retransmit">2. TCP 快速重传 (Fast
Retransmit)</h3>
<ul>
<li>如果发送方收到多个重复的
ACK（表明某些包未达），可能会提前触发重传，而不是等待 RTO 超时。</li>
</ul>
<h3 id="网络优化">3. 网络优化</h3>
<ul>
<li>检查是否存在网络拥塞或丢包，优化网络路径或增加带宽。</li>
</ul>
<hr />
<p>通过对网络关键指标的深入分析和有效排查，可以显著提升网络的性能和可靠性。定期监控这些指标，及时发现并解决问题，对于保障应用系统的正常运行和用户满意度至关重要。</p>
<p>TCP 时延相关指标表</p>
<table>
<colgroup>
<col style="width: 9%" />
<col style="width: 21%" />
<col style="width: 11%" />
<col style="width: 18%" />
<col style="width: 39%" />
</colgroup>
<thead>
<tr>
<th><strong>指标</strong></th>
<th><strong>定义</strong></th>
<th><strong>阶段</strong></th>
<th><strong>影响因素</strong></th>
<th><strong>区别</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>TCP 连接时延</strong></td>
<td>三次握手所需时间</td>
<td>连接建立阶段</td>
<td>网络延迟、服务器响应速度</td>
<td>测量连接建立效率，不涉及后续数据传输。</td>
</tr>
<tr>
<td><strong>RTT</strong></td>
<td>数据包从源到目的地再返回的总时间</td>
<td>全过程</td>
<td>网络物理距离、拥塞</td>
<td>网络底层延迟的综合反映，是其他时延的基础。</td>
</tr>
<tr>
<td><strong>初始时延</strong></td>
<td>从请求到收到首字节的时间（TTFB）</td>
<td>连接建立 + 数据开始</td>
<td>TCP 握手时延、服务器响应</td>
<td>包括了 TCP 握手和服务器处理时间，反映用户可感知的响应延迟。</td>
</tr>
<tr>
<td><strong>数据传输时延</strong></td>
<td>从开始发送到完全接收数据的时间</td>
<td>数据传输阶段</td>
<td>带宽、窗口大小、丢包重传</td>
<td>强调传输阶段性能，与握手阶段无关。</td>
</tr>
<tr>
<td><strong>抖动</strong></td>
<td>数据包到达时间的波动性（Jitter）</td>
<td>全过程</td>
<td>网络稳定性</td>
<td>关注时间一致性，而非单次时延，主要影响实时性要求较高的应用。</td>
</tr>
<tr>
<td><strong>重传时延</strong></td>
<td>因丢包重传导致的额外延迟</td>
<td>数据传输阶段</td>
<td>丢包率、网络质量</td>
<td>表示丢包的代价，直接影响传输性能。</td>
</tr>
<tr>
<td><strong>慢启动时延</strong></td>
<td>TCP 连接初期，数据传输受限所需的时间</td>
<td>数据传输阶段</td>
<td>窗口大小、网络拥塞</td>
<td>仅影响传输初期，与稳定阶段性能无关，适用于大文件传输分析。</td>
</tr>
</tbody>
</table>
<p>TCP 建连异常相关指标表</p>
<table>
<colgroup>
<col style="width: 10%" />
<col style="width: 23%" />
<col style="width: 7%" />
<col style="width: 23%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th><strong>指标</strong></th>
<th><strong>定义</strong></th>
<th><strong>异常阶段</strong></th>
<th><strong>常见原因</strong></th>
<th><strong>区别</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>TCP 连接失败率</strong></td>
<td>未完成三次握手的连接比例</td>
<td>全过程</td>
<td>网络丢包、服务器未监听、超时</td>
<td>反映总体连接失败的宏观指标，是性能排查的起点。</td>
</tr>
<tr>
<td><strong>TCP 超时率</strong></td>
<td>建连超时的比例</td>
<td>全过程</td>
<td>高延迟、丢包重传、服务器过载</td>
<td>专注超时问题，通常与网络延迟或服务器负载有关。</td>
</tr>
<tr>
<td><strong>TCP 重试次数</strong></td>
<td>建连中因丢包需要重传的次数</td>
<td>全过程</td>
<td>丢包率高、拥塞、路由问题</td>
<td>表示网络传输可靠性，过高可能导致建连失败或性能下降。</td>
</tr>
<tr>
<td><strong>SYN 丢包率</strong></td>
<td>客户端发送的 SYN 包未收到响应的比例</td>
<td>第一步</td>
<td>链路丢包、防火墙拦截</td>
<td>专注建连的第一步，反映初始连接的成功率。</td>
</tr>
<tr>
<td><strong>SYN-ACK 失败率</strong></td>
<td>服务端返回的 SYN-ACK 包未到达客户端的比例</td>
<td>第二步</td>
<td>服务端丢包、防火墙或 NAT 问题</td>
<td>分析服务端到客户端方向的网络问题。</td>
</tr>
<tr>
<td><strong>RST 包率</strong></td>
<td>建连过程中收到 RST 包的比例</td>
<td>全过程</td>
<td>服务端拒绝连接、防火墙或策略问题</td>
<td>表明服务端主动中断连接，可能涉及配置错误或策略限制。</td>
</tr>
<tr>
<td><strong>建连延迟</strong></td>
<td>完成三次握手的时间</td>
<td>全过程</td>
<td>高 RTT、丢包重传</td>
<td>偏向时延分析，高延迟可能导致连接超时或多次重传。</td>
</tr>
<tr>
<td><strong>拒绝连接率</strong></td>
<td>被服务器拒绝的连接比例</td>
<td>全过程</td>
<td>服务器端口未监听、超出连接限制</td>
<td>表明服务器端主动拒绝连接的情况。</td>
</tr>
<tr>
<td><strong>防火墙拦截率</strong></td>
<td>数据包被防火墙拦截的比例</td>
<td>全过程</td>
<td>防火墙规则错误或策略限制</td>
<td>特指中间设备干预导致的连接失败。</td>
</tr>
<tr>
<td><strong>NAT 超时率</strong></td>
<td>因 NAT 转换失败导致建连异常的比例</td>
<td>全过程</td>
<td>NAT 表溢出、超时配置不当</td>
<td>特指 NAT 相关问题，区别于常规的丢包或超时原因。</td>
</tr>
</tbody>
</table>
<h2 id="tcp-超时类型">TCP 超时类型</h2>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 30%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr>
<th><strong>超时类型 (中文)</strong></th>
<th><strong>状态 (英文)</strong></th>
<th><strong>默认值（Linux）</strong></th>
<th><strong>默认值（Windows）</strong></th>
<th><strong>默认值（macOS）</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>初始 RTO</strong></td>
<td>Initial RTO (Retransmission Timeout)</td>
<td>200ms - 1秒</td>
<td>300ms</td>
<td>1秒</td>
</tr>
<tr>
<td><strong>最大重传超时</strong></td>
<td>Maximum Retransmission Timeout</td>
<td>13-30分钟</td>
<td>240秒</td>
<td>9分钟</td>
</tr>
<tr>
<td><strong>Keepalive 超时</strong></td>
<td>Keepalive Timeout</td>
<td>7200秒（2小时）</td>
<td>7200秒（2小时）</td>
<td>7200秒（2小时）</td>
</tr>
<tr>
<td><strong>连接建立超时</strong></td>
<td>Connection Establishment Timeout</td>
<td>63秒</td>
<td>21秒</td>
<td>75秒</td>
</tr>
<tr>
<td><strong>连接重置超时</strong></td>
<td>Connection Reset Timeout</td>
<td>0秒</td>
<td>0秒</td>
<td>0秒</td>
</tr>
</tbody>
</table>
<h1 id="日志分析与故障定位-1">4.4 日志分析与故障定位</h1>
<h2 id="网络日志分析-1">4.4.1 网络日志分析</h2>
<h3 id="流日志">流日志</h3>
<p>流日志记录网络层的元数据，如源 IP、目标
IP、端口、协议和流量大小，用于分析网络流量和连接问题。</p>
<ul>
<li><strong>用途</strong>：
<ul>
<li>分析网络流量。</li>
<li>排查网络连接问题（如丢包、延迟）。</li>
<li>安全事件监控（如异常访问检测）。</li>
</ul></li>
<li><strong>典型工具</strong>：AWS VPC Flow Logs、Azure NSG Flow
Logs、NetFlow、sFlow。</li>
</ul>
<h3 id="数据包日志">数据包日志</h3>
<p>数据包日志捕获网络中的详细数据包信息，包括 MAC 地址、IP
地址、端口和负载内容，用于深入分析网络问题。</p>
<ul>
<li><strong>用途</strong>：
<ul>
<li>分析 MTU 不匹配或路由环路问题。</li>
<li>网络入侵检测。</li>
</ul></li>
<li><strong>典型工具</strong>：Wireshark、Tcpdump。</li>
</ul>
<hr />
<h2 id="服务日志分析-1">4.4.2 服务日志分析</h2>
<h3 id="调用链追踪">调用链追踪</h3>
<p>记录服务间调用或客户端与服务间的调用详情，包括请求时间、路径、参数和响应时间。</p>
<ul>
<li><strong>用途</strong>：
<ul>
<li>排查接口错误或调用失败。</li>
<li>分析接口性能。</li>
<li>监控服务健康状况。</li>
</ul></li>
<li><strong>典型工具</strong>：API Gateway Logs、Nginx Access
Logs、Jaeger、Zipkin。</li>
</ul>
<h3 id="接口性能监控">接口性能监控</h3>
<p>通过调用日志中的响应时间和错误率，监控接口性能，定位瓶颈。</p>
<ul>
<li><strong>用途</strong>：
<ul>
<li>优化服务性能。</li>
<li>发现高延迟或高错误率的接口。</li>
</ul></li>
<li><strong>典型工具</strong>：Application APM Tools、SkyWalking。</li>
</ul>
<hr />
<h2 id="应用日志分析-1">4.4.3 应用日志分析</h2>
<h3 id="错误堆栈">错误堆栈</h3>
<p>记录应用运行中的详细错误信息，包括异常堆栈和出错时的上下文。</p>
<ul>
<li><strong>用途</strong>：
<ul>
<li>调试和修复代码问题。</li>
<li>记录未捕获的异常。</li>
</ul></li>
<li><strong>典型工具</strong>：Log4j、SLF4J、ELK Stack。</li>
</ul>
<h3 id="业务逻辑验证">业务逻辑验证</h3>
<p>记录应用内部的关键业务事件（如订单状态、用户登录）和逻辑流程。</p>
<ul>
<li><strong>用途</strong>：
<ul>
<li>验证业务逻辑的正确性。</li>
<li>追踪用户行为。</li>
</ul></li>
<li><strong>典型工具</strong>：Fluentd、Splunk。</li>
</ul>
<hr />
<h2 id="排查思路从客户端到服务端">4.4.4 排查思路：从客户端到服务端</h2>
<p>日志分析的排查思路可以按照以下顺序进行：<strong>应用日志 -&gt;
接口调用日志 -&gt; 流日志</strong>，逐步深入定位问题。</p>
<h3 id="应用日志-1">1. 应用日志</h3>
<ul>
<li><strong>检查内容</strong>：
<ul>
<li>用户行为记录：是否触发了对应的请求。</li>
<li>错误堆栈：未捕获的异常是否导致任务中断。</li>
<li>业务事件：如订单生成是否正常。</li>
</ul></li>
<li><strong>典型问题</strong>：
<ul>
<li>用户提交的请求数据格式错误。</li>
<li>应用逻辑中处理边界条件失败。</li>
<li>系统调用超时。</li>
</ul></li>
<li><strong>工具</strong>：
<ul>
<li>日志工具：Log4j、ELK Stack。</li>
<li>调试工具：IDE 调试功能。</li>
</ul></li>
</ul>
<hr />
<h3 id="接口调用日志">2. 接口调用日志</h3>
<ul>
<li><strong>检查内容</strong>：
<ul>
<li>请求路径、参数和状态码是否正确。</li>
<li>响应时间是否异常。</li>
<li>调用链是否完整。</li>
</ul></li>
<li><strong>典型问题</strong>：
<ul>
<li>HTTP 4xx（如 400 格式错误，401 未授权）。</li>
<li>HTTP 5xx（如 500 服务端错误，503 服务不可用）。</li>
<li>服务间调用超时。</li>
</ul></li>
<li><strong>工具</strong>：
<ul>
<li>日志工具：Nginx Access Logs、API Gateway Logs。</li>
<li>调用链追踪工具：Jaeger、Zipkin。</li>
<li>性能监控工具：New Relic、SkyWalking。</li>
</ul></li>
</ul>
<hr />
<h3 id="流日志-1">3. 流日志</h3>
<ul>
<li><strong>检查内容</strong>：
<ul>
<li>数据包是否成功传输。</li>
<li>网络连接状态（如 SYN/ACK 是否成功）。</li>
<li>是否有丢包、重传或延迟问题。</li>
</ul></li>
<li><strong>典型问题</strong>：
<ul>
<li>客户端网络连接失败。</li>
<li>防火墙阻止流量。</li>
<li>高并发导致服务端资源耗尽。</li>
</ul></li>
<li><strong>工具</strong>：
<ul>
<li>网络流日志工具：AWS VPC Flow Logs、NetFlow。</li>
<li>数据包分析工具：Wireshark、Tcpdump。</li>
<li>防火墙监控：Cloud Firewall Logs。</li>
</ul></li>
</ul>
<hr />
<h3 id="排查流程示例">排查流程示例</h3>
<h4 id="示例-1客户端报错服务不可用">示例 1：客户端报错“服务不可用”</h4>
<ol type="1">
<li><strong>应用日志</strong>：
<ul>
<li>检查日志是否记录到用户触发了 API 请求。</li>
<li>发现日志中正常触发了 <code>/api/v1/orders</code> 请求。</li>
</ul></li>
<li><strong>接口调用日志</strong>：
<ul>
<li>查看接口返回 HTTP 503（服务不可用）。</li>
<li>调用链显示 <code>order-service</code> 超时。</li>
</ul></li>
<li><strong>流日志</strong>：
<ul>
<li>检查流量记录，发现服务端流量激增。</li>
<li>分析服务端资源，确认因高并发导致 CPU 和内存耗尽。</li>
</ul></li>
</ol>
<h4 id="示例-2客户端显示网络请求失败">示例
2：客户端显示“网络请求失败”</h4>
<ol type="1">
<li><strong>应用日志</strong>：
<ul>
<li>日志中无 API 调用记录，怀疑网络问题。</li>
</ul></li>
<li><strong>接口调用日志</strong>：
<ul>
<li>无相关日志记录。</li>
</ul></li>
<li><strong>流日志</strong>：
<ul>
<li>检查流量日志，发现客户端 IP 未连接成功。</li>
<li>使用抓包工具分析，发现 DNS 查询失败。</li>
<li>排查 DNS 配置并修复问题。</li>
</ul></li>
</ol>
<hr />
<h2 id="日志类型分类表">4.4.5 日志类型分类表</h2>
<table>
<colgroup>
<col style="width: 3%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 36%" />
<col style="width: 36%" />
<col style="width: 12%" />
</colgroup>
<thead>
<tr>
<th><strong>大分类</strong></th>
<th><strong>日志类型</strong></th>
<th><strong>对应层面</strong></th>
<th><strong>主要内容</strong></th>
<th><strong>用途</strong></th>
<th><strong>典型工具或技术</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>应用日志</strong></td>
<td>应用日志</td>
<td>应用层（业务逻辑）</td>
<td>-
应用程序内部运行时的详细信息（如业务处理流程、变量状态、异常堆栈）。</td>
<td>- 排查应用内部逻辑错误。<br>-
记录业务事件（如订单处理、用户登录）。<br>- 调试和优化代码。</td>
<td>Log4j、SLF4J、ELK Stack、Fluentd</td>
</tr>
<tr>
<td><strong>应用日志</strong></td>
<td>HTTP 访问日志</td>
<td>应用层（HTTP 协议）</td>
<td>- HTTP
请求和响应：方法（GET/POST）、路径、状态码、响应时间、用户代理。</td>
<td>- 分析网站流量。<br>- 监控接口性能和错误率。</td>
<td>Apache Logs、Nginx Access Logs</td>
</tr>
<tr>
<td><strong>应用日志</strong></td>
<td>DNS 查询日志</td>
<td>应用层（DNS 协议）</td>
<td>- DNS 请求记录：查询域名、查询类型、响应时间。<br>-
是否缓存命中、查询结果（成功或失败）。</td>
<td>- 分析域名解析性能。<br>- 检测恶意域名访问或 DNS 放大攻击。</td>
<td>BIND DNS Logs、DNSCrypt Proxy Logs</td>
</tr>
<tr>
<td><strong>应用日志</strong></td>
<td>TLS 握手日志</td>
<td>会话层（TLS 协议）</td>
<td>- TLS 握手的详细信息：握手阶段、加密算法、证书验证结果。</td>
<td>- 检测加密通信的失败原因（如证书过期、算法不匹配）。<br>-
分析加密通道的安全性。</td>
<td>OpenSSL Logs、Wireshark、SSL Labs Reports</td>
</tr>
<tr>
<td><strong>服务日志</strong></td>
<td>调用日志</td>
<td>服务层（接口层）</td>
<td>-
服务间或客户端与服务间的调用详情（如请求时间、参数、状态码、响应时间）。</td>
<td>- 排查接口错误或调用失败。<br>-
分析接口性能（如响应时间和错误率）。<br>- 监控服务健康状况。</td>
<td>API Gateway Logs、Nginx Access Logs、Application APM Tools</td>
</tr>
<tr>
<td><strong>网络日志</strong></td>
<td>流日志</td>
<td>网络层/传输层</td>
<td>- 网络流量的元数据（如 IP 地址、端口、协议、流量大小）。<br>-
不包含具体的传输内容（仅元信息）。</td>
<td>- 分析网络流量。<br>- 排查网络连接问题（如丢包、延迟）。<br>-
安全事件监控（如检测异常访问）。</td>
<td>AWS VPC Flow Logs、Azure NSG Flow Logs、NetFlow、sFlow</td>
</tr>
<tr>
<td><strong>网络日志</strong></td>
<td>数据包日志</td>
<td>链路层/网络层</td>
<td>- 数据包的详细信息：MAC 地址、IP 地址、端口、协议标识。<br>-
数据包的头部和负载内容。</td>
<td>- 深入分析网络问题（如 MTU 不匹配、路由环路）。<br>-
网络入侵检测。</td>
<td>Wireshark、Tcpdump</td>
</tr>
<tr>
<td><strong>网络日志</strong></td>
<td>TCP 连接日志</td>
<td>传输层</td>
<td>- TCP 连接的状态：SYN、ACK、FIN、RST。<br>-
重传次数、握手失败。</td>
<td>- 分析连接状态（如建立失败）。<br>- 排查丢包或重传问题。</td>
<td>Wireshark、Nmap</td>
</tr>
<tr>
<td><strong>应用日志</strong></td>
<td>SMTP 日志</td>
<td>应用层（SMTP 协议）</td>
<td>-
邮件发送和接收的状态：邮件来源、目标、传输状态、延迟、错误代码。</td>
<td>- 分析邮件服务器性能。<br>- 检测垃圾邮件或邮件服务异常。</td>
<td>Postfix Logs、Exim Logs</td>
</tr>
<tr>
<td><strong>应用日志</strong></td>
<td>VPN 日志</td>
<td>会话层/网络层</td>
<td>- VPN 连接的状态：握手时间、加密方式、连接 IP、断开原因。</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h1 id="典型故障场景与案例分析-1">4.5 典型故障场景与案例分析</h1>
<h2 id="服务端异常-1">4.5.1 服务端异常</h2>
<ul>
<li><strong>资源耗尽</strong> 场景：服务器的
CPU、内存或磁盘空间达到上限，导致服务性能下降或无法正常提供服务。 解决：
<ol type="1">
<li>监控资源使用情况，识别瓶颈。</li>
<li>通过水平扩展或增加资源容量缓解压力。</li>
<li>优化代码和服务逻辑，减少资源占用。</li>
</ol></li>
<li><strong>依赖服务故障</strong>
场景：上游服务或第三方依赖出现问题，例如认证服务超时或存储服务不可用。
解决：
<ol type="1">
<li>在日志中查找与依赖服务的交互记录，确认异常点。</li>
<li>配置重试策略和降级方案，减少对依赖的影响。</li>
<li>与服务提供方协作，确认问题原因。</li>
</ol></li>
</ul>
<hr />
<h2 id="客户端异常-1">4.5.2 客户端异常</h2>
<ul>
<li><strong>请求格式错误</strong>
场景：客户端发送的请求不符合服务端要求，导致请求被拒绝或返回错误响应。
解决：
<ol type="1">
<li>检查客户端日志和抓包，确认请求的具体格式和参数。</li>
<li>比对服务端 API 文档，确保请求的字段和格式符合要求。</li>
<li>增加客户端的请求校验逻辑，提前发现问题。</li>
</ol></li>
<li><strong>网络连接失败</strong>
场景：客户端与服务端之间的网络中断，导致无法访问服务。 解决：
<ol type="1">
<li>检查客户端的网络环境，如 DNS 配置、代理设置和防火墙规则。</li>
<li>使用 <code>ping</code> 或 <code>traceroute</code>
检测网络链路状态。</li>
<li>针对不稳定的网络，启用断线重连或备用节点机制。</li>
</ol></li>
</ul>
<hr />
<h2 id="综合案例-1">4.5.3 综合案例</h2>
<h3 id="案例-1应用-dns-故障快速排查">案例 1：应用-DNS 故障快速排查</h3>
<p>场景：用户反馈应用无法访问，测试发现域名解析失败。 解决步骤： 1. 使用
<code>nslookup</code> 或 <code>dig</code> 检查 DNS 配置和解析结果。 2.
排查 DNS 服务器状态，确认是否可用。 3. 更新 DNS 缓存，或临时切换到其他
DNS 服务（如 8.8.8.8）。 4. 检查网络路径中是否存在拦截（如防火墙或 NAT
问题）。</p>
<hr />
<h3 id="案例-2应用-io-性能问题定位分析">案例 2：应用-IO
性能问题定位分析</h3>
<p>场景：批量处理任务时，应用性能急剧下降，分析发现磁盘 IO 过高。
解决步骤： 1. 使用 <code>iostat</code> 或 <code>iotop</code>
工具查看磁盘 IO 状态，确认读写是否过于频繁。 2.
检查文件系统是否存在碎片，或日志文件是否持续增长。 3. 对 IO
密集型任务进行限速或分批处理，减轻瞬时压力。 4. 升级磁盘性能（如
SSD）或优化数据访问逻辑（如缓存）。</p>
<hr />
<h3 id="案例-3应用-db-性能问题定位分析">案例 3：应用-DB
性能问题定位分析</h3>
<p>场景：数据库查询速度变慢，影响整体服务响应。 解决步骤： 1.
使用数据库自带的查询分析工具（如 EXPLAIN）定位慢查询。 2.
检查索引是否存在或合理，避免全表扫描。 3.
查看数据库服务器的资源使用情况，是否达到瓶颈。 4.
使用分库分表或读写分离的方式优化查询效率。</p>
<hr />
<h3 id="案例-4应用-中间件性能问题定位分析">案例
4：应用-中间件性能问题定位分析</h3>
<p>场景：消息队列积压严重，消费者处理速度明显下降。 解决步骤： 1.
检查消息队列的队列长度和吞吐量，确认瓶颈点。 2.
查看消费者的消费速率和日志，是否存在逻辑错误或阻塞。 3.
增加消费者实例或优化消费逻辑，提升处理能力。 4.
对非关键消息启用丢弃或延迟消费策略，避免影响核心业务。</p>
<hr />
<h3 id="案例-5定位网络时延类故障">案例 5：定位网络时延类故障</h3>
<p>场景：用户反馈访问服务延迟明显增加，分析发现网络延迟异常。 解决步骤：
1. 使用 <code>ping</code> 或 <code>traceroute</code>
工具确认延迟节点或链路。 2. 检查网络路由是否发生变更，或是否存在拥塞点。
3. 使用 SD-WAN 或 MPLS 等技术优化网络路径。 4. 针对跨区域访问，启用 CDN
加速或服务节点本地化。</p>
<hr />
<h3 id="案例-6洞察定位云网络丢包类故障">案例
6：洞察、定位云网络丢包类故障</h3>
<p>场景：云环境中的服务稳定性下降，监控显示存在高丢包率。 解决步骤： 1.
使用云平台提供的网络监控工具查看丢包位置（如 VPC 内或跨区域）。 2.
排查相关网络设备（如网关、负载均衡器）的日志和健康状态。 3.
检查服务端和客户端的 MTU 设置，避免分片问题。 4.
增加链路冗余，或切换到不同区域的节点降低丢包影响。</p>
<hr />
<p>通过对这些典型案例的分析和总结，可以为实际问题排查提供清晰的流程和有效的解决方案，同时为提升系统可靠性积累宝贵经验。</p>
<h1 id="概述-2">概述</h1>
<p>结合原有的故障排查章节，本节总结了从客户端请求到服务端响应的完整排查思路，并梳理了应用指标、网络指标和日志分析的要点：</p>
<ul>
<li><strong>排查流程</strong>：按照请求路径自上而下，从 DNS、TCP/TLS
到应用处理逐层分析，先确认故障范围，再定位应用层、服务层和网络层的异常。</li>
<li><strong>应用指标</strong>：关注响应时间、错误率、系统资源、用户留存和吞吐量，通过
APM、监控面板等工具定位慢请求和依赖服务瓶颈。</li>
<li><strong>网络指标</strong>：优先监控延迟、丢包率、带宽利用率和 TCP
连接时间，结合流量趋势和路径分析优化网络质量。</li>
<li><strong>日志分析</strong>：从应用日志、接口调用日志到网络流日志逐级深入，利用调用链追踪和抓包等方式快速定位问题根因。</li>
</ul>
<h1 id="对比-2">对比</h1>
<table>
<colgroup>
<col style="width: 9%" />
<col style="width: 38%" />
<col style="width: 27%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>维度</th>
<th>关注重点</th>
<th>常用工具</th>
<th>典型问题示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>应用指标</td>
<td>响应时间、错误率、资源使用、吞吐量</td>
<td>APM、监控面板、性能测试工具</td>
<td>慢查询、依赖服务超时</td>
</tr>
<tr>
<td>网络指标</td>
<td>延迟、丢包率、带宽利用率、重传率</td>
<td>NetFlow、ping、traceroute</td>
<td>链路拥塞、跨区域访问延迟</td>
</tr>
<tr>
<td>日志分析</td>
<td>应用日志、调用日志、网络流/数据包日志</td>
<td>ELK、Jaeger、Tcpdump</td>
<td>错误堆栈、HTTP 4xx/5xx 等</td>
</tr>
</tbody>
</table>
<h1 id="场景-1">场景</h1>
<ul>
<li><strong>服务端资源耗尽</strong>：CPU/内存达到上限导致 5xx
错误；通过扩容、优化代码或限流解决。</li>
<li><strong>依赖服务故障</strong>：认证或存储服务超时；配置重试与降级并与提供方协作修复。</li>
<li><strong>请求格式错误</strong>：客户端参数不合法返回 4xx；检查日志与
API 文档并增加校验。</li>
<li><strong>网络连接失败</strong>：DNS 配置错误或链路中断；使用
ping、traceroute 等定位并修复。</li>
<li><strong>典型案例</strong>：如 DNS 故障、IO
瓶颈、数据库慢查询或网络时延异常，均需结合上述指标和日志逐步排查。</li>
</ul>
<h1 id="postgresql-clickhouse-高性能分层写入架构">PostgreSQL +
ClickHouse 高性能分层写入架构</h1>
<h2 id="架构目标">1. 架构目标</h2>
<ul>
<li>模仿 GreptimeDB 的分层写入能力：热写入 PostgreSQL（TimescaleDB
扩展）并按需冷聚合到 ClickHouse。</li>
<li>支持多协议接入（REST / gRPC / OpenTelemetry / Arrow Flight）。</li>
<li>动态表结构注册，借助 JSONB 与元数据表管理 schema。</li>
<li>易于在单机 PoC、集群与存算分离之间平滑扩展。</li>
</ul>
<h2 id="架构总览">2. 架构总览</h2>
<pre class="mermaid"><code>graph TD
    subgraph Client
        A[Vector Agent]
    end

    subgraph Transport
        A --&gt; B[Unified API (REST/gRPC/OTel)]
    end

    subgraph Storage
        B --&gt; C1[PostgreSQL (TimescaleDB + JSONB)]
        B --&gt; C2[ClickHouse (OLAP 聚合)]
    end

    subgraph Query
        C1 --&gt; D[Grafana / SQL API]
        C2 --&gt; D
    end</code></pre>
<h2 id="核心组件">3. 核心组件</h2>
<h3 id="api-层">3.1 API 层</h3>
<p>使用 Go / Rust 编写 Ingest 网关： - <code>/write/metrics</code> →
TimescaleDB - <code>/write/logs</code> → ClickHouse -
<code>/schema/register</code> → 写入 <code>table_registry</code>
元数据表</p>
<h3 id="postgresql-写入端实时指标">3.2 PostgreSQL
写入端（实时指标）</h3>
<div class="sourceCode" id="cb6"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> metrics_events (</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">time</span>        TIMESTAMPTZ <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  app         TEXT,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  host        TEXT,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  labels      JSONB,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">value</span>       <span class="dt">DOUBLE</span> <span class="dt">PRECISION</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  trace_id    TEXT,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">level</span>       TEXT</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> create_hypertable(<span class="st">&#39;metrics_events&#39;</span>, <span class="st">&#39;time&#39;</span>);</span></code></pre></div>
<h3 id="clickhouse-写入端归档聚合">3.3 ClickHouse
写入端（归档聚合）</h3>
<div class="sourceCode" id="cb7"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> logs_events (</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">timestamp</span> DateTime,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  app       String,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  host      String,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  trace_id  String,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  message   String,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  labels    <span class="kw">Nested</span>(k String, v String)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>) ENGINE <span class="op">=</span> MergeTree()</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="kw">PARTITION</span> <span class="kw">BY</span> toYYYYMMDD(<span class="dt">timestamp</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> (<span class="dt">timestamp</span>, app);</span></code></pre></div>
<h3 id="schema-管理">3.4 Schema 管理</h3>
<div class="sourceCode" id="cb8"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> table_registry (</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  table_name TEXT <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">schema</span>     JSONB,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  created_at TIMESTAMPTZ <span class="kw">DEFAULT</span> now()</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>注册示例：</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;columns&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span><span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;time&quot;</span><span class="fu">,</span>   <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;timestamp&quot;</span><span class="fu">}</span><span class="ot">,</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span><span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;value&quot;</span><span class="fu">,</span>  <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;double&quot;</span><span class="fu">}</span><span class="ot">,</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span><span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;labels&quot;</span><span class="fu">,</span> <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;jsonb&quot;</span><span class="fu">}</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h2 id="参考配置">4. 参考配置</h2>
<h3 id="vector-采集配置">4.1 Vector 采集配置</h3>
<div class="sourceCode" id="cb10"><pre
class="sourceCode toml"><code class="sourceCode toml"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[sources.prom]</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="dt">type</span> <span class="op">=</span> <span class="st">&quot;prometheus_scrape&quot;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="dt">endpoints</span> <span class="op">=</span> <span class="op">[</span><span class="st">&quot;http://localhost:9100/metrics&quot;</span><span class="op">]</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="kw">[sources.logs]</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="dt">type</span> <span class="op">=</span> <span class="st">&quot;journald&quot;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="kw">[transforms.jsonify_logs]</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="dt">type</span> <span class="op">=</span> <span class="st">&quot;remap&quot;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="dt">inputs</span> <span class="op">=</span> <span class="op">[</span><span class="st">&quot;logs&quot;</span><span class="op">]</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="dt">source</span> <span class="op">=</span> <span class="st">&#39;&#39;&#39;</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="vs">.structured = parse_json!(string!(.message))</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;&#39;&#39;</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="kw">[sinks.pg]</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="dt">type</span> <span class="op">=</span> <span class="st">&quot;postgresql&quot;</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="dt">inputs</span> <span class="op">=</span> <span class="op">[</span><span class="st">&quot;prom&quot;</span><span class="op">,</span> <span class="st">&quot;jsonify_logs&quot;</span><span class="op">]</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="dt">database</span> <span class="op">=</span> <span class="st">&quot;metrics&quot;</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="dt">endpoint</span> <span class="op">=</span> <span class="st">&quot;postgresql://user:pass@pg:5432/metrics&quot;</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="dt">table</span> <span class="op">=</span> <span class="st">&quot;observability_events&quot;</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="dt">mode</span> <span class="op">=</span> <span class="st">&quot;insert&quot;</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="dt">compression</span> <span class="op">=</span> <span class="st">&quot;zstd&quot;</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="kw">[sinks.ch]</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="dt">type</span> <span class="op">=</span> <span class="st">&quot;clickhouse&quot;</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="dt">inputs</span> <span class="op">=</span> <span class="op">[</span><span class="st">&quot;jsonify_logs&quot;</span><span class="op">]</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="dt">endpoint</span> <span class="op">=</span> <span class="st">&quot;http://clickhouse:8123&quot;</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="dt">database</span> <span class="op">=</span> <span class="st">&quot;default&quot;</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="dt">table</span> <span class="op">=</span> <span class="st">&quot;logs&quot;</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="dt">compression</span> <span class="op">=</span> <span class="st">&quot;gzip&quot;</span></span></code></pre></div>
<h3 id="grafana-查询示例">4.2 Grafana 查询示例</h3>
<ul>
<li><strong>PostgreSQL 数据源</strong></li>
</ul>
<div class="sourceCode" id="cb11"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> time_bucket(<span class="st">&#39;1 minute&#39;</span>, event_time) <span class="kw">AS</span> ts, <span class="fu">COUNT</span>(<span class="op">*</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> observability_events</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> node <span class="op">=</span> $__variable_node</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> <span class="dt">raw</span><span class="op">-&gt;&gt;</span><span class="st">&#39;source&#39;</span> <span class="op">=</span> $__variable_source_type</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> $__timeFilter(event_time)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> ts</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> ts;</span></code></pre></div>
<ul>
<li><strong>ClickHouse 数据源</strong></li>
</ul>
<div class="sourceCode" id="cb12"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> node, <span class="fu">count</span>() <span class="kw">AS</span> total</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> logs</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="dt">timestamp</span> <span class="op">&gt;=</span> $__from <span class="kw">AND</span> <span class="dt">timestamp</span> <span class="op">&lt;=</span> $__to</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> node</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> total <span class="kw">DESC</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">5</span>;</span></code></pre></div>
<h2 id="部署演进路径">5. 部署演进路径</h2>
<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>阶段</th>
<th>特性</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>单节点一体化</td>
<td>所有组件运行在一台主机</td>
<td>适合 PoC / 开发环境</td>
</tr>
<tr>
<td>多副本集群</td>
<td>API、PG、CH 分别部署为独立节点，可接入负载均衡</td>
<td>支持横向扩展与高可用</td>
</tr>
<tr>
<td>存算分离</td>
<td>引入 Kafka 等缓冲层，PG/CH 采用分布式与 Replication</td>
<td>写入与查询解耦，适合大规模场景</td>
</tr>
</tbody>
</table>
<h2 id="测试验证方案">6. 测试验证方案</h2>
<h3 id="测试目标">6.1 测试目标</h3>
<table>
<thead>
<tr>
<th>目标类别</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>💾 吞吐能力</td>
<td>是否能支撑 50K+ IOPS 持续写入并在高峰期达到 100K/s</td>
</tr>
<tr>
<td>🧠 查询能力</td>
<td>事件查询/统计分析响应稳定在 100~500ms</td>
</tr>
<tr>
<td>🔁 分层写入正确性</td>
<td>标签/类型是否正确路由至 PostgreSQL 与 ClickHouse</td>
</tr>
<tr>
<td>🔐 数据一致性</td>
<td>PostgreSQL 中 Trace、事件无漏写</td>
</tr>
<tr>
<td>📈 可观测性</td>
<td>Vector/PG/CH 与系统资源均可监控</td>
</tr>
</tbody>
</table>
<h3 id="基础环境准备">6.2 基础环境准备</h3>
<p><strong>数据源模拟</strong></p>
<table>
<thead>
<tr>
<th>工具</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>vector generator / log-generator</td>
<td>模拟高负载日志流</td>
</tr>
<tr>
<td>OpenTelemetry demo</td>
<td>生成 Trace 数据</td>
</tr>
<tr>
<td>prometheus-testgen</td>
<td>生成 Metrics 样本</td>
</tr>
</tbody>
</table>
<p><strong>写入目标部署</strong></p>
<table>
<thead>
<tr>
<th>系统</th>
<th>推荐配置</th>
</tr>
</thead>
<tbody>
<tr>
<td>PostgreSQL</td>
<td>16+ + TimescaleDB + pg_partman</td>
</tr>
<tr>
<td>ClickHouse</td>
<td>24.4+ + ReplicatedMergeTree</td>
</tr>
<tr>
<td>Vector</td>
<td>支持 transforms 路由、sink 至 PG/CH</td>
</tr>
<tr>
<td>监控组件</td>
<td>node_exporter、pg_exporter、vector internal、CH monitor</td>
</tr>
</tbody>
</table>
<h3 id="测试维度与方法">6.3 测试维度与方法</h3>
<h4 id="吞吐验证">6.3.1 吞吐验证</h4>
<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>项目</th>
<th>方法</th>
<th>期望</th>
</tr>
</thead>
<tbody>
<tr>
<td>最大持续写入</td>
<td>持续向 Vector 发送 JSON logs @ 50K/s，观察是否丢包</td>
<td>ACK latency &lt; 500ms</td>
</tr>
<tr>
<td>高峰瞬时写入</td>
<td>峰值 100K/s 持续 1 min，观察 PG/CH 报错情况</td>
<td>无错误、吞吐稳定</td>
</tr>
<tr>
<td>网络抖动模拟</td>
<td>通过 <code>tc</code> 注入延迟/丢包，观察重试</td>
<td>数据无丢失</td>
</tr>
</tbody>
</table>
<h4 id="数据分层准确性">6.3.2 数据分层准确性</h4>
<table>
<thead>
<tr>
<th>验证点</th>
<th>检查项</th>
</tr>
</thead>
<tbody>
<tr>
<td>Trace 事件 → PostgreSQL</td>
<td>是否按时间/traceID 正确分区落表</td>
</tr>
<tr>
<td>普通日志 → ClickHouse</td>
<td>是否按标签写入 MergeTree 表</td>
</tr>
<tr>
<td>异常标签</td>
<td>是否触发 fallback/dead-letter</td>
</tr>
</tbody>
</table>
<h4 id="查询验证">6.3.3 查询验证</h4>
<table>
<thead>
<tr>
<th>类型</th>
<th>查询目标</th>
<th>预期性能</th>
</tr>
</thead>
<tbody>
<tr>
<td>PostgreSQL</td>
<td>精确事件 → TraceID 查询</td>
<td>&lt;200ms</td>
</tr>
<tr>
<td>ClickHouse</td>
<td>日志聚合 → app error rate</td>
<td>&lt;1s</td>
</tr>
<tr>
<td>联合</td>
<td>Trace + 日志聚合视图</td>
<td>&lt;1.5s</td>
</tr>
</tbody>
</table>
<h4 id="资源使用验证">6.3.4 资源使用验证</h4>
<table>
<thead>
<tr>
<th>组件</th>
<th>监控项</th>
<th>期望值</th>
</tr>
</thead>
<tbody>
<tr>
<td>Vector</td>
<td>CPU &lt; 300m、Mem &lt; 300MB</td>
<td>✅</td>
</tr>
<tr>
<td>PostgreSQL</td>
<td>IOPS &lt; 40K / WAL flush latency</td>
<td>✅</td>
</tr>
<tr>
<td>ClickHouse</td>
<td>Merge 负载、后台线程瓶颈</td>
<td>✅</td>
</tr>
</tbody>
</table>
<h4 id="自动化脚本示例">6.3.5 自动化脚本示例</h4>
<div class="sourceCode" id="cb13"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="op">:=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">100000</span><span class="op">;</span> i<span class="op">++</span> <span class="op">{</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  body <span class="op">:=</span> <span class="kw">map</span><span class="op">[</span><span class="dt">string</span><span class="op">]</span><span class="kw">interface</span><span class="op">{}{</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;app&quot;</span><span class="op">:</span> <span class="st">&quot;auth&quot;</span><span class="op">,</span> <span class="st">&quot;trace_id&quot;</span><span class="op">:</span> fmt<span class="op">.</span>Sprintf<span class="op">(</span><span class="st">&quot;t-%d&quot;</span><span class="op">,</span> i<span class="op">),</span> <span class="st">&quot;message&quot;</span><span class="op">:</span> <span class="st">&quot;log&quot;</span><span class="op">,</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;ts&quot;</span><span class="op">:</span> time<span class="op">.</span>Now<span class="op">().</span>UnixNano<span class="op">()</span> <span class="op">/</span> <span class="fl">1e6</span><span class="op">,</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  jsonBody<span class="op">,</span> _ <span class="op">:=</span> json<span class="op">.</span>Marshal<span class="op">(</span>body<span class="op">)</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  http<span class="op">.</span>Post<span class="op">(</span><span class="st">&quot;http://localhost:9000/my-pg-sink&quot;</span><span class="op">,</span> <span class="st">&quot;application/json&quot;</span><span class="op">,</span> bytes<span class="op">.</span>NewBuffer<span class="op">(</span>jsonBody<span class="op">))</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="异常与恢复测试">6.4 异常与恢复测试</h3>
<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>验证目标</th>
<th>方案</th>
<th>期望指标</th>
</tr>
</thead>
<tbody>
<tr>
<td>Vector 重启/崩溃</td>
<td>高负载写入时重启 Vector，观察数据补写</td>
<td>无重复或漏写</td>
</tr>
<tr>
<td>PG/CH 停机</td>
<td>短暂下线数据库，观察 Vector 缓冲</td>
<td>自动重试，恢复后数据一致</td>
</tr>
<tr>
<td>网络断连恢复</td>
<td>使用 netem 模拟断网，检查重连</td>
<td>不丢失、不时序异常</td>
</tr>
</tbody>
</table>
<h3 id="可观测性与告警">6.5 可观测性与告警</h3>
<table>
<thead>
<tr>
<th>验证目标</th>
<th>方案</th>
<th>期望指标</th>
</tr>
</thead>
<tbody>
<tr>
<td>指标完备性</td>
<td>检查 Vector、PG、CH、OS 指标</td>
<td>覆盖率 &gt; 95%</td>
</tr>
<tr>
<td>告警规则有效性</td>
<td>模拟 CPU/延迟异常触发告警</td>
<td>告警及时</td>
</tr>
<tr>
<td>日志追踪</td>
<td>通过集中日志跟踪关键事件</td>
<td>故障可快速定位</td>
</tr>
</tbody>
</table>
<h3 id="验证成功标准">6.6 验证成功标准</h3>
<table>
<thead>
<tr>
<th>维度</th>
<th>成功判定</th>
</tr>
</thead>
<tbody>
<tr>
<td>写入链路</td>
<td>≥ 95% 写入无丢失，ACK latency 稳定</td>
</tr>
<tr>
<td>数据正确性</td>
<td>PG 与 CH 数据能联查对齐，时间戳正确</td>
</tr>
<tr>
<td>系统资源</td>
<td>单节点 PG/CH/Vector CPU &lt; 50%，无 OOM</td>
</tr>
<tr>
<td>查询性能</td>
<td>常用 Trace 查询 &lt;500ms</td>
</tr>
<tr>
<td>异常处理</td>
<td>标签异常可自动 fallback 或告警记录</td>
</tr>
</tbody>
</table>
<h3 id="可选增强场景">6.7 可选增强场景</h3>
<ul>
<li>断点恢复测试：模拟 Vector 中断、PG WAL 积压后的补写能力<br />
</li>
<li>导入真实日志样本：使用历史 prod 日志替代模拟器<br />
</li>
<li>滚动升级兼容性：升级 Vector/CH 时验证数据路径稳定性<br />
</li>
<li>跨地域部署：验证跨区复制对写入与查询的影响</li>
</ul>
<h2 id="结语">7. 结语</h2>
<p>通过 PostgreSQL + ClickHouse
的分层写入方案，可以在保证实时查询能力的同时实现高吞吐归档和聚合分析，为可观测性平台提供灵活、可扩展的存储基础。</p>
<h1 id="生产级监控配置方案linux-裸机-1">生产级监控配置方案（Linux
裸机）</h1>
<h2 id="目标">1. 目标</h2>
<ul>
<li>系统级指标（CPU/MEM/Load/磁盘/网卡） →
<strong>node_exporter</strong></li>
<li>进程级指标（nginx/redis/postgres/xcontrol-server 等） →
<strong>process-exporter</strong></li>
<li>本地历史保底（即使 Prometheus 挂掉也能事后回放） → <strong>atop +
sysstat</strong></li>
<li>安全/加固：统一安装目录、专用用户、systemd
管理、端口限制、日志留存策略</li>
</ul>
<h2 id="目录-用户规划">2. 目录 &amp; 用户规划</h2>
<pre><code># 安装目录
/opt/metrics-agent/
  ├─ node_exporter
  ├─ process_exporter
  └─ process_exporter.yml

# 日志目录
/var/log/atop/
/var/log/sysstat/

# 专用用户
useradd --system --no-create-home --shell /usr/sbin/nologin metrics</code></pre>
<h2 id="node-exporter系统级">3. Node Exporter（系统级）</h2>
<h3 id="安装">安装</h3>
<div class="sourceCode" id="cb15"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /opt/metrics-agent</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-L</span> https://github.com/prometheus/node_exporter/releases/download/v1.8.2/node_exporter-1.8.2.linux-amd64.tar.gz <span class="dt">\</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">|</span> <span class="fu">tar</span> xz <span class="at">--strip-components</span><span class="op">=</span>1 <span class="at">-C</span> /opt/metrics-agent <span class="at">--wildcards</span> <span class="st">&#39;*/node_exporter&#39;</span></span></code></pre></div>
<h3 id="systemd-单元-etcsystemdsystemnode-exporter.service">systemd 单元
<code>/etc/systemd/system/node-exporter.service</code></h3>
<div class="sourceCode" id="cb16"><pre
class="sourceCode ini"><code class="sourceCode ini"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[Unit]</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Description</span><span class="ot">=</span><span class="st">Prometheus Node Exporter</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="dt">After</span><span class="ot">=</span><span class="st">network.target</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="kw">[Service]</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="dt">User</span><span class="ot">=</span><span class="st">metrics</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="dt">Group</span><span class="ot">=</span><span class="st">metrics</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="dt">ExecStart</span><span class="ot">=</span><span class="st">/opt/metrics-agent/node_exporter \</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="dt">  --web.listen-address</span><span class="ot">=</span><span class="st">127.0.0.1:9100 \</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="dt">  --collector.processes \</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="dt">  --collector.filesystem.ignored-mount-points</span><span class="ot">=</span><span class="st">&quot;^/(sys|proc|dev|run|var/lib/docker/.+)($|/)&quot;</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="dt">Restart</span><span class="ot">=</span><span class="st">always</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="kw">[Install]</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="dt">WantedBy</span><span class="ot">=</span><span class="st">multi-user.target</span></span></code></pre></div>
<blockquote>
<p>绑定 127.0.0.1，避免直接暴露公网，建议 Prometheus
通过内网采集或加反代。</p>
</blockquote>
<h2 id="process-exporter进程级">4. Process Exporter（进程级）</h2>
<h3 id="安装-1">安装</h3>
<div class="sourceCode" id="cb17"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /opt/metrics-agent</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-L</span> https://github.com/ncabatoff/process-exporter/releases/download/v0.7.10/process-exporter-0.7.10.linux-amd64.tar.gz <span class="dt">\</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">|</span> <span class="fu">tar</span> xz <span class="at">--strip-components</span><span class="op">=</span>1 <span class="at">-C</span> /opt/metrics-agent <span class="at">--wildcards</span> <span class="st">&#39;*/process-exporter&#39;</span></span></code></pre></div>
<h3 id="配置文件-optmetrics-agentprocess_exporter.yml">配置文件
<code>/opt/metrics-agent/process_exporter.yml</code></h3>
<div class="sourceCode" id="cb18"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">process_names</span><span class="kw">:</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;nginx&quot;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">exe</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;^/usr/local/openresty/nginx/sbin/nginx$&quot;</span><span class="kw">]</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">comm</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;^nginx$&quot;</span><span class="kw">]</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">cmdline</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;nginx&quot;</span><span class="kw">]</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;redis&quot;</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">exe</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;.*/redis-server$&quot;</span><span class="kw">]</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">comm</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;^redis-server$&quot;</span><span class="kw">]</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">cmdline</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;redis-server&quot;</span><span class="kw">]</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;postgres&quot;</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">exe</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;.*/postgres$&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;.*/postmaster$&quot;</span><span class="kw">]</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">comm</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;^postgres$&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;^postmaster$&quot;</span><span class="kw">]</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">cmdline</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;postgres&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;postmaster&quot;</span><span class="kw">]</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;xcontrol-server&quot;</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">exe</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;^/usr/bin/xcontrol-server$&quot;</span><span class="kw">]</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">comm</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;^xcontrol-server$&quot;</span><span class="kw">]</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">cmdline</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;xcontrol-server&quot;</span><span class="kw">]</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;other&quot;</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">cmdline</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;.+&quot;</span><span class="kw">]</span></span></code></pre></div>
<h3 id="systemd-单元-etcsystemdsystemprocess-exporter.service">systemd
单元 <code>/etc/systemd/system/process-exporter.service</code></h3>
<div class="sourceCode" id="cb19"><pre
class="sourceCode ini"><code class="sourceCode ini"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[Unit]</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Description</span><span class="ot">=</span><span class="st">Prometheus Process Exporter</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="dt">After</span><span class="ot">=</span><span class="st">network.target</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="kw">[Service]</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="dt">User</span><span class="ot">=</span><span class="st">metrics</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="dt">Group</span><span class="ot">=</span><span class="st">metrics</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="dt">ExecStart</span><span class="ot">=</span><span class="st">/opt/metrics-agent/process-exporter \</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="dt">  --config.path</span><span class="ot">=</span><span class="st">/opt/metrics-agent/process_exporter.yml \</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="dt">  --web.listen-address</span><span class="ot">=</span><span class="st">127.0.0.1:9256</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="dt">Restart</span><span class="ot">=</span><span class="st">always</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="kw">[Install]</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="dt">WantedBy</span><span class="ot">=</span><span class="st">multi-user.target</span></span></code></pre></div>
<h2 id="本地保底atop-sysstat">5. 本地保底（atop + sysstat）</h2>
<div class="sourceCode" id="cb20"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apt-get</span> update</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="ex">apt-get</span> install <span class="at">-y</span> atop sysstat</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co"># sysstat: 每分钟采样，保留30天</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-ri</span> <span class="st">&#39;s/^ENABLED=.*/ENABLED=&quot;true&quot;/&#39;</span> /etc/default/sysstat</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-ri</span> <span class="st">&#39;s/^HISTORY=.*/HISTORY=30/&#39;</span> /etc/default/sysstat</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&#39;* * * * * root sa1 60 1&#39;</span> <span class="op">&gt;</span> /etc/cron.d/sysstat</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="ex">systemctl</span> enable <span class="at">--now</span> sysstat</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co"># atop: 每分钟采样，保留30天</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-ri</span> <span class="st">&#39;s/^LOGINTERVAL=.*/LOGINTERVAL=60/&#39;</span> /etc/default/atop <span class="kw">||</span> <span class="fu">true</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-ri</span> <span class="st">&#39;s/^LOGGENERATIONS=.*/LOGGENERATIONS=30/&#39;</span> /etc/default/atop <span class="kw">||</span> <span class="fu">true</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="ex">systemctl</span> enable <span class="at">--now</span> atop</span></code></pre></div>
<p>回放命令</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">atop</span> <span class="at">-r</span> /var/log/atop/atop_<span class="va">$(</span><span class="fu">date</span> +%Y%m%d<span class="va">)</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="ex">sar</span> <span class="at">-u</span> <span class="at">-f</span> /var/log/sysstat/sa16   <span class="co"># 16日的CPU历史</span></span></code></pre></div>
<h2 id="prometheus-抓取配置">6. Prometheus 抓取配置</h2>
<div class="sourceCode" id="cb22"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">scrape_configs</span><span class="kw">:</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">job_name</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;node&#39;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">static_configs</span><span class="kw">:</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">targets</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&#39;&lt;vm-ip&gt;:9100&#39;</span><span class="kw">]</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">job_name</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;process&#39;</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">static_configs</span><span class="kw">:</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">targets</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&#39;&lt;vm-ip&gt;:9256&#39;</span><span class="kw">]</span></span></code></pre></div>
<h2 id="grafana-面板">7. Grafana 面板</h2>
<ul>
<li>系统总览：CPU、MEM、Load、磁盘、网络 → node_exporter</li>
<li>进程分组：nginx/redis/postgres/xcontrol-server CPU/MEM/IO →
process-exporter</li>
<li>告警规则：
<ul>
<li>系统 CPU &gt; 80% 且持续 5m</li>
<li>内存可用 &lt; 15%</li>
<li>单进程组 CPU &gt; 50% 且 Load 高</li>
<li>磁盘 IO &gt; 80% 饿和度</li>
</ul></li>
</ul>
<h2 id="加固要点">8. 加固要点</h2>
<ul>
<li>安全：exporter 绑定 127.0.0.1，Prometheus
从内网/隧道采集；外网暴露必须加 Nginx 反代 + BasicAuth/TLS</li>
<li>资源开销：node_exporter / process-exporter 常驻 &lt;50MB 内存，CPU
几乎 0</li>
<li>atop/sysstat 采样瞬时 &lt;2% CPU，月日志 &lt;200MB</li>
<li>高可用：Prometheus 可加远程存储（Thanos/VM）做持久化，atop+sysstat
本地兜底</li>
<li>分组精简：process-exporter 只分关键服务，避免标签爆炸</li>
</ul>
<p>✅ 最终效果： - 在线：Prometheus + Grafana → 时序趋势 &amp; 告警 -
离线/断联：atop/sysstat → 回放事后诊断 - 可扩展：如需应用级指标，可加
redis_exporter、postgres_exporter、nginx-lua-prometheus</p>
<h1 id="vector-统一采集架构与-deepflow-agent-对比">Vector 统一采集架构与
DeepFlow Agent 对比</h1>
<h2 id="架构概览">1. 架构概览</h2>
<p>Vector
可以作为统一的采集出口，将系统、进程、网络和日志数据汇聚后再转发到不同的可观测性后端。</p>
<p>示例链路：</p>
<pre><code>node_exporter ─┐
process_exporter ─┤
DeepFlow Agent ──▶ Vector Agent ──▶ Loki
journald/syslog ─┘                ├─▶ Prometheus Remote Write
                                  └─▶ Tempo</code></pre>
<h3 id="核心设计">核心设计</h3>
<ul>
<li><strong>Sources</strong>：<code>prometheus_scrape</code> 用于拉取
node_exporter、process-exporter
指标；<code>journald</code>/<code>file</code> 采集系统与 DeepFlow
日志。</li>
<li><strong>Transforms</strong>：<code>remap</code> 统一标签，如把
<code>instance</code> 改为 <code>host</code>，补充业务标签。</li>
<li><strong>Sinks</strong>：同时写入 Prometheus 兼容数据库、Loki、Tempo
等多种后端，支持 TLS 与鉴权。</li>
</ul>
<h2 id="配置拆分与样例">2. 配置拆分与样例</h2>
<p>Vector 支持将配置拆分为多个文件，主配置通过 <code>includes</code>
统一加载：</p>
<pre><code>/etc/vector/
├── vector.yaml
├── sources/
│   ├── node_exporter.yaml
│   ├── process_exporter.yaml
│   └── journald.yaml
├── sinks/
│   ├── prometheus.yaml
│   └── loki.yaml
└── transforms/
    └── tags.yaml</code></pre>
<p><strong>主配置 vector.yaml</strong></p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data_dir</span><span class="kw">:</span><span class="at"> /var/lib/vector</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">includes</span><span class="kw">:</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> /etc/vector/sources/*.yaml</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> /etc/vector/sinks/*.yaml</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> /etc/vector/transforms/*.yaml</span></span></code></pre></div>
<p><strong>示例 source/sink 片段</strong></p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sources/node_exporter.yaml</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sources</span><span class="kw">:</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">node_exporter</span><span class="kw">:</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> prometheus_scrape</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">endpoints</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;http://localhost:9100/metrics&quot;</span><span class="kw">]</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">scrape_interval_secs</span><span class="kw">:</span><span class="at"> </span><span class="dv">15</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co"># sinks/prometheus.yaml</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="fu">sinks</span><span class="kw">:</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">prometheus_out</span><span class="kw">:</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> prometheus_remote_write</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">inputs</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;add_tags&quot;</span><span class="kw">]</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">endpoint</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;http://vm.example.com/api/v1/write&quot;</span></span></code></pre></div>
<p>拆分后可独立修改某个采集器配置，便于模块化维护和热更新。</p>
<h2 id="高负载下的可靠性机制">3. 高负载下的可靠性机制</h2>
<p>Vector 在高负载场景中通过多层保护减少数据丢失：</p>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th>机制</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>背压控制</td>
<td>当下游拥塞时暂停上游读取，防止爆仓</td>
</tr>
<tr>
<td>缓冲策略</td>
<td>支持内存或磁盘缓冲，<code>when_full = "block"</code>
默认阻塞而非丢弃</td>
</tr>
<tr>
<td>重试与限流</td>
<td>对 Loki、Prometheus 等 sink 内置重试与 backoff，支持
<code>rate_limit</code></td>
</tr>
<tr>
<td>降级策略</td>
<td><code>drop_on_full = false</code>，尽量保留数据</td>
</tr>
<tr>
<td>自监控指标</td>
<td><code>/metrics</code> 暴露
<code>events_dropped_total</code>、<code>buffer_overflows_total</code>
等指标供告警</td>
</tr>
</tbody>
</table>
<h2 id="采集器能力对比">4. 采集器能力对比</h2>
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr>
<th>特性/组件</th>
<th>node_exporter</th>
<th>process-exporter</th>
<th>DeepFlow Agent</th>
<th>Vector Agent</th>
</tr>
</thead>
<tbody>
<tr>
<td>安装体积</td>
<td>&lt;20MB</td>
<td>&lt;20MB</td>
<td>≈70–100MB</td>
<td>≈70MB</td>
</tr>
<tr>
<td>资源占用</td>
<td>极低</td>
<td>低</td>
<td>中等（依赖 eBPF）</td>
<td>低~中，可限内存</td>
</tr>
<tr>
<td>采集维度</td>
<td>主机资源</td>
<td>进程资源</td>
<td>网络四/七层</td>
<td>指标、日志、链路</td>
</tr>
<tr>
<td>输出能力</td>
<td>Prometheus</td>
<td>Prometheus</td>
<td>DeepFlow Collector</td>
<td>Prometheus、Loki、Tempo 等</td>
</tr>
<tr>
<td>可靠性</td>
<td>无背压</td>
<td>无背压</td>
<td>重试有限</td>
<td>背压 + 缓冲 + 重试</td>
</tr>
</tbody>
</table>
<p>Vector 在可靠性、可扩展性与自观测能力上相较 DeepFlow Agent
更为成熟，后者适合作为网络事件探针。</p>
<h2 id="渐进式部署路线">5. 渐进式部署路线</h2>
<ol type="1">
<li><strong>平台自身稳定性</strong>：部署
node_exporter、process-exporter 与
Vector，先掌握主机与关键进程状态。</li>
<li><strong>网络可观测</strong>：引入 DeepFlow Agent，分析 L4/L7
流量，后端可用 ClickHouse + Grafana 展示。</li>
<li><strong>日志聚合</strong>：Vector 同步写入 Loki
或其他日志系统，辅助故障排查与审计。</li>
<li><strong>链路追踪</strong>：启用 Vector → Tempo 或 OTLP，将 DeepFlow
产出的 trace 信息整合展示。</li>
<li><strong>示例 process-exporter 配置</strong>：
<code>yaml     process_names:       - name: "deepflow-agent"         cmdline: ["deepflow-agent"]       - name: "clickhouse"         cmdline: ["clickhouse-server"]</code></li>
</ol>
<h2 id="server-端存储选型">6. Server 端存储选型</h2>
<p>为了在后端构建统一、弹性、低成本的可观测平台，可按数据类型选用以下组件：</p>
<h3 id="metricsvictoriametrics">Metrics：VictoriaMetrics</h3>
<ul>
<li><strong>优势</strong>：单机即可实现百万点/秒写入，兼容
PromQL，支持自动压缩并将历史数据归档到 S3/GCS。</li>
<li><strong>采集建议</strong>：使用 <code>vmagent</code> 或 Vector
远程写入，也可通过 otel-collector 接入 OpenTelemetry Metrics。</li>
</ul>
<h3 id="logsloki">Logs：Loki</h3>
<ul>
<li><strong>优势</strong>：基于标签的索引方式，运行成本低；原生支持
Vector、Fluent Bit、Promtail 等采集器，兼容结构化与非结构化日志。</li>
<li><strong>采集建议</strong>：通过 Vector 统一收集 journald
与文件日志，按主机和应用维度设置标签，可配置 S3 归档策略。</li>
</ul>
<h3 id="tracestempo">Traces：Tempo</h3>
<ul>
<li><strong>优势</strong>：兼容 OTLP、Zipkin、Jaeger
协议；依赖对象存储实现冷热分层，资源占用极低，并能与 logs/metrics
自动关联。</li>
<li><strong>采集建议</strong>：应用直接使用 OpenTelemetry SDK，或经由
otel-collector、Vector 输出 OTLP 数据。</li>
</ul>
<h3 id="结构化数据postgresql可选">结构化数据：PostgreSQL（可选）</h3>
<ul>
<li><strong>用途</strong>：存储事件、审计、成本等业务数据，配合 Grafana
表格/统计面板做结构化分析。</li>
<li><strong>扩展</strong>：
<ul>
<li>TimescaleDB：增强时间序列查询能力。</li>
<li>pgvector：提供向量检索，可结合 AI 做相似事件分析。</li>
<li>postgres_fdw：整合多个 PostgreSQL 数据源。</li>
</ul></li>
</ul>
<h3 id="推荐部署组合">推荐部署组合</h3>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>数据类型</th>
<th>后端存储</th>
<th>采集/转发组件</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Metrics</td>
<td>VictoriaMetrics</td>
<td>vmagent / Vector</td>
<td>远程写入并归档到对象存储</td>
</tr>
<tr>
<td>Logs</td>
<td>Loki</td>
<td>Vector</td>
<td>按小时本地留存，按日归档到 S3</td>
</tr>
<tr>
<td>Traces</td>
<td>Tempo</td>
<td>otel-collector / Vector</td>
<td>可按需采样与压缩</td>
</tr>
<tr>
<td>结构化数据</td>
<td>PostgreSQL (+Timescale)</td>
<td>应用或 ETL</td>
<td>用于业务事件与分析</td>
</tr>
</tbody>
</table>
<h3 id="组合优势">组合优势</h3>
<ul>
<li><strong>统一采集</strong>：Vector
汇聚日志、指标、链路三类数据，再转发至不同后端。</li>
<li><strong>安全加密</strong>：各组件均支持 TLS 与 Token 鉴权。</li>
<li><strong>高性能、低成本</strong>：组件均为原生二进制部署，可使用对象存储做冷数据归档。</li>
<li><strong>Grafana
统一展示</strong>：VictoriaMetrics、Loki、Tempo、PostgreSQL
均为官方数据源，可在 Grafana 中集中呈现。</li>
</ul>
<h2 id="总结-1">7. 总结</h2>
<p>通过 Vector
构建统一采集出口，可在保证稳定性的同时整合指标、日志、链路与结构化数据。DeepFlow
Agent
专注网络可观测，结合推荐的后端存储组件，可形成覆盖系统到业务的完整可观测体系。</p>
<h1 id="技术选型对比">技术选型对比</h1>
<h2 id="边缘采集对比">边缘采集对比</h2>
<h2 id="网关对比">网关对比</h2>
<h2 id="存储对比">存储对比</h2>
<h2 id="分析层对比">分析层对比</h2>
<h1 id="总体架构设计-1">总体架构设计</h1>
<h2 id="边缘采集与缓冲">边缘采集与缓冲</h2>
<h2 id="区域网关与扇出">区域网关与扇出</h2>
<h2 id="存储与分析层">存储与分析层</h2>
<h2 id="双链路近线检索-kafka-回放">双链路（近线检索 + Kafka 回放）</h2>
<h1 id="多区域架构与区域内拓扑-1">多区域架构与区域内拓扑</h1>
<h2 id="区域内拓扑单区示例">区域内拓扑（单区示例）</h2>
<h2 id="多区域部署模式主区-从区">多区域部署模式（主区 + 从区）</h2>
<h2 id="联邦查询与统一入口">联邦查询与统一入口</h2>
<h1
id="端到端可靠传输设计at-least-once-语义-1">端到端可靠传输设计（At-least-once
语义）</h1>
<h2 id="多级持久化链vector-otel-kafka-openobserve">多级持久化链（Vector
→ OTel → Kafka → OpenObserve）</h2>
<h2 id="扇出与去重策略event_id-upsert">扇出与去重策略（event_id +
UPSERT）</h2>
<h2 id="sre-可观测与演练方法">SRE 可观测与演练方法</h2>
<h1 id="postgresql-二级分析域-1">PostgreSQL 二级分析域</h1>
<ul>
<li>时序分析（TimescaleDB 连续聚合）</li>
<li>向量检索（pgvector）</li>
<li>图查询（Apache AGE）</li>
<li>高基数与 TopK 分析（HLL/Toolkit）</li>
</ul>
<h1
id="it咖啡馆全栈可观测数据库设计">IT咖啡馆｜全栈可观测数据库设计</h1>
<blockquote>
<p>线 I/O 面交给 OpenObserve（OO），治理/知识面沉到 PostgreSQL
栈（Timescale + AGE + pgvector）。保留明细在
OO，只把聚合、摘要、索引与证据链写回 PG：既省钱、又好查、也好演进。</p>
</blockquote>
<hr />
<h2 id="摘要">摘要</h2>
<p>本文落地一套「全栈可观测」数据库设计：明细进 OO，PG 仅存 12
张核心表（维度、定位符、指标 1m、服务调用
5m、日志指纹/计数、拓扑时态、知识库、事件/证据），并用 AGE
维护“当前服务级调用图”。给出可直接执行的
DDL、保留与压缩策略、典型查询与接入流程。</p>
<hr />
<h2 id="设计目标">设计目标</h2>
<ul>
<li><strong>最小化</strong>：仅保 1m 指标聚合、5m
服务调用/日志计数；图仅保“当前 10 分钟活跃边”。</li>
<li><strong>可扩展</strong>：OO 扛明细与重计算；PG
通过加列/并行表横向扩展。</li>
<li><strong>可解释</strong>：事件只挂索引与证据链；需要原文用 oo_locator
反查 OO。</li>
</ul>
<h3 id="分层原则">分层原则</h3>
<ul>
<li><strong>线 I/O 面（近线）</strong>：OO（对象存 + 列式 +
低成本长期留存）。</li>
<li><strong>治理/知识面</strong>：PG（Timescale 连续聚合/压缩、AGE
图、pgvector 检索）。</li>
</ul>
<hr />
<h2 id="数据模型总览12-表-age">数据模型总览（12 表 + AGE）</h2>
<p><strong>维度（2）</strong>：<code>dim_tenant</code>、<code>dim_resource</code></p>
<p><strong>定位符（1）</strong>：<code>oo_locator</code>（对象存路径 +
时间窗 + 查询 hint）</p>
<p><strong>聚合（3）</strong>：<code>metric_1m</code>、<code>service_call_5m</code>、<code>log_pattern_5m</code>；</p>
<p><strong>指纹（1）</strong>：<code>log_pattern</code></p>
<p><strong>拓扑（1）</strong>：<code>topo_edge_time</code>（边 +
有效期）</p>
<p><strong>知识（2）</strong>：<code>kb_doc</code>、<code>kb_chunk</code>（HNSW
向量索引）</p>
<p><strong>事件（2）</strong>：<code>event_envelope</code>、<code>evidence_link</code></p>
<p><strong>图（AGE）</strong>：仅维护“服务级调用图”的活跃子图（10
分钟窗口）。</p>
<blockquote>
<p>注：日志明细、trace span、指标原始点位 <strong>不入
PG</strong>，统一留在 OO。</p>
</blockquote>
<hr />
<h2 id="表设计与策略逐表解读">表设计与策略（逐表解读）</h2>
<h3 id="维度">1）维度</h3>
<ul>
<li><code>dim_tenant</code>：租户/域；用 <code>code</code>
做业务唯一键。</li>
<li><code>dim_resource</code>：统一资源 URN（如
<code>urn:k8s:svc:ns/name</code>），含环境/区域/标签。</li>
</ul>
<p><strong>策略</strong>：</p>
<ul>
<li>为 <code>type</code>、<code>labels</code> 建索引（B-Tree +
GIN），支撑过滤与聚合。</li>
<li>跨区/多租户时，尽量靠 <code>tenant_id</code> 分片路由。</li>
</ul>
<hr />
<h3 id="oo-定位符">2）OO 定位符</h3>
<ul>
<li><code>oo_locator</code>：只存
<strong>对象存路径</strong>、<strong>时间窗</strong>、<strong>查询
hint</strong>，作为“回查线索”。</li>
</ul>
<p><strong>策略</strong>：</p>
<ul>
<li>与聚合表通过 <code>sample_ref</code> 关联，形成“摘要 →
原文”的证据链。</li>
</ul>
<hr />
<h3 id="指标聚合1-分钟">3）指标聚合（1 分钟）</h3>
<ul>
<li><code>metric_1m</code>：按资源、指标名保 <code>avg/max/p95</code>
常用统计，Timescale Hypertable。</li>
</ul>
<p><strong>策略</strong>：</p>
<ul>
<li><strong>压缩</strong>：7 天后压缩；</li>
<li><strong>留存</strong>：180 天；</li>
<li><strong>索引</strong>：<code>(resource_id, metric, bucket desc)</code>
+ <code>labels</code> GIN。</li>
</ul>
<hr />
<h3 id="服务级调用聚合5-分钟">4）服务级调用聚合（5 分钟）</h3>
<ul>
<li><code>service_call_5m</code>：A→B 的
<code>rps/err_rate/p50/p95</code>，主键含窗口/租户/边端点。</li>
</ul>
<p><strong>用途</strong>：</p>
<ul>
<li>报表/拓扑；</li>
<li>刷新 AGE “活跃调用图”。</li>
</ul>
<p><strong>策略</strong>：留存 365 天，适配容量评估与 SLO 分析。</p>
<hr />
<h3 id="日志指纹计数5-分钟">5）日志指纹/计数（5 分钟）</h3>
<ul>
<li><code>log_pattern</code>：指纹模板库（去重 + 样例 + 严重级 + 抽取
schema），<code>pg_trgm</code> 支持模糊。</li>
<li><code>log_pattern_5m</code>：每 5
分钟的计数与错误计数；<strong>不存明细</strong>。</li>
</ul>
<p><strong>策略</strong>：</p>
<ul>
<li>借 <code>sample_ref</code> 反查 OO 原文；</li>
<li>留存 180 天。</li>
</ul>
<hr />
<h3 id="拓扑时态">6）拓扑时态</h3>
<ul>
<li><code>topo_edge_time</code>：边 + 有效期
<code>tstzrange</code>，用于追溯“某时刻的拓扑”。</li>
</ul>
<p><strong>策略</strong>：</p>
<ul>
<li><code>btree_gist</code> + GIST 范围索引，支持按时间窗口查询。</li>
</ul>
<hr />
<h3 id="知识库-向量">7）知识库 / 向量</h3>
<ul>
<li><code>kb_doc</code>：文档元信息（来源、标题、URL、元数据）。</li>
<li><code>kb_chunk</code>：切片 +
向量（<code>vector(1536)</code>），<code>USING hnsw</code>
建立近似检索。</li>
</ul>
<p><strong>策略</strong>：</p>
<ul>
<li>以 <code>tenant_id/资源/时间</code>
作为结构化过滤条件，向量召回后再二次排序。</li>
</ul>
<hr />
<h3 id="事件与证据链">8）事件与证据链</h3>
<ul>
<li><code>event_envelope</code>：事件封套（时间/资源/严重级/类型/摘要/标签/指纹）。</li>
<li><code>evidence_link</code>：<strong>多态引用</strong>到 PG 记录或
<code>oo_locator</code>，串起证据链。</li>
</ul>
<p><strong>关键修正</strong>：</p>
<ul>
<li>PostgreSQL <strong>主键不允许表达式</strong>，因此
<code>evidence_link</code> 使用 <strong>自增主键 + 唯一索引（基于 ref_pg
的 hash + ref_oo）</strong> 实现“幂等去重”。详见附录 DDL。</li>
</ul>
<hr />
<h2 id="图只维护当前-10-分钟活跃调用图">图：只维护“当前 10
分钟活跃调用图”</h2>
<ul>
<li>从 <code>service_call_5m</code> 挑选近 10
分钟活跃边（按租户/边聚合），用 AGE 的 <code>MERGE</code> 同步：
<ul>
<li>点：<code>(:Resource {tenant_id, resource_id})</code></li>
<li>边：<code>[:CALLS {last_seen, rps, err_rate, p95}]</code></li>
</ul></li>
<li>图用于
<strong>k-hop、最短路、影响面</strong>，而不是长期时序（时序仍在
<code>service_call_5m</code> &amp; <code>topo_edge_time</code>）。</li>
</ul>
<hr />
<h2 id="最小化接入流程">最小化接入流程</h2>
<p><strong>写入</strong>：</p>
<ol type="1">
<li>明细 → OO（logs/traces/metrics）；</li>
<li>近线作业在 OO 内计算聚合：写入
<code>metric_1m</code>、<code>service_call_5m</code>、<code>log_pattern_5m</code>；</li>
<li>同步 <code>oo_locator</code>（对象路径 + 时间窗 + hint）；</li>
<li>用聚合结果刷新 AGE 活跃调用图。</li>
</ol>
<p><strong>读取</strong>：</p>
<ul>
<li>近线排障：先看 <code>metric_1m</code> / <code>log_pattern_5m</code>
/ <code>service_call_5m</code>；</li>
<li>影响面/最短路：走 AGE；</li>
<li>需要原文：根据 <code>sample_ref</code> /
<code>evidence_link.ref_oo</code> 反查 OO。</li>
</ul>
<p><strong>默认留存</strong>：</p>
<ul>
<li><code>metric_1m</code>：180 天；<code>service_call_5m</code>：365
天；<code>log_pattern_5m</code>：180 天；</li>
<li>OO 明细：30–180 天或更久（对象存便宜）。</li>
</ul>
<hr />
<h2 id="典型查询">典型查询</h2>
<p><strong>1）过去 30 分钟某服务下游 Top‑5 慢/错依赖</strong></p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> d.urn <span class="kw">AS</span> dst, <span class="fu">avg</span>(p95_ms) <span class="kw">AS</span> p95, <span class="fu">avg</span>(err_rate) <span class="kw">AS</span> err</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> service_call_5m c</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> dim_resource s <span class="kw">ON</span> s.resource_id <span class="op">=</span> c.src_resource_id</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> dim_resource d <span class="kw">ON</span> d.resource_id <span class="op">=</span> c.dst_resource_id</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> s.urn <span class="op">=</span> $service_urn</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> c.bucket <span class="op">&gt;=</span> now() <span class="op">-</span> <span class="dt">interval</span> <span class="st">&#39;30 minutes&#39;</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> d.urn</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> p95 <span class="kw">DESC</span>, err <span class="kw">DESC</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">5</span>;</span></code></pre></div>
<p><strong>2）按事件拉取证据（含 OO 回查线索）</strong></p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> e.event_id, e.title, e.detected_at, r.urn,</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>       ev.dim, ev.ref_pg, ol.bucket, ol.object_key, ol.query_hint</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> event_envelope e</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> dim_resource r <span class="kw">ON</span> r.resource_id <span class="op">=</span> e.resource_id</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> evidence_link ev <span class="kw">ON</span> ev.event_id <span class="op">=</span> e.event_id</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> oo_locator   ol <span class="kw">ON</span> ol.<span class="kw">id</span> <span class="op">=</span> ev.ref_oo</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> e.event_id <span class="op">=</span> $<span class="dv">1</span>;</span></code></pre></div>
<p><strong>3）恢复“某一时刻”的服务级拓扑</strong></p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> s.urn <span class="kw">AS</span> src, d.urn <span class="kw">AS</span> dst, t.relation</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> topo_edge_time t</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> dim_resource s <span class="kw">ON</span> s.resource_id <span class="op">=</span> t.src_resource_id</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> dim_resource d <span class="kw">ON</span> d.resource_id <span class="op">=</span> t.dst_resource_id</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> t.tenant_id <span class="op">=</span> $tenant</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> t.valid @<span class="op">&gt;</span> $timestamp:<span class="ch">:timestamptz</span>;</span></code></pre></div>
<hr />
<h2 id="与全塞-pg的对比">与「全塞 PG」的对比</h2>
<ul>
<li><strong>成本</strong>：明细不上 PG，写入抖动与存储爆炸显著降低；OO
对象存更省。</li>
<li><strong>性能</strong>：常用报表/排障命中 1m/5m 聚合；图遍历走
AGE；需要原文精准回查。</li>
<li><strong>演进</strong>：加维度/指标只需
<strong>加列/新表</strong>；图/向量索引也可独立扩展。</li>
</ul>
<hr />
<h2 id="运维与演进建议">运维与演进建议</h2>
<ul>
<li><strong>Timescale</strong>：启用压缩 + 连续聚合（如需），按 7D/30D
切分 Chunk；</li>
<li><strong>索引</strong>：B‑Tree（时间倒序复合）+ GIN（labels）+
HNSW（向量）；</li>
<li><strong>多租户</strong>：路由以 <code>tenant_id</code>
优先；必要时做 schema‑per‑tenant；</li>
<li><strong>幂等</strong>：聚合写入用
<code>ON CONFLICT</code>；<code>evidence_link</code>
采用哈希唯一索引去重；</li>
<li><strong>数据治理</strong>：严格区分“摘要/索引/证据”与“明细”；</li>
<li><strong>备份</strong>：PG 常规备份；OO 走对象存生命周期策略；</li>
<li><strong>安全</strong>：表级 RLS（Row Level
Security）可选；<code>labels</code> 与 <code>metadata</code>
控敏字段打码。</li>
</ul>
<hr />
<h2 id="附录-a可直接执行的-ddl含扩展索引策略">附录 A：可直接执行的
DDL（含扩展/索引/策略）</h2>
<div class="sourceCode" id="cb30"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- 0) 扩展（一次性）</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION <span class="cf">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> timescaledb;</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION <span class="cf">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> pg_trgm;</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION <span class="cf">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> pgcrypto;  <span class="co">-- gen_random_uuid</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION <span class="cf">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> vector;</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION <span class="cf">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> age;       <span class="co">-- 图扩展（服务级调用图）</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>LOAD <span class="st">&#39;age&#39;</span>;</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION <span class="cf">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> btree_gist; <span class="co">-- 用于时态拓扑范围索引</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- 1) 维度（2）</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> dim_tenant (</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>  tenant_id   BIGSERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>  code        TEXT <span class="kw">UNIQUE</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>  name        TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>  labels      JSONB <span class="kw">DEFAULT</span> <span class="st">&#39;{}&#39;</span>:<span class="ch">:jsonb</span>,</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  created_at  TIMESTAMPTZ <span class="kw">DEFAULT</span> now()</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> dim_resource (</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>  resource_id BIGSERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>  tenant_id   BIGINT <span class="kw">REFERENCES</span> dim_tenant(tenant_id),</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>  urn         TEXT <span class="kw">UNIQUE</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">type</span>        TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>  name        TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>  env         TEXT,</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>  region      TEXT,</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>  <span class="dt">zone</span>        TEXT,</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>  labels      JSONB <span class="kw">DEFAULT</span> <span class="st">&#39;{}&#39;</span>:<span class="ch">:jsonb</span>,</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>  created_at  TIMESTAMPTZ <span class="kw">DEFAULT</span> now()</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_res_type <span class="kw">ON</span> dim_resource(<span class="kw">type</span>);</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_res_labels_gin <span class="kw">ON</span> dim_resource <span class="kw">USING</span> GIN(labels);</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a><span class="co">-- 2) OO 定位符（1）</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> oo_locator (</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span>          BIGSERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>  tenant_id   BIGINT <span class="kw">REFERENCES</span> dim_tenant(tenant_id),</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>  dataset     TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,             <span class="co">-- logs / traces / metrics</span></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>  bucket      TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>  object_key  TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>  t_from      TIMESTAMPTZ <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>  t_to        TIMESTAMPTZ <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>  query_hint  TEXT,</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>  <span class="kw">attributes</span>  JSONB <span class="kw">DEFAULT</span> <span class="st">&#39;{}&#39;</span>:<span class="ch">:jsonb</span></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_oo_time <span class="kw">ON</span> oo_locator(dataset, t_from, t_to);</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a><span class="co">-- 3) 指标聚合（1m，Hypertable）</span></span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> metric_1m (</span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>  bucket       TIMESTAMPTZ <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>  tenant_id    BIGINT <span class="kw">REFERENCES</span> dim_tenant(tenant_id),</span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>  resource_id  BIGINT <span class="kw">REFERENCES</span> dim_resource(resource_id),</span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>  metric       TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a>  avg_val      <span class="dt">DOUBLE</span> <span class="dt">PRECISION</span>,</span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>  max_val      <span class="dt">DOUBLE</span> <span class="dt">PRECISION</span>,</span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>  p95_val      <span class="dt">DOUBLE</span> <span class="dt">PRECISION</span>,</span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>  labels       JSONB <span class="kw">DEFAULT</span> <span class="st">&#39;{}&#39;</span>:<span class="ch">:jsonb</span></span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> create_hypertable(<span class="st">&#39;metric_1m&#39;</span>,<span class="st">&#39;bucket&#39;</span>,chunk_time_interval <span class="op">=&gt;</span> <span class="dt">interval</span> <span class="st">&#39;7 days&#39;</span>);</span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_metric_key <span class="kw">ON</span> metric_1m(resource_id, metric, bucket <span class="kw">DESC</span>);</span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_metric_labels <span class="kw">ON</span> metric_1m <span class="kw">USING</span> GIN(labels);</span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> metric_1m <span class="kw">SET</span> (</span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a>  timescaledb.<span class="kw">compress</span>,</span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a>  timescaledb.compress_segmentby <span class="op">=</span> <span class="st">&#39;resource_id, metric&#39;</span>,</span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a>  timescaledb.compress_orderby   <span class="op">=</span> <span class="st">&#39;bucket&#39;</span></span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> add_compression_policy(<span class="st">&#39;metric_1m&#39;</span>, <span class="dt">INTERVAL</span> <span class="st">&#39;7 days&#39;</span>);</span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> add_retention_policy   (<span class="st">&#39;metric_1m&#39;</span>, <span class="dt">INTERVAL</span> <span class="st">&#39;180 days&#39;</span>);</span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a><span class="co">-- 4) 服务级调用聚合（5m，Hypertable）</span></span>
<span id="cb30-71"><a href="#cb30-71" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> service_call_5m (</span>
<span id="cb30-72"><a href="#cb30-72" aria-hidden="true" tabindex="-1"></a>  bucket          TIMESTAMPTZ <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a>  tenant_id       BIGINT <span class="kw">REFERENCES</span> dim_tenant(tenant_id),</span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a>  src_resource_id BIGINT <span class="kw">REFERENCES</span> dim_resource(resource_id),</span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a>  dst_resource_id BIGINT <span class="kw">REFERENCES</span> dim_resource(resource_id),</span>
<span id="cb30-76"><a href="#cb30-76" aria-hidden="true" tabindex="-1"></a>  rps             <span class="dt">DOUBLE</span> <span class="dt">PRECISION</span>,</span>
<span id="cb30-77"><a href="#cb30-77" aria-hidden="true" tabindex="-1"></a>  err_rate        <span class="dt">DOUBLE</span> <span class="dt">PRECISION</span>,</span>
<span id="cb30-78"><a href="#cb30-78" aria-hidden="true" tabindex="-1"></a>  p50_ms          <span class="dt">DOUBLE</span> <span class="dt">PRECISION</span>,</span>
<span id="cb30-79"><a href="#cb30-79" aria-hidden="true" tabindex="-1"></a>  p95_ms          <span class="dt">DOUBLE</span> <span class="dt">PRECISION</span>,</span>
<span id="cb30-80"><a href="#cb30-80" aria-hidden="true" tabindex="-1"></a>  sample_ref      BIGINT <span class="kw">REFERENCES</span> oo_locator(<span class="kw">id</span>),</span>
<span id="cb30-81"><a href="#cb30-81" aria-hidden="true" tabindex="-1"></a>  <span class="kw">PRIMARY</span> <span class="kw">KEY</span>(bucket, tenant_id, src_resource_id, dst_resource_id)</span>
<span id="cb30-82"><a href="#cb30-82" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb30-83"><a href="#cb30-83" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> create_hypertable(<span class="st">&#39;service_call_5m&#39;</span>,<span class="st">&#39;bucket&#39;</span>,chunk_time_interval <span class="op">=&gt;</span> <span class="dt">interval</span> <span class="st">&#39;30 days&#39;</span>);</span>
<span id="cb30-84"><a href="#cb30-84" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_call_src_dst <span class="kw">ON</span> service_call_5m(src_resource_id, dst_resource_id, bucket <span class="kw">DESC</span>);</span>
<span id="cb30-85"><a href="#cb30-85" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> add_retention_policy(<span class="st">&#39;service_call_5m&#39;</span>, <span class="dt">INTERVAL</span> <span class="st">&#39;365 days&#39;</span>);</span>
<span id="cb30-86"><a href="#cb30-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-87"><a href="#cb30-87" aria-hidden="true" tabindex="-1"></a><span class="co">-- 5) 日志指纹（去重）+ 5m 计数（2）</span></span>
<span id="cb30-88"><a href="#cb30-88" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> log_pattern (</span>
<span id="cb30-89"><a href="#cb30-89" aria-hidden="true" tabindex="-1"></a>  fingerprint_id  BIGSERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb30-90"><a href="#cb30-90" aria-hidden="true" tabindex="-1"></a>  tenant_id       BIGINT <span class="kw">REFERENCES</span> dim_tenant(tenant_id),</span>
<span id="cb30-91"><a href="#cb30-91" aria-hidden="true" tabindex="-1"></a>  pattern         TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb30-92"><a href="#cb30-92" aria-hidden="true" tabindex="-1"></a>  sample_message  TEXT,</span>
<span id="cb30-93"><a href="#cb30-93" aria-hidden="true" tabindex="-1"></a>  severity        TEXT,</span>
<span id="cb30-94"><a href="#cb30-94" aria-hidden="true" tabindex="-1"></a>  attrs_schema    JSONB <span class="kw">DEFAULT</span> <span class="st">&#39;{}&#39;</span>:<span class="ch">:jsonb</span>,</span>
<span id="cb30-95"><a href="#cb30-95" aria-hidden="true" tabindex="-1"></a>  first_seen      TIMESTAMPTZ,</span>
<span id="cb30-96"><a href="#cb30-96" aria-hidden="true" tabindex="-1"></a>  last_seen       TIMESTAMPTZ</span>
<span id="cb30-97"><a href="#cb30-97" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb30-98"><a href="#cb30-98" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_logpat_tenant <span class="kw">ON</span> log_pattern(tenant_id);</span>
<span id="cb30-99"><a href="#cb30-99" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_logpat_pattern_trgm <span class="kw">ON</span> log_pattern <span class="kw">USING</span> GIN (pattern gin_trgm_ops);</span>
<span id="cb30-100"><a href="#cb30-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-101"><a href="#cb30-101" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> log_pattern_5m (</span>
<span id="cb30-102"><a href="#cb30-102" aria-hidden="true" tabindex="-1"></a>  bucket         TIMESTAMPTZ <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb30-103"><a href="#cb30-103" aria-hidden="true" tabindex="-1"></a>  tenant_id      BIGINT <span class="kw">REFERENCES</span> dim_tenant(tenant_id),</span>
<span id="cb30-104"><a href="#cb30-104" aria-hidden="true" tabindex="-1"></a>  resource_id    BIGINT <span class="kw">REFERENCES</span> dim_resource(resource_id),</span>
<span id="cb30-105"><a href="#cb30-105" aria-hidden="true" tabindex="-1"></a>  fingerprint_id BIGINT <span class="kw">REFERENCES</span> log_pattern(fingerprint_id),</span>
<span id="cb30-106"><a href="#cb30-106" aria-hidden="true" tabindex="-1"></a>  count_total    BIGINT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb30-107"><a href="#cb30-107" aria-hidden="true" tabindex="-1"></a>  count_error    BIGINT <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="dv">0</span>,</span>
<span id="cb30-108"><a href="#cb30-108" aria-hidden="true" tabindex="-1"></a>  sample_ref     BIGINT <span class="kw">REFERENCES</span> oo_locator(<span class="kw">id</span>),</span>
<span id="cb30-109"><a href="#cb30-109" aria-hidden="true" tabindex="-1"></a>  <span class="kw">PRIMARY</span> <span class="kw">KEY</span>(bucket, tenant_id, resource_id, fingerprint_id)</span>
<span id="cb30-110"><a href="#cb30-110" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb30-111"><a href="#cb30-111" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> create_hypertable(<span class="st">&#39;log_pattern_5m&#39;</span>,<span class="st">&#39;bucket&#39;</span>,chunk_time_interval <span class="op">=&gt;</span> <span class="dt">interval</span> <span class="st">&#39;30 days&#39;</span>);</span>
<span id="cb30-112"><a href="#cb30-112" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_logpat5m_res <span class="kw">ON</span> log_pattern_5m(resource_id, bucket <span class="kw">DESC</span>);</span>
<span id="cb30-113"><a href="#cb30-113" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> add_retention_policy(<span class="st">&#39;log_pattern_5m&#39;</span>, <span class="dt">INTERVAL</span> <span class="st">&#39;180 days&#39;</span>);</span>
<span id="cb30-114"><a href="#cb30-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-115"><a href="#cb30-115" aria-hidden="true" tabindex="-1"></a><span class="co">-- 6) 拓扑时态（1）</span></span>
<span id="cb30-116"><a href="#cb30-116" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> topo_edge_time (</span>
<span id="cb30-117"><a href="#cb30-117" aria-hidden="true" tabindex="-1"></a>  tenant_id       BIGINT <span class="kw">REFERENCES</span> dim_tenant(tenant_id),</span>
<span id="cb30-118"><a href="#cb30-118" aria-hidden="true" tabindex="-1"></a>  src_resource_id BIGINT <span class="kw">REFERENCES</span> dim_resource(resource_id),</span>
<span id="cb30-119"><a href="#cb30-119" aria-hidden="true" tabindex="-1"></a>  dst_resource_id BIGINT <span class="kw">REFERENCES</span> dim_resource(resource_id),</span>
<span id="cb30-120"><a href="#cb30-120" aria-hidden="true" tabindex="-1"></a>  relation        TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb30-121"><a href="#cb30-121" aria-hidden="true" tabindex="-1"></a>  valid           tstzrange <span class="kw">NOT</span> <span class="kw">NULL</span>,  <span class="co">-- [from, to)</span></span>
<span id="cb30-122"><a href="#cb30-122" aria-hidden="true" tabindex="-1"></a>  props           JSONB <span class="kw">DEFAULT</span> <span class="st">&#39;{}&#39;</span>:<span class="ch">:jsonb</span>,</span>
<span id="cb30-123"><a href="#cb30-123" aria-hidden="true" tabindex="-1"></a>  <span class="kw">PRIMARY</span> <span class="kw">KEY</span>(tenant_id, src_resource_id, dst_resource_id, relation, valid)</span>
<span id="cb30-124"><a href="#cb30-124" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb30-125"><a href="#cb30-125" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_topo_valid <span class="kw">ON</span> topo_edge_time <span class="kw">USING</span> GIST (tenant_id, src_resource_id, dst_resource_id, valid);</span>
<span id="cb30-126"><a href="#cb30-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-127"><a href="#cb30-127" aria-hidden="true" tabindex="-1"></a><span class="co">-- 7) 知识库 / 向量（2）</span></span>
<span id="cb30-128"><a href="#cb30-128" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> kb_doc (</span>
<span id="cb30-129"><a href="#cb30-129" aria-hidden="true" tabindex="-1"></a>  doc_id     BIGSERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb30-130"><a href="#cb30-130" aria-hidden="true" tabindex="-1"></a>  tenant_id  BIGINT <span class="kw">REFERENCES</span> dim_tenant(tenant_id),</span>
<span id="cb30-131"><a href="#cb30-131" aria-hidden="true" tabindex="-1"></a>  <span class="kw">source</span>     TEXT,</span>
<span id="cb30-132"><a href="#cb30-132" aria-hidden="true" tabindex="-1"></a>  title      TEXT,</span>
<span id="cb30-133"><a href="#cb30-133" aria-hidden="true" tabindex="-1"></a>  url        TEXT,</span>
<span id="cb30-134"><a href="#cb30-134" aria-hidden="true" tabindex="-1"></a>  metadata   JSONB <span class="kw">DEFAULT</span> <span class="st">&#39;{}&#39;</span>:<span class="ch">:jsonb</span>,</span>
<span id="cb30-135"><a href="#cb30-135" aria-hidden="true" tabindex="-1"></a>  created_at TIMESTAMPTZ <span class="kw">DEFAULT</span> now()</span>
<span id="cb30-136"><a href="#cb30-136" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb30-137"><a href="#cb30-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-138"><a href="#cb30-138" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> kb_chunk (</span>
<span id="cb30-139"><a href="#cb30-139" aria-hidden="true" tabindex="-1"></a>  chunk_id   BIGSERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb30-140"><a href="#cb30-140" aria-hidden="true" tabindex="-1"></a>  doc_id     BIGINT <span class="kw">REFERENCES</span> kb_doc(doc_id) <span class="kw">ON</span> <span class="kw">DELETE</span> <span class="kw">CASCADE</span>,</span>
<span id="cb30-141"><a href="#cb30-141" aria-hidden="true" tabindex="-1"></a>  chunk_idx  <span class="dt">INT</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb30-142"><a href="#cb30-142" aria-hidden="true" tabindex="-1"></a>  content    TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb30-143"><a href="#cb30-143" aria-hidden="true" tabindex="-1"></a>  embedding  vector(<span class="dv">1536</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb30-144"><a href="#cb30-144" aria-hidden="true" tabindex="-1"></a>  metadata   JSONB <span class="kw">DEFAULT</span> <span class="st">&#39;{}&#39;</span>:<span class="ch">:jsonb</span></span>
<span id="cb30-145"><a href="#cb30-145" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb30-146"><a href="#cb30-146" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_kb_chunk_doc <span class="kw">ON</span> kb_chunk(doc_id, chunk_idx);</span>
<span id="cb30-147"><a href="#cb30-147" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_kb_chunk_meta <span class="kw">ON</span> kb_chunk <span class="kw">USING</span> GIN(metadata);</span>
<span id="cb30-148"><a href="#cb30-148" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_kb_vec_hnsw <span class="kw">ON</span> kb_chunk <span class="kw">USING</span> hnsw (embedding vector_l2_ops);</span>
<span id="cb30-149"><a href="#cb30-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-150"><a href="#cb30-150" aria-hidden="true" tabindex="-1"></a><span class="co">-- 8) 事件 &amp; 证据链（2）</span></span>
<span id="cb30-151"><a href="#cb30-151" aria-hidden="true" tabindex="-1"></a>DO $$ <span class="cf">BEGIN</span></span>
<span id="cb30-152"><a href="#cb30-152" aria-hidden="true" tabindex="-1"></a>  <span class="cf">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> (<span class="kw">SELECT</span> <span class="dv">1</span> <span class="kw">FROM</span> pg_type <span class="kw">WHERE</span> typname <span class="op">=</span> <span class="st">&#39;severity&#39;</span>) <span class="cf">THEN</span></span>
<span id="cb30-153"><a href="#cb30-153" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CREATE</span> <span class="kw">TYPE</span> severity <span class="kw">AS</span> ENUM (<span class="st">&#39;TRACE&#39;</span>,<span class="st">&#39;DEBUG&#39;</span>,<span class="st">&#39;INFO&#39;</span>,<span class="st">&#39;WARN&#39;</span>,<span class="st">&#39;ERROR&#39;</span>,<span class="st">&#39;FATAL&#39;</span>);</span>
<span id="cb30-154"><a href="#cb30-154" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb30-155"><a href="#cb30-155" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> $$;</span>
<span id="cb30-156"><a href="#cb30-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-157"><a href="#cb30-157" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> event_envelope (</span>
<span id="cb30-158"><a href="#cb30-158" aria-hidden="true" tabindex="-1"></a>  event_id     UUID <span class="kw">PRIMARY</span> <span class="kw">KEY</span> <span class="kw">DEFAULT</span> gen_random_uuid(),</span>
<span id="cb30-159"><a href="#cb30-159" aria-hidden="true" tabindex="-1"></a>  detected_at  TIMESTAMPTZ <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> now(),</span>
<span id="cb30-160"><a href="#cb30-160" aria-hidden="true" tabindex="-1"></a>  tenant_id    BIGINT <span class="kw">REFERENCES</span> dim_tenant(tenant_id),</span>
<span id="cb30-161"><a href="#cb30-161" aria-hidden="true" tabindex="-1"></a>  resource_id  BIGINT <span class="kw">REFERENCES</span> dim_resource(resource_id),</span>
<span id="cb30-162"><a href="#cb30-162" aria-hidden="true" tabindex="-1"></a>  severity     severity <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb30-163"><a href="#cb30-163" aria-hidden="true" tabindex="-1"></a>  kind         TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,     <span class="co">-- anomaly/slo_violation/deploy/incident/...</span></span>
<span id="cb30-164"><a href="#cb30-164" aria-hidden="true" tabindex="-1"></a>  title        TEXT,</span>
<span id="cb30-165"><a href="#cb30-165" aria-hidden="true" tabindex="-1"></a>  <span class="kw">summary</span>      TEXT,</span>
<span id="cb30-166"><a href="#cb30-166" aria-hidden="true" tabindex="-1"></a>  labels       JSONB <span class="kw">DEFAULT</span> <span class="st">&#39;{}&#39;</span>:<span class="ch">:jsonb</span>,</span>
<span id="cb30-167"><a href="#cb30-167" aria-hidden="true" tabindex="-1"></a>  fingerprints JSONB <span class="kw">DEFAULT</span> <span class="st">&#39;{}&#39;</span>:<span class="ch">:jsonb</span></span>
<span id="cb30-168"><a href="#cb30-168" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb30-169"><a href="#cb30-169" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_event_time <span class="kw">ON</span> event_envelope(tenant_id, detected_at <span class="kw">DESC</span>);</span>
<span id="cb30-170"><a href="#cb30-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-171"><a href="#cb30-171" aria-hidden="true" tabindex="-1"></a><span class="co">-- 注意：主键不能用表达式，改为自增 + 唯一索引（ref_pg 哈希 + ref_oo）</span></span>
<span id="cb30-172"><a href="#cb30-172" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> evidence_link (</span>
<span id="cb30-173"><a href="#cb30-173" aria-hidden="true" tabindex="-1"></a>  evidence_id BIGSERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb30-174"><a href="#cb30-174" aria-hidden="true" tabindex="-1"></a>  event_id    UUID <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">REFERENCES</span> event_envelope(event_id) <span class="kw">ON</span> <span class="kw">DELETE</span> <span class="kw">CASCADE</span>,</span>
<span id="cb30-175"><a href="#cb30-175" aria-hidden="true" tabindex="-1"></a>  dim         TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,  <span class="co">-- metric/log/trace/topo/kb</span></span>
<span id="cb30-176"><a href="#cb30-176" aria-hidden="true" tabindex="-1"></a>  ref_pg      JSONB,          <span class="co">-- {&quot;table&quot;:&quot;...&quot;,&quot;keys&quot;:{...}}</span></span>
<span id="cb30-177"><a href="#cb30-177" aria-hidden="true" tabindex="-1"></a>  ref_oo      BIGINT <span class="kw">REFERENCES</span> oo_locator(<span class="kw">id</span>),</span>
<span id="cb30-178"><a href="#cb30-178" aria-hidden="true" tabindex="-1"></a>  note        TEXT,</span>
<span id="cb30-179"><a href="#cb30-179" aria-hidden="true" tabindex="-1"></a>  ref_pg_hash TEXT <span class="kw">GENERATED</span> ALWAYS <span class="kw">AS</span> (md5(<span class="fu">coalesce</span>(ref_pg:<span class="ch">:text</span>, <span class="st">&#39;&#39;</span>))) STORED</span>
<span id="cb30-180"><a href="#cb30-180" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb30-181"><a href="#cb30-181" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">UNIQUE</span> <span class="kw">INDEX</span> ux_evidence_unique</span>
<span id="cb30-182"><a href="#cb30-182" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ON</span> evidence_link(event_id, dim, ref_pg_hash, <span class="fu">coalesce</span>(ref_oo, <span class="dv">0</span>));</span>
<span id="cb30-183"><a href="#cb30-183" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_evidence_event <span class="kw">ON</span> evidence_link(event_id);</span>
<span id="cb30-184"><a href="#cb30-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-185"><a href="#cb30-185" aria-hidden="true" tabindex="-1"></a><span class="co">-- AGE 图：初始化（一次）</span></span>
<span id="cb30-186"><a href="#cb30-186" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> create_graph(<span class="st">&#39;ops&#39;</span>);</span>
<span id="cb30-187"><a href="#cb30-187" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> create_vlabel(<span class="st">&#39;ops&#39;</span>, <span class="st">&#39;Resource&#39;</span>);</span>
<span id="cb30-188"><a href="#cb30-188" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> create_elabel(<span class="st">&#39;ops&#39;</span>, <span class="st">&#39;CALLS&#39;</span>);</span></code></pre></div>
<hr />
<h2 id="附录-bage-活跃调用图刷新示例">附录 B：AGE
活跃调用图刷新（示例）</h2>
<div class="sourceCode" id="cb31"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> active <span class="kw">AS</span> (</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> tenant_id, src_resource_id, dst_resource_id,</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>         <span class="fu">max</span>(bucket) <span class="kw">AS</span> last_seen,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>         <span class="fu">avg</span>(rps) <span class="kw">AS</span> rps, <span class="fu">avg</span>(err_rate) <span class="kw">AS</span> err_rate, <span class="fu">avg</span>(p95_ms) <span class="kw">AS</span> p95_ms</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> service_call_5m</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> bucket <span class="op">&gt;=</span> now() <span class="op">-</span> <span class="dt">interval</span> <span class="st">&#39;10 minutes&#39;</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> cypher(<span class="st">&#39;ops&#39;</span>, $$</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  UNWIND $rows <span class="kw">AS</span> <span class="kw">row</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">MERGE</span> (s<span class="ch">:Resource</span> {tenant_id: <span class="kw">row</span>.tenant_id, resource_id: <span class="kw">row</span>.src})</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">MERGE</span> (d<span class="ch">:Resource</span> {tenant_id: <span class="kw">row</span>.tenant_id, resource_id: <span class="kw">row</span>.dst})</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">MERGE</span> (s)<span class="op">-</span>[e<span class="ch">:CALLS</span>]<span class="op">-&gt;</span>(d)</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ON</span> <span class="kw">CREATE</span> <span class="kw">SET</span> e.first_seen <span class="op">=</span> <span class="kw">row</span>.last_seen</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SET</span> e.last_seen <span class="op">=</span> <span class="kw">row</span>.last_seen, e.rps <span class="op">=</span> <span class="kw">row</span>.rps, e.err_rate <span class="op">=</span> <span class="kw">row</span>.err_rate, e.p95 <span class="op">=</span> <span class="kw">row</span>.p95</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">RETURN</span> <span class="dv">1</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>$$) <span class="kw">AS</span> (ok <span class="dt">int</span>)</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>PARAMS (<span class="kw">rows</span> <span class="op">:=</span> (</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> json_agg(json_build_object(</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;tenant_id&#39;</span>, tenant_id, <span class="st">&#39;src&#39;</span>, src_resource_id, <span class="st">&#39;dst&#39;</span>, dst_resource_id,</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;last_seen&#39;</span>, last_seen, <span class="st">&#39;rps&#39;</span>, rps, <span class="st">&#39;err_rate&#39;</span>, err_rate, <span class="st">&#39;p95&#39;</span>, p95_ms))</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> active));</span></code></pre></div>
<hr />
<h2 id="收尾">收尾</h2>
<p>这套「OO 扛明细 + PG
扛治理」的极简方案能把近线排障、影响面分析与知识复用串成闭环：</p>
<ul>
<li><strong>快</strong>：常用分析直接命中 1m/5m 聚合与 AGE 图；</li>
<li><strong>省</strong>：明细留 OO，对象存生命周期策略友好；</li>
<li><strong>稳</strong>：PG
只承载“可解释的摘要与证据”，长期演进不怕重构。</li>
</ul>
<h1 id="多区域与容灾disaster-recovery-dr-1">多区域与容灾（Disaster
Recovery, DR）</h1>
<h2 id="接入与路由anycastgeodns">接入与路由（Anycast/GeoDNS）</h2>
<h2 id="跨区复制与镜像kafka-mirrormaker2">跨区复制与镜像（Kafka
MirrorMaker2）</h2>
<h2 id="阈值控制与降级策略">阈值控制与降级策略</h2>
<h2 id="历史回放与灰度演练">历史回放与灰度演练</h2>
<h1
id="from-monitoring-history-to-full-stack-observable-data-selection">From
Monitoring History to Full-Stack Observable Data Selection</h1>
<p>An overview of how monitoring evolved into modern full-stack
observability and the key considerations when choosing diverse data
sources.</p>
<h1 id="概述etl-oo2pg-age-活跃调用图-拓扑iacansible">1. 概述（ETL-OO2PG
&amp; AGE 活跃调用图 &amp; 拓扑/IaC/Ansible）</h1>
<pre><code>[exporter]                     [Vector]         [OTel GW]        [OpenObserve]
NE ─┐                      ┌─────────┐      ┌──────────┐     ┌─────────────┐
PE ─┼── metrics/logs ────&gt; │ Vector  │ ───&gt; │ OTel GW  │ ──&gt; │      OO      │
DF ─┤                      └─────────┘      └──────────┘     └─────────────┘
LG ─┘

                       (近线窗口 ETL: 对齐=1m · 延迟=2m)
                                        │
                                        ▼
                         ┌──────────────────────────────────────┐
 IaC/Cloud  ────────────&gt;│                                      │
                         │   ObserveBridge (ETL 任务)           │
 Ansible     ───────────&gt;│   • ETL 窗口聚合 / oo_locator        │
                         │   • 拓扑 (IaC/Ansible)               │
 OO 明细(OO→OB)  ───────&gt;│   • AGE 10 分钟活跃调用图刷新        │
                         └──────────────────────────────────────┘

┌─────────────────────────────── Postgres 套件 ───────────────────────────────┐
│   PG_JSONB            │   PG Aggregates (Timescale)   │  PG Vector  │  AGE   │
│ (oo_locator/events)   │ (metric_1m / call_5m / log_5m)│ (pgvector)  │ Graph  │
└───────────────┬────────┴───────────────┬──────────────┴─────────────┬────────┘
                │                        │                             │
                │                        │                             │
                ▼                        ▼                             ▼
                         [ llm-ops-agent / 应用消费（查询/检索/推理） ]</code></pre>
<p>目标：在<strong>单二进制 Go 编排器</strong>内，完成三条主干 ETL
闭环：</p>
<ul>
<li><strong>OO2PG（近线聚合）</strong>：从 OpenObserve（S3/API）读取
logs/metrics/traces 明细 → 聚合为
<code>metric_1m</code>、<code>service_call_5m</code>、<code>log_pattern_5m</code>，维护
<code>log_pattern</code> 指纹库与 <code>oo_locator</code>
回查线索。</li>
<li><strong>AGE 活跃调用图</strong>：以 <code>service_call_5m</code>
为源，刷新 AGE 图中 10 分钟<strong>活跃服务级调用边</strong>
<code>(:Resource)-[:CALLS]-&gt;(:Resource)</code>。</li>
<li><strong>拓扑 ETL（IaC/Ansible）</strong>：从 Terraform/Pulumi/Cloud
API 与 Ansible Playbook
抽取<strong>结构/应用依赖</strong>，以时态方式落入
<code>topo_edge_time</code>（开/关区间），可选同步到 AGE 作为
<code>:STRUCT</code> 边。</li>
</ul>
<p>调度特性：<strong>窗口对齐 + 延迟容忍 + DAG 依赖 + 幂等 Upsert +
分片多租户</strong>。</p>
<p>可靠性：PG
唯一索引保证<strong>一次性</strong>；指数退避重试；失败熔断；事件补数回放。</p>
<hr />
<h1 id="项目目录合并版">2. 项目目录（合并版）</h1>
<div class="sourceCode" id="cb33"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>etl<span class="op">/</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>├─ cmd<span class="op">/</span>etl<span class="op">/</span>                   # 二进制入口<span class="op">/</span>CLI</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>│  └─ main<span class="op">.</span><span class="at">go</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>├─ pkg<span class="op">/</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>│  ├─ scheduler<span class="op">/</span>              # 调度器（窗口计算<span class="op">/</span>派发）</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>│  ├─ runner<span class="op">/</span>                 # <span class="bu">Worker</span> 池 <span class="op">+</span> 执行<span class="op">/</span>重试<span class="op">/</span>回调</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>│  ├─ registry<span class="op">/</span>               # Job 接口 <span class="op">+</span> 注册中心 <span class="op">+</span> DAG</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>│  ├─ store<span class="op">/</span>                  # 状态<span class="op">/</span>一次性保证<span class="op">/</span>简易队列（PG）</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>│  ├─ <span class="bu">window</span><span class="op">/</span>                 # 时间对齐<span class="op">/</span>窗口工具</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>│  ├─ events<span class="op">/</span>                 # 事件入口（HTTP<span class="op">/</span>CloudEvents风格）</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>│  ├─ oo<span class="op">/</span>                     # OO 读取（S3 客户端 <span class="op">+</span> 查询 API 适配）</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>│  ├─ agg<span class="op">/</span>                    # 聚合器（指标1m <span class="op">/</span> 调用5m <span class="op">/</span> 指纹5m）</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>│  ├─ patterns<span class="op">/</span>               # 日志指纹挖掘（Drain <span class="op">/</span> RE2）</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>│  ├─ iac<span class="op">/</span>                    # IaC<span class="op">/</span>Cloud 归一（TF<span class="op">/</span>Pulumi<span class="op">/</span>aws<span class="op">/</span>aliyun…）</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>│  ├─ ansible<span class="op">/</span>                # Playbook<span class="op">/</span>Inventory 解析与依赖抽取</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>│  └─ pgw<span class="op">/</span>                    # PG 写入器（COPY 批量 <span class="op">+</span> 幂等 upsert）</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>├─ jobs<span class="op">/</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>│  ├─ ooagg<span class="op">.</span><span class="at">go</span>                # OO → metric_1m <span class="op">/</span> call_5m <span class="op">/</span> log_5m <span class="op">/</span> locator</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>│  ├─ age_refresh<span class="op">.</span><span class="at">go</span>          # 近10分钟活跃调用图刷新（依赖 ooagg）</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>│  ├─ topo_iac<span class="op">.</span><span class="at">go</span>             # IaC<span class="op">/</span>Cloud → topo_edge_time（时态差分）</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>│  └─ topo_ansible<span class="op">.</span><span class="at">go</span>         # Ansible → topo_edge_time（时态差分）</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>├─ sql<span class="op">/</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>│  └─ age_refresh<span class="op">.</span><span class="at">sql</span>         # AGE 刷新 SQL</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>└─ configs<span class="op">/</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>   └─ etl<span class="op">.</span><span class="at">yaml</span>                # 调度<span class="op">/</span>并发<span class="op">/</span>延迟 配置</span></code></pre></div>
<hr />
<h1 id="表模块总览合并表">3. 表/模块总览（合并表）</h1>
<blockquote>
<p>下面是<strong>模块—接口—数据源/目标—窗口/键—幂等</strong>的一览表（开发/联调用）。</p>
</blockquote>
<table style="width:100%;">
<colgroup>
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">模块</th>
<th style="text-align: left;">API/入口</th>
<th style="text-align: left;">SRC（输入）</th>
<th style="text-align: left;">DEST（输出）</th>
<th style="text-align: left;">窗口/键</th>
<th style="text-align: left;">幂等/唯一约束</th>
<th style="text-align: left;">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">pkg/oo</td>
<td style="text-align: left;">Stream(ctx, tenant, w, fn)</td>
<td style="text-align: left;">OO（S3 分区或查询
API）logs/metrics/traces</td>
<td style="text-align: left;">回调 oo.Record</td>
<td style="text-align: left;">w=[From,To)</td>
<td style="text-align: left;">—</td>
<td style="text-align: left;">统一时间/URN；并发读取</td>
</tr>
<tr>
<td style="text-align: left;">pkg/agg</td>
<td style="text-align: left;">Feed(rec) / Drain()</td>
<td style="text-align: left;">oo.Record</td>
<td style="text-align: left;">Metrics1m / Calls5m / LogPatterns5m /
PatternsUpsert / Locators</td>
<td style="text-align: left;">1m/5m</td>
<td style="text-align: left;">—</td>
<td style="text-align: left;">内存桶聚合、指纹抽取</td>
</tr>
<tr>
<td style="text-align: left;">pkg/pgw</td>
<td style="text-align: left;">Flush(ctx, tenant, w, out)</td>
<td style="text-align: left;">聚合结果 out</td>
<td
style="text-align: left;">metric_1m、service_call_5m、log_pattern_5m、log_pattern、oo_locator、dim_resource</td>
<td style="text-align: left;">1m/5m 主键</td>
<td style="text-align: left;">ON CONFLICT DO UPDATE；oo_locator
唯一</td>
<td style="text-align: left;">PG 批量 COPY + Upsert</td>
</tr>
<tr>
<td style="text-align: left;">jobs/ooagg</td>
<td style="text-align: left;">Run(ctx, tenant, w)</td>
<td style="text-align: left;">pkg/oo → pkg/agg</td>
<td style="text-align: left;">pkg/pgw.Flush</td>
<td style="text-align: left;">Align=1m；Delay=2m</td>
<td style="text-align: left;">由目标表主键保证</td>
<td style="text-align: left;">成功后触发 age-refresh</td>
</tr>
<tr>
<td style="text-align: left;">sql/age_refresh.sql</td>
<td style="text-align: left;">cypher(‘ops’, …)</td>
<td style="text-align: left;">service_call_5m 近10分钟</td>
<td style="text-align: left;">AGE 图 CALLS 边</td>
<td style="text-align: left;">10 分钟</td>
<td style="text-align: left;">MERGE 唯一匹配</td>
<td style="text-align: left;">e.last_seen/rps/err/p95</td>
</tr>
<tr>
<td style="text-align: left;">jobs/age_refresh</td>
<td style="text-align: left;">Run(ctx, tenant, w)</td>
<td style="text-align: left;">service_call_5m</td>
<td style="text-align: left;">执行 SQL</td>
<td style="text-align: left;">Align=5m</td>
<td style="text-align: left;">—</td>
<td style="text-align: left;">After()=“oo-agg”</td>
</tr>
<tr>
<td style="text-align: left;">pkg/iac</td>
<td style="text-align: left;">Discover(ctx, tenant)</td>
<td style="text-align: left;">TF/Pulumi/Cloud API</td>
<td style="text-align: left;">边集合 []Edge</td>
<td style="text-align: left;">—</td>
<td style="text-align: left;">—</td>
<td style="text-align: left;">构造 URN、relation</td>
</tr>
<tr>
<td style="text-align: left;">pkg/ansible</td>
<td style="text-align: left;">ExtractDeps(ctx, tenant)</td>
<td style="text-align: left;">inventory/group_vars/roles</td>
<td style="text-align: left;">边集合 []Edge</td>
<td style="text-align: left;">—</td>
<td style="text-align: left;">—</td>
<td style="text-align: left;">解析 upstream/连接串</td>
</tr>
<tr>
<td style="text-align: left;">pkg/pgw</td>
<td style="text-align: left;">UpsertTopoEdges(ctx, tenant, edges)</td>
<td style="text-align: left;">iac/ansible 边</td>
<td style="text-align: left;">topo_edge_time（时态）</td>
<td style="text-align: left;">valid tstzrange</td>
<td style="text-align: left;">PK(tenant,src,dst,rel,valid)</td>
<td style="text-align: left;">差分开/关区间</td>
</tr>
<tr>
<td style="text-align: left;">jobs/topo_iac</td>
<td style="text-align: left;">Run(ctx, tenant, w)</td>
<td style="text-align: left;">pkg/iac.Discover</td>
<td style="text-align: left;">topo_edge_time</td>
<td style="text-align: left;">Align=15m</td>
<td style="text-align: left;">—</td>
<td style="text-align: left;">结构拓扑</td>
</tr>
<tr>
<td style="text-align: left;">jobs/topo_ansible</td>
<td style="text-align: left;">Run(ctx, tenant, w)</td>
<td style="text-align: left;">pkg/ansible.ExtractDeps</td>
<td style="text-align: left;">topo_edge_time</td>
<td style="text-align: left;">Align=1h</td>
<td style="text-align: left;">—</td>
<td style="text-align: left;">应用依赖拓扑</td>
</tr>
<tr>
<td style="text-align: left;">pkg/events</td>
<td style="text-align: left;">/events/enqueue</td>
<td style="text-align: left;">CloudEvents/HTTP</td>
<td style="text-align: left;">etl_job_run 状态置 queued</td>
<td style="text-align: left;">任意窗口</td>
<td style="text-align: left;">ux_job_once</td>
<td style="text-align: left;">手动补数/回放</td>
</tr>
<tr>
<td style="text-align: left;">pkg/store</td>
<td style="text-align: left;">EnqueueOnce/Mark*</td>
<td style="text-align: left;">—</td>
<td style="text-align: left;">etl_job_run</td>
<td style="text-align: left;">job/tenant/window</td>
<td style="text-align: left;">ux_job_once</td>
<td style="text-align: left;">一次性保证/队列</td>
</tr>
<tr>
<td style="text-align: left;">pkg/scheduler</td>
<td style="text-align: left;">Tick()</td>
<td style="text-align: left;">dim_tenant &amp; etl_job_run</td>
<td style="text-align: left;">入队窗口</td>
<td style="text-align: left;">Align/Delay/Lookback</td>
<td style="text-align: left;">—</td>
<td style="text-align: left;">动态加载配置</td>
</tr>
</tbody>
</table>
<p><strong>相关 PG 表（12 + ETL 元数据）</strong></p>
<ul>
<li>维度：<code>dim_tenant</code>、<code>dim_resource</code></li>
<li>定位符：<code>oo_locator</code></li>
<li>聚合：<code>metric_1m</code>（1m）、<code>service_call_5m</code>（5m）、<code>log_pattern_5m</code>（5m）</li>
<li>指纹：<code>log_pattern</code></li>
<li>拓扑时态：<code>topo_edge_time</code></li>
<li>知识：<code>kb_doc</code>、<code>kb_chunk</code>（向量）</li>
<li>事件：<code>event_envelope</code>、<code>evidence_link</code></li>
<li>ETL
元数据：<code>etl_job_run</code>、<code>etl_job_circuit</code></li>
<li>AGE：<code>ops</code>
图（<code>Resource</code>、<code>CALLS</code>）</li>
</ul>
<hr />
<h1 id="设计要点与边界">4. 设计要点与边界</h1>
<ul>
<li><strong>窗口推进</strong>：<code>upper = floor(now - Delay, Align)</code>，从上次成功窗口末尾或
<code>initial_lookback</code> 起步。</li>
<li><strong>幂等写入</strong>：所有聚合表/计数表以主键覆盖；<code>log_pattern</code>
以 pattern hash 或唯一键 upsert；<code>oo_locator</code>
唯一组合避免重复。</li>
<li><strong>资源归一（URN）</strong>：标准化
<code>urn:k8s:svc:&lt;ns&gt;/&lt;name&gt;</code> /
<code>urn:host:&lt;host&gt;</code> /
<code>urn:db:postgres:&lt;cluster&gt;/&lt;db&gt;</code>，并缓存
<code>resource_id</code>。</li>
<li><strong>AGE 图只保活跃 10 分钟</strong>：长期时序仍在
<code>service_call_5m</code> 与 <code>topo_edge_time</code>。</li>
<li><strong>拓扑差分</strong>：用 <code>tstzrange</code>
开/关区间维护时态；当边消失时关闭上次开区间。</li>
</ul>
<hr />
<h1 id="codex-tasks落地清单">5. Codex Tasks（落地清单）</h1>
<blockquote>
<p>每个任务包含：<strong>name / 描述 / 测试-验证</strong>。可直接拆成
Codex 指令执行（create-or-update-files / patch），或作为 PR
checklist。</p>
</blockquote>
<h3 id="t1-完成-pkgpgw.flushcopy-upsert-批量写">T1 — 完成
<code>pkg/pgw.Flush</code>（COPY + Upsert 批量写）</h3>
<ul>
<li><strong>描述</strong>：实现资源 upsert、<code>oo_locator</code>
写入并回填
<code>sample_ref</code>；<code>metric_1m</code>/<code>service_call_5m</code>/<code>log_pattern</code>/<code>log_pattern_5m</code>
批量写入，全部 <code>ON CONFLICT DO UPDATE</code>。</li>
<li><strong>测试/验证</strong>：
<ul>
<li>用本地 mock（见 T3）生成 3
个窗口数据；重复跑同一窗口，行数不增加、统计覆盖一致。</li>
<li>观察 <code>etl_job_run</code> 状态转为 <code>success</code>；冲突率
&lt; 5%。</li>
</ul></li>
</ul>
<h3 id="t2-实现-sqlage_refresh.sql-的程序化执行">T2 — 实现
<code>sql/age_refresh.sql</code> 的程序化执行</h3>
<ul>
<li><strong>描述</strong>：在 <code>jobs/age_refresh.go</code>
读取并执行 <code>sql/age_refresh.sql</code>，或用参数化 SQL
内嵌实现。</li>
<li><strong>测试/验证</strong>：
<ul>
<li>先插入若干 <code>service_call_5m</code> 行，运行
<code>age-refresh</code>，检查 AGE 中 <code>CALLS</code> 边的
<code>last_seen/rps/err_rate/p95</code>。</li>
<li>连续两次执行，边数量不增长；属性按平均值更新。</li>
</ul></li>
</ul>
<h3 id="t3-pkgoo.stream-的-mock-与真实-s3api-适配">T3 —
<code>pkg/oo.Stream</code> 的 MOCK 与真实 S3/API 适配</h3>
<ul>
<li><strong>描述</strong>：</li>
</ul>
<pre><code>-  MOCK：生成固定分布的 logs/metrics/traces；支持 `--mock` 开关。
-  S3：按 `dataset/yyyy=.../hh=.../mm=...` 列表对象；API：按时间窗查询。</code></pre>
<ul>
<li><strong>测试/验证</strong>：</li>
</ul>
<pre><code>-  `--mock` 模式 1m 生成 5k 日志、500 指标点、1k span，端到端落库 &lt; 3s/窗口 
-  切换到 S3，验证窗口边界与对象命名正确。</code></pre>
<h3 id="t4-pkgagg-聚合正确性">T4 — <code>pkg/agg</code> 聚合正确性</h3>
<ul>
<li><strong>描述</strong>：实现指标 1m <code>avg/max/p95</code>、调用 5m
<code>rps/err/p50/p95</code>、日志指纹 5m 计数；接入
<code>patterns.MineTemplate</code>。</li>
<li><strong>测试/验证</strong>：
<ul>
<li>单测：给定样本序列，校验统计量；给定 span/log 对，校验 A→B
聚合。</li>
<li>性能：10 万条日志 + 2 万 span，内存峰值 &lt; 200MB。</li>
</ul></li>
</ul>
<h3 id="t5-pkgpatterns-指纹抽取drainre2">T5 — <code>pkg/patterns</code>
指纹抽取（Drain/RE2）</h3>
<ul>
<li><strong>描述</strong>：实现日志模板归一；输出
<code>fingerprint</code>、<code>severity</code>；可配置忽略字段。</li>
<li><strong>测试/验证</strong>：
<ul>
<li>对同模式不同变量的日志返回同一指纹；错误日志
<code>count_error</code> 正确累积。</li>
</ul></li>
</ul>
<h3 id="t6-pkgiac.discover-pkgansible.extractdeps">T6 —
<code>pkg/iac.Discover</code> +
<code>pkg/ansible.ExtractDeps</code></h3>
<ul>
<li><strong>描述</strong>：解析 TF/Pulumi/Cloud 与
inventory/group_vars/roles；映射 URN 与 <code>DEPENDS_ON</code>
边。</li>
<li><strong>测试/验证</strong>：
<ul>
<li>构造样例仓库（或 JSON 快照），跑任务后 <code>topo_edge_time</code>
新增开区间；删除节点后再次运行，旧边区间关闭。</li>
</ul></li>
</ul>
<p><strong>T7 —</strong>
<strong><code>pkg/pgw.UpsertTopoEdges</code></strong>
<strong>时态差分</strong></p>
<ul>
<li><strong>描述</strong>：实现 <code>E_now</code> 与当前开区间
<code>E_prev</code> 的集合差；新增插入开区间，消失关闭区间。</li>
<li><strong>测试/验证</strong>：
连续两轮相同输入不新增边；去掉一个边后再次运行，原边 <code>valid</code>
上界从无穷变为 <code>now()</code>。</li>
</ul>
<h3 id="t8-pkgevents-事件补数接口">T8 — <code>pkg/events</code>
事件补数接口</h3>
<ul>
<li><strong>描述</strong>：<code>POST /events/enqueue</code> 支持
<code>{job, tenant_id, from, to}</code> 回放窗口；写入
<code>etl_job_run</code> 为 <code>queued</code> 并入队。</li>
<li><strong>测试/验证</strong>：
<ul>
<li>对已成功窗口再次
enqueue，应能覆盖写不冲突；对未来窗口入队，不会被执行（受 Delay
上界限制）。</li>
</ul></li>
</ul>
<h3 id="t9-配置加载与初始回看">T9 — 配置加载与初始回看</h3>
<ul>
<li><strong>描述</strong>：<code>pkg/config</code> 已有；在
<code>scheduler</code> 注入 <code>Cfg</code> 并使用
<code>tenants.initial_lookback.oo-agg</code> 等。</li>
<li><strong>测试/验证</strong>：
<ul>
<li>删除 <code>etl_job_run</code> 记录后启动，观察从
<code>initial_lookback</code> 开始补跑。</li>
</ul></li>
</ul>
<h3 id="t10-观测指标与窗口滞后">T10 — 观测指标与窗口滞后</h3>
<ul>
<li><strong>描述</strong>：导出 Prometheus 指标（自定义
<code>/metrics</code> 或写回 OO）；记录窗口滞后。</li>
<li><strong>测试/验证</strong>：
<ul>
<li>在稳定负载下，<code>window_lag_seconds</code> &lt;
<code>Delay + Align</code>；失败重试曲线可见。</li>
</ul></li>
</ul>
<hr />
<h2 id="附典型验证-sql">附：典型验证 SQL</h2>
<ul>
<li><strong>聚合正确性（1m 指标）</strong></li>
</ul>
<div class="sourceCode" id="cb36"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>SELECT metric<span class="op">,</span> <span class="fu">count</span>(<span class="op">*</span>)<span class="op">,</span> <span class="fu">min</span>(bucket)<span class="op">,</span> <span class="fu">max</span>(bucket)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>FROM metric_1m</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>GROUP BY metric ORDER BY <span class="fu">count</span>(<span class="op">*</span>) DESC LIMIT <span class="dv">10</span><span class="op">;</span></span></code></pre></div>
<ul>
<li><strong>活跃调用图 vs 源一致性</strong></li>
</ul>
<div class="sourceCode" id="cb37"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>WITH active <span class="fu">AS</span> (</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  SELECT src_resource_id<span class="op">,</span> dst_resource_id</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  FROM service_call_5m</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  WHERE bucket <span class="op">&gt;=</span> <span class="fu">now</span>() <span class="op">-</span> interval <span class="st">&#39;10 minutes&#39;</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  GROUP BY <span class="dv">1</span><span class="op">,</span><span class="dv">2</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>SELECT <span class="fu">count</span>(<span class="op">*</span>) AS edges_in_source FROM active<span class="op">;</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="op">--</span> 再在 AGE 里查同样规模（CALLS 边数量），两者应近似一致（考虑租户过滤）</span></code></pre></div>
<ul>
<li><strong>拓扑时态闭环</strong></li>
</ul>
<div class="sourceCode" id="cb38"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="op">--</span> 当前有效边</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>SELECT <span class="fu">count</span>(<span class="op">*</span>) FROM topo_edge_time WHERE <span class="fu">upper_inf</span>(valid)<span class="op">;</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="op">--</span> 历史边（已关闭）</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>SELECT <span class="fu">count</span>(<span class="op">*</span>) FROM topo_edge_time WHERE NOT <span class="fu">upper_inf</span>(valid)<span class="op">;</span></span></code></pre></div>
<h1 id="typical-operations-scenarios">Typical Operations Scenarios</h1>
<p>Illustrates common operational situations that highlight the need for
effective monitoring across systems and services.</p>
<h2 id="发布与环境">1) 发布与环境</h2>
<ul>
<li><p><strong>灰度发布（Canary/Blue-Green）</strong> 触发：新版本可用 →
动作：按权重放量/自动回滚 → 校验：<code>service_call_5m</code> 的
p95/err_rate 门槛。</p></li>
<li><p><strong>特性开关（Feature Flag）渐进开启</strong> 触发：验收通过
→ 动作：按租户/地域打开 → 校验：关键路径转化率、错误率对比。</p></li>
<li><p><strong>依赖版本对齐（SDK/Sidecar/Agent）</strong>
触发：安全公告/CVE → 动作：批量滚更 →
校验：服务健康探针、崩溃率。</p></li>
<li><p><strong>配置漂移检测 &amp; 回收</strong> 触发：Git 与运行态差异 →
动作：生成 PR/自动修复 → 校验：IaC 合规策略通过。</p></li>
</ul>
<h2 id="可靠性与故障处置">2) 可靠性与故障处置</h2>
<ul>
<li><p><strong>自动限流/熔断/隔离</strong> 触发：err_rate↑ / p95↑ →
动作：在网关/服务级应用限流与熔断 → 校验：下游恢复、全链 p95
回落。</p></li>
<li><p><strong>异常回滚 &amp; 一键 Mitigation</strong> 触发：SLO 未命中
→ 动作：Plan DSL 的 <code>compensate</code> 执行 → 校验：回滚后 SLO
达标。</p></li>
<li><p><strong>降级策略编排（缓存兜底/只读模式）</strong>
触发：依赖服务不可用 → 动作：启用降级开关 →
校验：功能可用性≥阈值。</p></li>
<li><p><strong>日志噪声抑制 &amp; 指纹提纯</strong>
触发：<code>log_pattern_5m</code> 激增 → 动作：更新过滤/聚合规则 →
校验：噪声占比下降。</p></li>
</ul>
<h2 id="性能与容量优化">3) 性能与容量优化</h2>
<ul>
<li><p><strong>自动扩缩容（HPA/VPA/KEDA）</strong> 触发：RPS/CPU/GPU
利用率门槛 → 动作：扩容/缩容 → 校验：p95/队列长度回稳。</p></li>
<li><p><strong>热点定位（Top-K 端点/表/索引）</strong> 触发：看板阈值 →
动作：生成优化建议（索引/缓存/批量） → 校验：目标指标改善幅度。</p></li>
<li><p><strong>慢查询守护（PostgreSQL/OLAP）</strong>
触发：计划回退/代价飙升 → 动作：计划冻结、索引重建、ANALYZE →
校验：执行时间降低。</p></li>
<li><p><strong>CDN/缓存命中率调优</strong> 触发：MISS 高/回源高 →
动作：规则更新、预热 → 校验：命中率↑、回源↓。</p></li>
</ul>
<h2 id="数据与存储运维">4) 数据与存储运维</h2>
<ul>
<li><p><strong>分区/压缩/保留策略执行（Timescale/OO）</strong>
触发：窗口到期 → 动作：Timescale 压缩、OO 生命周期转冷 →
校验：存储曲线与查询命中率。</p></li>
<li><p><strong>备份与恢复演练（DB/对象存）</strong> 触发：季度演练 →
动作：还原到沙箱/校验一致性 → 校验：RTO/RPO 达标。</p></li>
<li><p><strong>Schema 变更护栏（DDL 门控）</strong> 触发：DDL PR →
动作：影子评估/回放 → 校验：读写延迟无回退。</p></li>
<li><p><strong>数据质量监控（ETL/流式）</strong>
触发：空值/重复/延迟异常 → 动作：回填/重跑 →
校验：质量指标恢复。</p></li>
</ul>
<h2 id="安全与合规">5) 安全与合规</h2>
<ul>
<li><p><strong>证书与密钥轮换（TLS/KMS/ACME）</strong> 触发：到期前 N 天
→ 动作：自动签发/分发/热加载 → 校验：握手成功率、无中断。</p></li>
<li><p><strong>CVE 修补与内核/容器镜像升级</strong> 触发：高危 CVE →
动作：分批滚更 → 校验：漏洞基线清零。</p></li>
<li><p><strong>访问评审与最小权限（RBAC/IAM）</strong> 触发：月度审计 →
动作：收敛权限/吊销闲置 → 校验：策略命中/拒绝率无异常。</p></li>
<li><p><strong>合规窗口/变更冻结</strong> 触发：活动/大促/监管窗口 →
动作：Gatekeeper 拒绝非白名单变更 → 校验：变更违规为 0。</p></li>
</ul>
<h2 id="网络与边缘">6) 网络与边缘</h2>
<ul>
<li><p><strong>入口网关/Ingress 规则变更与回滚</strong>
触发：路径/权重调整 → 动作：灰度发布 Nginx/Envoy →
校验：5xx/延迟曲线。</p></li>
<li><p><strong>跨区流量调度/健康探测</strong> 触发：区域异常 →
动作：权重切换/只读路由 → 校验：丢包/RTT 恢复。</p></li>
<li><p><strong>证书/ECH/TLS 指纹更新（Xray/Sing-box）</strong>
触发：策略更新 → 动作：节点批量更新 → 校验：连通率、误封率。</p></li>
<li><p><strong>Egress/WAF 策略</strong> 触发：异常出站/攻击面提示 →
动作：规则下发 → 校验：拦截率与误报率。</p></li>
</ul>
<h2 id="集群与平台生命周期k8s容器gpu">7)
集群与平台生命周期（K8s/容器/GPU）</h2>
<ul>
<li><p><strong>K8s 小版本升级 &amp; 节点滚更</strong> 触发：版本落后 →
动作：逐组 Cordon/Drain/升级 → 校验：工作负载无中断。</p></li>
<li><p><strong>GPU 驱动/Operator 更新（A10/L40/A100）</strong>
触发：新特性/修复 → 动作：分池灰度 → 校验：<code>nvidia-smi</code>/MIG
配置正确、作业吞吐。</p></li>
<li><p><strong>容器运行时/镜像仓库镜像切换</strong>
触发：镜像拉取慢/失效 → 动作：镜像加速/离线包 →
校验：拉取成功率、构建时长。</p></li>
<li><p><strong>Ingress 离线安装包验证（你已有目标）</strong>
触发：新离线包 → 动作：沙箱校验/多架构镜像加载 →
校验：可用性与兼容性。</p></li>
</ul>
<h2 id="aiml-与数据应用运维">8) AI/ML 与数据应用运维</h2>
<ul>
<li><p><strong>模型上线策略（Shadow→Canary）</strong>
触发：新模型评估通过 → 动作：影子对比/小流量灰度 →
校验：质量指标、成本/QPS。</p></li>
<li><p><strong>数据/概念漂移监测</strong> 触发：分布/性能漂移 →
动作：告警/Retrain 计划 → 校验：OOS 指标回升。</p></li>
<li><p><strong>RAG 质量守护（向量库更新/召回评测）</strong>
触发：知识变更 → 动作：重嵌入/基准集评测 → 校验：Top-k
命中率/答案自信度。</p></li>
<li><p><strong>推理路由与预算控制（多端点）</strong> 触发：延迟/价格波动
→ 动作：路由切换/配额限流 → 校验：SLO 与成本曲线。</p></li>
</ul>
<h2 id="可观测性与告警工程">9) 可观测性与告警工程</h2>
<ul>
<li><p><strong>SLO 定义与回归检测</strong> 触发：SLO 变更 →
动作：历史重放评估 → 校验：误报/漏报下降。</p></li>
<li><p><strong>告警噪声治理</strong> 触发：高噪声规则 →
动作：聚合/抑制窗口优化 → 校验：On-call 负担降低。</p></li>
<li><p><strong>追踪抽样自适应</strong> 触发：流量/成本压力 →
动作：按错误/慢请求倾斜采样 → 校验：诊断覆盖率保持。</p></li>
</ul>
<h2 id="灾备与演练">10) 灾备与演练</h2>
<ul>
<li><p><strong>多区域演练（GameDay/Chaos）</strong> 触发：季度/半年度 →
动作：注入故障/演练切流 → 校验：RTO/RPO/SLO 达标。</p></li>
<li><p><strong>对象存储/消息系统灾备切换</strong> 触发：主域不可用 →
动作：桶/Topic/镜像切换 → 校验：数据一致性与延迟。</p></li>
</ul>
<h2 id="finops成本与资源">11) FinOps（成本与资源）</h2>
<ul>
<li><p><strong>实例规格与副本数 Rightsizing</strong> 触发：长期低/高利用
→ 动作：规格/副本调整 → 校验：性能不降、成本下降。</p></li>
<li><p><strong>Spot/预留/竞价策略编排</strong> 触发：价格/回收风险 →
动作：池化/回填 → 校验：业务无损、成本可控。</p></li>
<li><p><strong>存储分层（热/温/冷）与清理</strong> 触发：访问频次变化 →
动作：生命周期迁移/清理 → 校验：成本下降、命中率合理。</p></li>
</ul>
<h2 id="自助与治理">12) 自助与治理</h2>
<ul>
<li><p><strong>服务目录 + 变更申请自助</strong> 触发：团队提变更 →
动作：模板化 Plan、Gatekeeper 审批 → 校验：周期缩短、违规为 0。</p></li>
<li><p><strong>合规审计与证据归档</strong> 触发：审计周期 → 动作：导出
<code>event_envelope + evidence_link</code> →
校验：稽核一次通过。</p></li>
</ul>
<h1 id="edge-collection-vs-gateway">Edge Collection vs Gateway</h1>
<p>Discusses trade-offs between collecting observability data at the
edge and routing through centralized gateways.</p>
<h1 id="otel-gateway-design-and-considerations">OTel Gateway Design and
Considerations</h1>
<p>Explores architectural patterns and design thoughts for building an
OpenTelemetry-based gateway.</p>
<h1 id="data-ingestion-with-multi-level-persistence-and-replay">Data
Ingestion with Multi-Level Persistence and Replay</h1>
<p>Details strategies for persisting collected data at multiple stages
and replaying it for analysis or recovery.</p>
<h1 id="full-stack-observability-database-design">Full-Stack
Observability Database Design</h1>
<p>Outlines principles for structuring databases that support metric,
log, trace, event, and profile storage in one system.</p>
<h1 id="full-stack-observability-database-etl-design">Full-Stack
Observability Database ETL Design</h1>
<p>Describes extract-transform-load workflows for moving observability
data between hot and cold storage layers.</p>
<h1 id="monitoring-system-multi-region-and-disaster-recovery">Monitoring
System Multi-Region and Disaster Recovery</h1>
<p>Covers approaches to deploying observability stacks across regions
with failover and disaster recovery in mind.</p>
<h1
id="from-sshscp-to-ai-driven-ops-agent-pre-deployment-considerations">From
SSH/SCP to AI-Driven OPS Agent: Pre-Deployment Considerations</h1>
<p>Reviews the challenges of traditional remote management and outlines
factors to evaluate before adopting AI-powered operations agents.</p>
<h1 id="from-sshscp-to-ai-driven-ops-agent-capability-checklist">From
SSH/SCP to AI-Driven OPS Agent: Capability Checklist</h1>
<p>Enumerates the functional requirements and competencies expected from
an AI-assisted operations agent.</p>
<h1
id="postgresql-extension-driven-complex-analysis-vector-graph-trend">PostgreSQL
Extension-Driven Complex Analysis (Vector, Graph, Trend)</h1>
<p>Highlights how PostgreSQL extensions enable advanced analysis such as
vector similarity search, graph traversal, and trend detection for
operations data.</p>
<h1 id="ai-ops-agent-mvp-architecture">AI-OPS Agent MVP
Architecture</h1>
<p>Proposes a minimal viable architecture for an AI-powered operations
agent integrating data collection, analysis, and automated actions.</p>
<h1 id="如何设计-ai-驱动的-ops-agent漫谈状态机">如何设计 AI 驱动的 OPS
Agent：漫谈状态机</h1>
<blockquote>
<p>关键词：Walking
Skeleton／状态机（FSM）／Outbox／Idempotency／事件驱动／LLM 契约化</p>
</blockquote>
<p>本文落地一条“最短闭环”（人工触发 → 计划 → 审批 → 执行 → 验证 →
归档），强调：<strong>确定性的状态机做“合法性与原子落库”，不确定性的 LLM
做“生成、检索、归纳”</strong>，两者以“可验证的契约”交汇。</p>
<hr />
<h2 id="结论先行tldr">0. 结论先行（TL;DR）</h2>
<ul>
<li><strong>状态唯一事实源（SSOT）在
Orchestrator</strong>：唯一改状态入口
<code>PATCH /case/{id}/transition</code>；事务内同时写
<code>ops_case</code>、<code>case_timeline</code>、<code>outbox</code>；所有副作用“先出盒，后投递”。</li>
<li><strong>AI 的边界</strong>：LLM 负责 Planner/Analyst/Librarian
的“生成与检索”；Gatekeeper 的策略判定与 Orchestrator
的状态迁移一律<strong>不可由 LLM
直接驱动</strong>，而是通过<strong>结构化产物 +
守卫校验</strong>进入确定世界。</li>
<li><strong>Walking Skeleton 顺序</strong>：Orchestrator → Planner →
Gatekeeper → Executor → Verifier（打通闭环）；其后再补
Analyst、Sensor、Librarian（从命令式走向信号驱动与知识化）。</li>
</ul>
<hr />
<h2 id="为什么状态机是-ai-ops-的地基">1. 为什么状态机是 AI OPS
的地基</h2>
<p>LLM
擅长“生成与归纳”，但<strong>不提供事务性与幂等保证</strong>。生产级 OPS
需要： 1) <strong>可证明的合法迁移</strong>（纯函数 FSM） 2)
<strong>原子副作用</strong>（状态 + 时间线 + 出盒） 3)
<strong>至少一次投递 + 消费幂等</strong>（Outbox/Inbox Pattern）</p>
<blockquote>
<p>原则：<strong>确定性包围不确定性</strong>。所有非确定性的 AI
产物都转为<strong>结构化契约</strong>（JSON/YAML + Schema
校验）后，才允许进入状态机的下一跳。</p>
</blockquote>
<hr />
<h2 id="walking-skeleton从零到可跑">2. Walking
Skeleton（从零到可跑）</h2>
<p><strong>目标</strong>：先打通一条最短闭环，可演示、可观测、可回滚。</p>
<p><strong>实现顺序</strong>： 1.
<strong>Orchestrator（必须先做）</strong>：纯函数 FSM +
原子事务（状态/时间线/出盒）+ 幂等/OCC。 2.
<strong>Planner（最小可用）</strong>：模板计划生成，产出
<code>plan_proposed</code> 与 <code>evt.plan.proposed.v1</code>。 3.
<strong>Gatekeeper（自动审批）</strong>：本地策略阈值，产出
<code>plan_approved</code> 与 <code>evt.plan.approved.v1</code>。 4.
<strong>Executor（Step Runner）</strong>：先做 <code>echo/script</code>
与 <code>k8s rollout</code> 两个适配器。 5. <strong>Verifier（SLO
校验）</strong>：基于 <code>metric_1m</code> 的阈值判定。 6~8.
<strong>Analyst / Sensor /
Librarian</strong>：把入口从“人工”扩展到“信号驱动”，把 Planner
从模板升级为基于证据的拟合。</p>
<hr />
<h2 id="体系结构与事件流">3. 体系结构与事件流</h2>
<pre class="mermaid"><code>flowchart LR
  subgraph UI/API
    H[Human/UI]
  end

  subgraph Core[Core Services]
    O[Orchestrator\nFSM+Outbox+Timeline]
    P[Planner\n(LLM/模板→ plan_proposed)]
    G[Gatekeeper\n(策略/OA判定)]
    E[Executor\n(Adapters: script/k8s/...)]
    V[Verifier\n(SLO阈值)]
    A[Analyst\n(规则/统计→ findings)]
    S[Sensor\n(oo_locator / ingest)]
    L[Librian\n(pgvector RAG)]
  end

  EV[(Event Bus\nNATS/Redpanda)]
  DB[(PostgreSQL/Timescale)]
  OO[(OpenObserve/Logs)]

  H -- REST --&gt; O
  O -- outbox/cmd.* --&gt; EV
  EV -- evt.* --&gt; O
  P &amp; G &amp; E &amp; V &amp; A &amp; S &amp; L -- evt./cmd. &lt;--&gt; EV
  O -- R/W --&gt; DB
  E -- logs/refs --&gt; OO</code></pre>
<p><strong>接口与事件最小集</strong> - REST： -
<code>POST /case/create</code>，<code>GET /case/{id}</code>，<code>GET /case/{id}/timeline</code>
-
<code>PATCH /case/{id}/transition</code>（<strong>唯一改状态入口</strong>；需
<code>Idempotency-Key</code> + 建议 <code>If-Match</code>） -
<code>POST /plan/generate</code>，<code>POST /gate/eval</code>，<code>POST /adapter/exec</code>，<code>POST /verify/run</code>
- 事件： - <code>evt.case.transition.v1</code>（任何迁移事实） -
<code>evt.plan.proposed.v1</code>，<code>evt.plan.approved.v1</code> -
<code>evt.exec.step_result.v1</code>，<code>evt.exec.done|failed.v1</code>
-
<code>evt.verify.pass|failed.v1</code>，<code>evt.analysis.findings.v1</code>
-
<code>cmd.plan.generate / cmd.gate.eval / cmd.exec.run / cmd.verify.run</code></p>
<hr />
<h2 id="状态机fsm与守卫">4. 状态机（FSM）与守卫</h2>
<pre class="mermaid"><code>stateDiagram-v2
  [*] --&gt; NEW
  NEW --&gt; ANALYZING: start_analysis
  ANALYZING --&gt; PLANNING: analysis_done
  PLANNING --&gt; WAIT_GATE: plan_ready (guard: complete plan)
  WAIT_GATE --&gt; EXECUTING: gate_approved
  WAIT_GATE --&gt; PARKED: gate_rejected
  EXECUTING --&gt; VERIFYING: exec_done
  EXECUTING --&gt; PARKED: exec_failed
  VERIFYING --&gt; CLOSED: verify_pass
  VERIFYING --&gt; PARKED: verify_failed
  PARKED --&gt; PLANNING: resume / fix</code></pre>
<p><strong>守卫示例（plan 完整性）</strong> - <code>steps</code> 至少 1
个；每个 step 定义
<code>action</code>、<code>timeout</code>、<code>retry</code>； -
<code>rollback</code> 与 <code>verify</code> 字段必须存在； -
计划大小、危险操作需标识并由 Gatekeeper 评分/审批。</p>
<blockquote>
<p>任何守卫失败都不改变状态，仅记录时间线并返回 409/422。</p>
</blockquote>
<hr />
<h2 id="orchestrator-的原子三件套">5. Orchestrator 的“原子三件套”</h2>
<p><strong>单事务保证</strong>： 1) 更新
<code>ops_case.version, status</code> 2) 追加 <code>case_timeline</code>
3) 写入 <code>outbox</code>（cmd.* 或 evt.* 载荷）</p>
<p><strong>幂等与并发</strong>： -
<code>Idempotency-Key</code>：命中即返回首次结果，不重复写时间线/出盒。
- <code>If-Match</code>/<code>expected_version</code>：不匹配 →
<code>409/412</code>。</p>
<p><strong>伪代码（Go/Pseudocode）</strong>：</p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> Transition<span class="op">(</span>ctx<span class="op">,</span> caseID<span class="op">,</span> event<span class="op">,</span> meta<span class="op">)</span> <span class="op">(</span>Case<span class="op">,</span> <span class="dt">error</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> WithTx<span class="op">(</span>ctx<span class="op">,</span> <span class="kw">func</span><span class="op">(</span>tx Tx<span class="op">)</span> <span class="op">(</span>Case<span class="op">,</span> <span class="dt">error</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    c <span class="op">:=</span> repo<span class="op">.</span>GetForUpdate<span class="op">(</span>tx<span class="op">,</span> caseID<span class="op">)</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    allowed<span class="op">,</span> next <span class="op">:=</span> workflow<span class="op">.</span>Decide<span class="op">(</span>c<span class="op">.</span>Status<span class="op">,</span> event<span class="op">)</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">!</span>allowed <span class="op">{</span> <span class="cf">return</span> <span class="dt">error</span><span class="op">(</span><span class="dv">409</span><span class="op">)</span> <span class="op">}</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// guards (schema/plan completeness/risk window etc.)</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> err <span class="op">:=</span> Guards<span class="op">.</span>Pass<span class="op">(</span>tx<span class="op">,</span> c<span class="op">,</span> event<span class="op">,</span> meta<span class="op">);</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span> <span class="cf">return</span> <span class="dt">error</span><span class="op">(</span><span class="dv">422</span><span class="op">)</span> <span class="op">}</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    c<span class="op">.</span>Status<span class="op">,</span> c<span class="op">.</span>Version <span class="op">=</span> next<span class="op">,</span> c<span class="op">.</span>Version<span class="op">+</span><span class="dv">1</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    repo<span class="op">.</span>Update<span class="op">(</span>tx<span class="op">,</span> c<span class="op">)</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    timeline<span class="op">.</span>Append<span class="op">(</span>tx<span class="op">,</span> c<span class="op">.</span>ID<span class="op">,</span> event<span class="op">,</span> meta<span class="op">)</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    outbox<span class="op">.</span>Append<span class="op">(</span>tx<span class="op">,</span> BuildMessages<span class="op">(</span>c<span class="op">,</span> event<span class="op">,</span> meta<span class="op">))</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> c<span class="op">,</span> <span class="ot">nil</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">})</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="llm-做擅长的事契约与位置">6. LLM “做擅长的事”：契约与位置</h2>
<blockquote>
<p><strong>口号</strong>：LLM
只输出“结构化、可验证、可回放”的产物；状态改变永远经 Orchestrator。</p>
</blockquote>
<h3 id="planner-llm计划生成">6.1 Planner × LLM（计划生成）</h3>
<ul>
<li><strong>输入</strong>：问题摘要、上下文证据（<code>evidence_link</code>）、历史相似案
<code>kb_chunk</code>、环境约束。</li>
<li><strong>输出契约（JSON Schema）</strong>：</li>
</ul>
<div class="sourceCode" id="cb42"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;$schema&quot;</span><span class="fu">:</span> <span class="st">&quot;https://json-schema.org/draft/2020-12/schema&quot;</span><span class="fu">,</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;ChangePlan&quot;</span><span class="fu">,</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;object&quot;</span><span class="fu">,</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;required&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;title&quot;</span><span class="ot">,</span><span class="st">&quot;steps&quot;</span><span class="ot">,</span><span class="st">&quot;rollback&quot;</span><span class="ot">,</span><span class="st">&quot;verify&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;properties&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">&quot;type&quot;</span><span class="fu">:</span><span class="st">&quot;string&quot;</span><span class="fu">},</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;risk_score&quot;</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">&quot;type&quot;</span><span class="fu">:</span><span class="st">&quot;number&quot;</span><span class="fu">,</span><span class="dt">&quot;minimum&quot;</span><span class="fu">:</span><span class="dv">0</span><span class="fu">,</span><span class="dt">&quot;maximum&quot;</span><span class="fu">:</span><span class="dv">1</span><span class="fu">},</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;steps&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;type&quot;</span><span class="fu">:</span><span class="st">&quot;array&quot;</span><span class="fu">,</span><span class="dt">&quot;minItems&quot;</span><span class="fu">:</span><span class="dv">1</span><span class="fu">,</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;items&quot;</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">&quot;type&quot;</span><span class="fu">:</span><span class="st">&quot;object&quot;</span><span class="fu">,</span><span class="dt">&quot;required&quot;</span><span class="fu">:</span><span class="ot">[</span><span class="st">&quot;action&quot;</span><span class="ot">,</span><span class="st">&quot;timeout_s&quot;</span><span class="ot">,</span><span class="st">&quot;retry&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;properties&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;action&quot;</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">&quot;enum&quot;</span><span class="fu">:</span><span class="ot">[</span><span class="st">&quot;k8s.rollout&quot;</span><span class="ot">,</span><span class="st">&quot;script.exec&quot;</span><span class="ot">,</span><span class="st">&quot;gateway.flip&quot;</span><span class="ot">,</span><span class="st">&quot;noop&quot;</span><span class="ot">]</span><span class="fu">},</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;params&quot;</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">&quot;type&quot;</span><span class="fu">:</span><span class="st">&quot;object&quot;</span><span class="fu">},</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;timeout_s&quot;</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">&quot;type&quot;</span><span class="fu">:</span><span class="st">&quot;integer&quot;</span><span class="fu">,</span><span class="dt">&quot;minimum&quot;</span><span class="fu">:</span><span class="dv">10</span><span class="fu">},</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;retry&quot;</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">&quot;type&quot;</span><span class="fu">:</span><span class="st">&quot;integer&quot;</span><span class="fu">,</span><span class="dt">&quot;minimum&quot;</span><span class="fu">:</span><span class="dv">0</span><span class="fu">,</span><span class="dt">&quot;maximum&quot;</span><span class="fu">:</span><span class="dv">3</span><span class="fu">}</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;rollback&quot;</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">&quot;type&quot;</span><span class="fu">:</span><span class="st">&quot;object&quot;</span><span class="fu">},</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;verify&quot;</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">&quot;type&quot;</span><span class="fu">:</span><span class="st">&quot;object&quot;</span><span class="fu">}</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<ul>
<li><strong>流程</strong>：<code>/plan/generate</code> → 校验 Schema →
入库 <code>plan_proposed</code> → 发
<code>evt.plan.proposed.v1</code>。</li>
</ul>
<p><strong>Prompt 片段（示意）</strong>：</p>
<pre><code>System: 你是资深 SRE。产出必须是符合 JSON Schema 的 ChangePlan。不要输出自然语言解释。
User: {问题摘要/证据/限制}
Assistant: {ChangePlan JSON}</code></pre>
<h3 id="analyst-llm证据摘要">6.2 Analyst × LLM（证据摘要）</h3>
<ul>
<li>LLM
用于<strong>长日志/多指标的摘要</strong>，把粗粒度“异常信号”转换成<strong>可检索的要点</strong>（写入
<code>event_envelope</code>）。</li>
<li>开 Case 的动作依然通过 Orchestrator（NEW→ANALYZING）。</li>
</ul>
<h3 id="librarian-llmrag">6.3 Librarian × LLM（RAG）</h3>
<ul>
<li><code>kb_doc/kb_chunk</code>（pgvector）做相似案例/Runbook 检索；LLM
用于<strong>拟合与注释</strong>，生成可执行/可审阅的 Plan。</li>
</ul>
<h3 id="gatekeeperverifier-的-ai-用法限定">6.4 Gatekeeper/Verifier 的 AI
用法（限定）</h3>
<ul>
<li><strong>Gatekeeper</strong>：策略由<strong>确定性规则</strong>实现，可让
LLM 提供“风险解释文本”，但<strong>不直接决定通过与否</strong>。</li>
<li><strong>Verifier</strong>：阈值判断（p95/err_rate）是确定性的；LLM
可做<strong>事后报告</strong>摘要。</li>
</ul>
<hr />
<h2 id="数据模型关键表最小集">7. 数据模型（关键表，最小集）</h2>
<div class="sourceCode" id="cb44"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- 1) 事实源</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> ops_case (</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> UUID <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  tenant TEXT, title TEXT,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  status TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  version <span class="dt">INT</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  created_at TIMESTAMPTZ <span class="kw">DEFAULT</span> now(),</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  updated_at TIMESTAMPTZ <span class="kw">DEFAULT</span> now()</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> case_timeline (</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> BIGSERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  case_id UUID <span class="kw">REFERENCES</span> ops_case(<span class="kw">id</span>),</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>  event TEXT, actor TEXT, reason TEXT,</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>  correlation_id TEXT, meta JSONB,</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>  created_at TIMESTAMPTZ <span class="kw">DEFAULT</span> now()</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> outbox (</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> BIGSERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>  topic TEXT, <span class="kw">key</span> TEXT, payload JSONB,</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>  created_at TIMESTAMPTZ <span class="kw">DEFAULT</span> now(),</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>  published_at TIMESTAMPTZ</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> idempotency (</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">key</span> TEXT <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>  response JSONB,</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>  created_at TIMESTAMPTZ <span class="kw">DEFAULT</span> now()</span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a><span class="co">-- 2) Planner/Exec/Verify（示意）</span></span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> plan_proposed (</span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> UUID <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>  case_id UUID <span class="kw">REFERENCES</span> ops_case(<span class="kw">id</span>),</span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>  <span class="kw">plan</span> JSONB <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>  created_at TIMESTAMPTZ <span class="kw">DEFAULT</span> now()</span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> plan_approved (</span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> UUID <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a>  case_id UUID <span class="kw">REFERENCES</span> ops_case(<span class="kw">id</span>),</span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a>  decision JSONB,</span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true" tabindex="-1"></a>  created_at TIMESTAMPTZ <span class="kw">DEFAULT</span> now()</span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<hr />
<h2 id="可观测性先打指标再写业务">8. 可观测性（先打指标，再写业务）</h2>
<ul>
<li><strong>Prom 指标</strong>：
<ul>
<li><code>case_transition_total{from,to,event}</code></li>
<li><code>conflict_total{reason}</code>（409/412/422）</li>
<li><code>idempotent_replay_total</code></li>
<li><code>outbox_publish_total{topic,status}</code> /
<code>inbox_dedup_total</code></li>
<li><code>adapter_step_latency_seconds</code>、<code>verify_latency_seconds</code></li>
</ul></li>
<li><strong>Tracing</strong>：每次迁移、每个 step、每次查询都带
<code>trace_id</code> 并写入 <code>case_timeline.meta</code>。</li>
<li><strong>日志引用</strong>：<code>exec_step.*_ref</code> 指向 OO/Loki
的 <code>oo_locator</code>。</li>
</ul>
<hr />
<h2 id="第一条端到端演示curl">9. 第一条端到端演示（cURL）</h2>
<div class="sourceCode" id="cb45"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) 创建 Case</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="va">CASE</span><span class="op">=</span><span class="va">$(</span><span class="ex">curl</span> <span class="at">-sX</span> POST /case/create <span class="at">-d</span> <span class="st">&#39;{&quot;title&quot;:&quot;p95 spike&quot;,&quot;tenant&quot;:&quot;t-001&quot;}&#39;</span><span class="kw">|</span><span class="ex">jq</span> <span class="at">-r</span> .data.case_id<span class="va">)</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) 开始分析</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> PATCH /case/<span class="va">$CASE</span>/transition <span class="dt">\</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">-H</span> <span class="st">&#39;Idempotency-Key:a1&#39;</span> <span class="dt">\</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">-d</span> <span class="st">&#39;{&quot;event&quot;:&quot;start_analysis&quot;,&quot;actor&quot;:&quot;analyst@svc&quot;}&#39;</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) 生成计划（模板/LLM）</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST /plan/generate <span class="at">-d</span> <span class="st">&#39;{&quot;case_id&quot;:&quot;&#39;</span><span class="va">$CASE</span><span class="st">&#39;&quot;,&quot;template&quot;:&quot;k8s.rollout.canary&quot;}&#39;</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Planner 发 evt.plan.proposed.v1 → Orchestrator 判定 plan_ready → WAIT_GATE</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) 自动审批</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST /gate/eval <span class="at">-d</span> <span class="st">&#39;{&quot;case_id&quot;:&quot;&#39;</span><span class="va">$CASE</span><span class="st">&#39;&quot;}&#39;</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Gatekeeper 发 evt.plan.approved.v1 → EXECUTING</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) 执行适配器（示例：script）</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST /adapter/exec <span class="at">-d</span> <span class="st">&#39;{&quot;case_id&quot;:&quot;&#39;</span><span class="va">$CASE</span><span class="st">&#39;&quot;,&quot;adapter&quot;:&quot;script&quot;,&quot;script&quot;:&quot;echo ok&quot;}&#39;</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Executor 发 evt.exec.done.v1 → VERIFYING</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 6) 验证通过 → CLOSED</span></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST /verify/run <span class="at">-d</span> <span class="st">&#39;{&quot;case_id&quot;:&quot;&#39;</span><span class="va">$CASE</span><span class="st">&#39;&quot;}&#39;</span></span></code></pre></div>
<hr />
<h2 id="目录结构建议">10. 目录结构建议</h2>
<pre><code>.
├─ api/                # Gin/Fiber + OpenAPI + 中间件
├─ workflow/           # 纯函数 FSM
├─ plans/              # 纯函数计划生成（模板 + LLM 契约）
├─ gatekeeper/         # 策略引擎（本地规则/OPA/Cedar）
├─ executor/
│  ├─ adapters/        # k8s/script/gateway...
│  └─ runner/          # step 执行/超时/重试
├─ verifier/
├─ analyst/
├─ sensor/
├─ librarian/
├─ internal/pubsub/    # NATS/Redpanda（至少一次 + 去重）
├─ ports/              # Repo/Outbox/Timeline/Idempotency 接口
├─ services/           # Orchestrator 等聚合服务
└─ migrations/         # DDL</code></pre>
<hr />
<h2 id="dod-清单可直接转-issue">11. DoD 清单（可直接转 Issue）</h2>
<ul>
<li><strong>Orchestrator</strong>：三类集成测试全绿（非法迁移409 /
幂等重放 / 失败落PARKED）； 指标
<code>case_transition_total / conflict_total / idempotent_replay_total</code>；Outbox
消费无重复副作用。</li>
<li><strong>Planner</strong>：<code>plan_proposed</code> 入库；DSL 过
schema；守卫挡下不完整计划。</li>
<li><strong>Gatekeeper</strong>：策略可配置（文件/内存）；自动审批延时
&lt;1s；拒绝落 PARKED 并记原因。</li>
<li><strong>Executor</strong>：≥2 适配器；step 超时/重试；失败回写
<code>exec_failed</code> 并落 PARKED。</li>
<li><strong>Verifier</strong>：SLO
查询正确；阈值/窗口可配；误报率可控。</li>
<li><strong>Analyst</strong>：能从 <code>metric_1m</code>
发现简单异常并自动开 Case。</li>
<li><strong>Sensor</strong>：<code>oo_locator</code> 可被
<code>evidence_link</code> 回链；写入 p99 &lt; 2s。</li>
<li><strong>Librarian</strong>：topK
语义检索可用于计划注释/回滚提示。</li>
</ul>
<hr />
<h2 id="风险与避坑">12. 风险与避坑</h2>
<ol type="1">
<li>事务一致性：禁止在 FSM 回调内做外部
IO；<strong>先落地再发事件</strong>。</li>
<li>幂等：所有写接口都要 <code>Idempotency-Key</code>；消费者对
<code>message_id</code> 去重。</li>
<li>并发：<code>SELECT ... FOR UPDATE</code> + 版本控制；冲突返回
409/412。</li>
<li>守卫松紧：先宽后紧，避免卡死；策略统一在 Gatekeeper。</li>
<li>可观测：<strong>先打指标</strong>，再写业务；没有指标就无法排障。</li>
</ol>
<hr />
<h2 id="路线图建议">13. 路线图（建议）</h2>
<ul>
<li><strong>Phase 0</strong>：FSM + Outbox + 2 个适配器 + 阈值
Verifier（闭环演示）。</li>
<li><strong>Phase 1</strong>：Analyst（规则）＋ Librarian（RAG）→
Planner/Runbook 拟合。</li>
<li><strong>Phase 2</strong>：Gatekeeper 外挂 OPA/Cedar；Executor
扩充生产适配器；Verifier 引入 SLO 画像。</li>
</ul>
<hr />
<h3 id="一句话">一句话</h3>
<blockquote>
<p><strong>Orchestrator
只做两件事</strong>：判定合法迁移（纯函数）＋一次事务内记录（状态/时间线/出盒）。其余模块要么被它的命令驱动，要么把“事实事件”交还它，由它来改变世界。LLM
负责提出“更好的方案”，而不是亲自“按下回车”。</p>
</blockquote>
