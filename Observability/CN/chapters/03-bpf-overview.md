# eBPF 技术综述

## 概述
- eBPF 是 Linux 内核的通用编程框架，允许在运行时安全地将自定义程序挂载到内核事件上。
- 通过 XDP、TC、kprobes、tracepoints、LSM 等钩子点，eBPF 能对网络栈、系统调用、内存和安全事件进行细粒度观测。
- eBPF 支持从 L2 到 L7 的网络协议解析，并可捕获文件、网络、进程等系统调用行为。
- 结合 Agent 模式，eBPF 可同时采集流量、日志、性能指标与元数据，实现云原生环境的全栈可观测。

## 对比
### CBPF 与 eBPF
| 特性           | CBPF                 | eBPF                              |
|----------------|----------------------|-----------------------------------|
| 用途           | 数据包过滤           | 网络过滤、性能分析、安全监控等    |
| 指令集         | 简单，功能有限       | 功能强大，支持复杂逻辑             |
| 运行环境       | 网络数据包           | 多种挂载点（网络、系统调用等）     |
| 验证器         | 无                   | 严格的安全验证器                  |
| 扩展性         | 差                   | 强，支持用户态交互和多种映射类型   |
| 性能           | 高                   | 接近 CBPF，有优化机制              |

### 传统模式与基于 Agent 的采集模式
| 维度         | 传统模式                               | 基于 Agent 的采集模式                         |
|--------------|----------------------------------------|-----------------------------------------------|
| 流量采集方式 | 流量镜像或旁路设备                     | eBPF/XDP 内核级采集                           |
| 部署复杂度   | 需要交换机配置或旁路设备               | 只需在主机安装 Agent                          |
| 协议解析能力 | 通常仅支持 L3/L4                       | 支持全面的 L7 协议解析                        |
| 数据粒度     | 粗粒度流量统计                         | 细粒度流日志与性能指标                        |
| 元数据关联   | 需手动关联容器、进程信息               | 自动关联主机、容器与 Kubernetes 元数据        |
| 性能开销     | 镜像可能带来带宽占用                   | 内核级采集开销极低                            |
| 动态环境支持 | 对 Kubernetes 等动态环境支持较弱       | 原生适配动态环境，扩展性强                    |
| 安全性       | 镜像存在数据泄露风险                   | 数据在内核空间处理，安全性更高                |

## 场景
- **网络过滤与优化**：利用 XDP、TC 对 L2-L7 流量执行负载均衡、DDoS 防护和流量整形。
- **性能分析与故障排查**：通过 kprobes、tracepoints 捕获系统调用与内核事件，定位 CPU、I/O 和内存瓶颈。
- **安全监控**：结合 LSM、Seccomp 等钩子与系统调用追踪，检测异常行为并实施自定义安全策略。
- **全栈数据采集**：Agent 模式将流量、元数据和应用指标关联，构建服务拓扑并支持 APM 与安全分析。
